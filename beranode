#!/usr/bin/env bash
#
# beranode - CLI for managing Berachain nodes
#
# VERSION: v0.6.0
#
# This file is auto-generated by build.sh from modular sources in src/
# Do not edit this file directly. Instead, edit the source files and rebuild.
#
# Usage: beranode <command> [options]
#
# Generated: [BUILD_TIMESTAMP]
#

set -e


# =============================================================================
# constants
# Source: lib/constants.sh
# =============================================================================

BERANODE_VERSION="0.6.0"  # Managed by scripts/bump-version.sh - do not edit manually

# =============================================================================
# Get platform
# =============================================================================
# Detect if running on Windows (PowerShell), Linux, or macOS
readonly PLATFORM="$(uname)"
readonly ARCH="$(uname -m)"

if [[ "$PLATFORM" == "Darwin" ]]; then
	readonly IS_MACOS=true
	readonly IS_LINUX=false
	readonly IS_WINDOWS=false
	readonly IS_LINUX_ARM=false
elif [[ "$PLATFORM" == "Linux" ]]; then
	readonly IS_MACOS=false
	readonly IS_LINUX=true
	readonly IS_WINDOWS=false
	# Detect if CPU architecture is ARM (e.g., "armv7l", "aarch64", etc.)
	if [[ "$ARCH" == arm* ]] || [[ "$ARCH" == aarch64* ]]; then
		readonly IS_LINUX_ARM=true
	else
		readonly IS_LINUX_ARM=false
	fi
elif [[ "$PLATFORM" == MINGW* ]] || [[ "$PLATFORM" == CYGWIN* ]] || [[ "$PLATFORM" == MSYS* ]]; then
	readonly IS_MACOS=false
	readonly IS_LINUX=false
	readonly IS_WINDOWS=true
	readonly IS_LINUX_ARM=false
else
	readonly IS_MACOS=false
	readonly IS_LINUX=false
	readonly IS_WINDOWS=false
	readonly IS_LINUX_ARM=false
	echo "error: unsupported platform: '${PLATFORM}'" >&2
	exit 1
fi

# Temporary
if [ "$IS_WINDOWS" == true ]; then
	local_red='\033[0;31m'
	local_reset='\033[0m'
	echo -e "${local_red}[ERROR] This script currently only supports macOS and Linux. Windows support coming soon.${local_reset}" >&2
	exit 1
fi

if [[ $(uname) == "Darwin" ]]; then
	readonly SED_OPT=(-i '')
else
	readonly SED_OPT=(-i)
fi

# =============================================================================
# Network Chain IDs and Names
# =============================================================================

# Network chain IDs (enforced)
readonly CHAIN_ID_DEVNET=80087
readonly CHAIN_NAME_DEVNET="devnet"
readonly CHAIN_ID_TESTNET=80069
readonly CHAIN_NAME_TESTNET="bepolia"
readonly CHAIN_ID_MAINNET=80094
readonly CHAIN_NAME_MAINNET="mainnet"
readonly GENESIS_DEPOSIT_AMOUNT=250000000000000

# =============================================================================
# Default Ports
# =============================================================================

readonly DEFAULT_CL_ETHRPC_PORT=26657
readonly DEFAULT_CL_ETHP2P_PORT=26656
readonly DEFAULT_CL_ETHPROXY_PORT=26658
readonly DEFAULT_EL_ETHRPC_PORT=8545
readonly DEFAULT_EL_WS_PORT=8546
readonly DEFAULT_EL_AUTHRPC_PORT=8551
readonly DEFAULT_DEFAULT_EL_ETH_PORT=30303
readonly DEFAULT_EL_PROMETHEUS_PORT=9101
readonly DEFAULT_CL_PROMETHEUS_PORT=26660
readonly DEFAULT_PORT_INCREMENT=100
readonly DEFAULT_WALLET_BALANCE=1000000000000000000000000000
readonly DEFAULT_BEACON_NODE_API_PORT=3500
readonly DEFAULT_GRPC_LADDR_PORT=9090
readonly DEFAULT_GRPC_PRIVILEGED_LADDR_PORT=9091

# =============================================================================
# Binary Names
# =============================================================================

readonly BIN_BEACONKIT="beacond"
readonly BIN_BERARETH="bera-reth"

# =============================================================================
# Beranodes Directory Structure
# =============================================================================

readonly BERANODES_PATH_DEFAULT="$(pwd)/beranodes"
readonly BERANODES_PATH_BIN="/bin"
readonly BERANODES_PATH_TMP="/tmp"
readonly BERANODES_PATH_LOGS="/logs"
readonly BERANODES_PATH_NODES="/nodes"
readonly BERANODES_PATH_RUNS="/runs"

readonly GENESIS_ETH_NAME_DEFAULT="eth-genesis.json"
readonly GENESIS_BEACON_NAME_DEFAULT="genesis.json"
readonly SUPPORTED_CAST_VERSION="1.6.0"
readonly SUPPORTED_TAR_GZ_VERSION="1.34"
readonly SUPPORTED_CURL_VERSION="8.7.1"
BERANODES_PATH=${BERANODES_PATH:-$(pwd)/beranodes}

# =============================================================================
# Repositories
# =============================================================================
readonly RELEASE_BERARETH="https://api.github.com/repos/berachain/bera-reth"
readonly RELEASE_BEACONKIT="https://api.github.com/repos/berachain/beacon-kit"
readonly REPO_BEACONKIT="https://raw.githubusercontent.com/berachain/beacon-kit/refs/heads/main/testing/networks/80094"

# =============================================================================
# Default Genesis Contracts
# =============================================================================
# These contracts are deployed at genesis with pre-set addresses.
# This ensures critical infrastructure exists from block 0.

# --- EIP-4788 Beacon Roots Contract ---
# Address: 0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02
# Purpose: Stores beacon chain block roots, allowing smart contracts to
# trustlessly access consensus layer data (validator info, etc.)
# Required for Cancun-enabled networks (EIP-4788)
ETH_GENESIS_BEACON_ROOTS_ADDRESS="0x000F3df6D732807Ef1319fB7B8bB8522d0Beac02"
ETH_GENESIS_BEACON_ROOTS_CODE="0x3373fffffffffffffffffffffffffffffffffffffffe14604d57602036146024575f5ffd5b5f35801560495762001fff810690815414603c575f5ffd5b62001fff01545f5260205ff35b5f5ffd5b62001fff42064281555f359062001fff015500"
ETH_GENESIS_BEACON_ROOTS_BALANCE="0x0"
ETH_GENESIS_BEACON_ROOTS_NONCE="0x1"

# --- CREATE2 Deployer (Deterministic Deployment Proxy) ---
# Address: 0x4e59b44847b379578588920cA78FbF26c0B4956C
# Purpose: Allows deploying contracts to deterministic addresses using CREATE2
# The same contract deployed with same bytecode + salt = same address on any chain
# This is a standard address used across many EVM chains
ETH_GENESIS_CREATE2_DEPLOYER_ADDRESS="0x4e59b44847b379578588920cA78FbF26c0B4956C"
ETH_GENESIS_CREATE2_DEPLOYER_CODE="0x7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe03601600081602082378035828234f58015156039578182fd5b8082525050506014600cf3"
ETH_GENESIS_CREATE2_DEPLOYER_BALANCE="0x0"
ETH_GENESIS_CREATE2_DEPLOYER_NONCE="0x1"

# --- Multicall3 ---
# Address: 0xcA11bde05977b3631167028862bE2a173976CA11
# Purpose: Batch multiple read-only calls into a single RPC request
# Essential for efficient dApp frontends and indexers
# Standard deployment address across EVM chains
ETH_GENESIS_MULTICALL3_ADDRESS="0xcA11bde05977b3631167028862bE2a173976CA11"
ETH_GENESIS_MULTICALL3_CODE="0x6080604052600436106100f35760003560e01c80634d2301cc1161008a578063a8b0574e11610059578063a8b0574e1461025a578063bce38bd714610275578063c3077fa914610288578063ee82ac5e1461029b57600080fd5b80634d2301cc146101ec57806372425d9d1461022157806382ad56cb1461023457806386d516e81461024757600080fd5b80633408e470116100c65780633408e47014610191578063399542e9146101a45780633e64a696146101c657806342cbb15c146101d957600080fd5b80630f28c97d146100f8578063174dea711461011a578063252dba421461013a57806327e86d6e1461015b575b600080fd5b34801561010457600080fd5b50425b6040519081526020015b60405180910390f35b61012d610128366004610a85565b6102ba565b6040516101119190610bbe565b61014d610148366004610a85565b6104ef565b604051610111929190610bd8565b34801561016757600080fd5b50437fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0140610107565b34801561019d57600080fd5b5046610107565b6101b76101b2366004610c60565b610690565b60405161011193929190610cba565b3480156101d257600080fd5b5048610107565b3480156101e557600080fd5b5043610107565b3480156101f857600080fd5b50610107610207366004610ce2565b73ffffffffffffffffffffffffffffffffffffffff163190565b34801561022d57600080fd5b5044610107565b61012d610242366004610a85565b6106ab565b34801561025357600080fd5b5045610107565b34801561026657600080fd5b50604051418152602001610111565b61012d610283366004610c60565b61085a565b6101b7610296366004610a85565b610a1a565b3480156102a757600080fd5b506101076102b6366004610d18565b4090565b60606000828067ffffffffffffffff8111156102d8576102d8610d31565b60405190808252806020026020018201604052801561031e57816020015b6040805180820190915260008152606060208201528152602001906001900390816102f65790505b5092503660005b8281101561047757600085828151811061034157610341610d60565b6020026020010151905087878381811061035d5761035d610d60565b905060200281019061036f9190610d8f565b6040810135958601959093506103886020850185610ce2565b73ffffffffffffffffffffffffffffffffffffffff16816103ac6060870187610dcd565b6040516103ba929190610e32565b60006040518083038185875af1925050503d80600081146103f7576040519150601f19603f3d011682016040523d82523d6000602084013e6103fc565b606091505b50602080850191909152901515808452908501351761046d577f08c379a000000000000000000000000000000000000000000000000000000000600052602060045260176024527f4d756c746963616c6c333a2063616c6c206661696c656400000000000000000060445260846000fd5b5050600101610325565b508234146104e6576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601a60248201527f4d756c746963616c6c333a2076616c7565206d69736d6174636800000000000060448201526064015b60405180910390fd5b50505092915050565b436060828067ffffffffffffffff81111561050c5761050c610d31565b60405190808252806020026020018201604052801561053f57816020015b606081526020019060019003908161052a5790505b5091503660005b8281101561068657600087878381811061056257610562610d60565b90506020028101906105749190610e42565b92506105836020840184610ce2565b73ffffffffffffffffffffffffffffffffffffffff166105a66020850185610dcd565b6040516105b4929190610e32565b6000604051808303816000865af19150503d80600081146105f1576040519150601f19603f3d011682016040523d82523d6000602084013e6105f6565b606091505b5086848151811061060957610609610d60565b602090810291909101015290508061067d576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f4d756c746963616c6c333a2063616c6c206661696c656400000000000000000060448201526064016104dd565b50600101610546565b5050509250929050565b43804060606106a086868661085a565b905093509350939050565b6060818067ffffffffffffffff8111156106c7576106c7610d31565b60405190808252806020026020018201604052801561070d57816020015b6040805180820190915260008152606060208201528152602001906001900390816106e55790505b5091503660005b828110156104e657600084828151811061073057610730610d60565b6020026020010151905086868381811061074c5761074c610d60565b905060200281019061075e9190610e76565b925061076d6020840184610ce2565b73ffffffffffffffffffffffffffffffffffffffff166107906040850185610dcd565b60405161079e929190610e32565b6000604051808303816000865af19150503d80600081146107db576040519150601f19603f3d011682016040523d82523d6000602084013e6107e0565b606091505b506020808401919091529015158083529084013517610851577f08c379a000000000000000000000000000000000000000000000000000000000600052602060045260176024527f4d756c746963616c6c333a2063616c6c206661696c656400000000000000000060445260646000fd5b50600101610714565b6060818067ffffffffffffffff81111561087657610876610d31565b6040519080825280602002602001820160405280156108bc57816020015b6040805180820190915260008152606060208201528152602001906001900390816108945790505b5091503660005b82811015610a105760008482815181106108df576108df610d60565b602002602001015190508686838181106108fb576108fb610d60565b905060200281019061090d9190610e42565b925061091c6020840184610ce2565b73ffffffffffffffffffffffffffffffffffffffff1661093f6020850185610dcd565b60405161094d929190610e32565b6000604051808303816000865af19150503d806000811461098a576040519150601f19603f3d011682016040523d82523d6000602084013e61098f565b606091505b506020830152151581528715610a07578051610a07576040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601760248201527f4d756c746963616c6c333a2063616c6c206661696c656400000000000000000060448201526064016104dd565b506001016108c3565b5050509392505050565b6000806060610a2b60018686610690565b919790965090945092505050565b60008083601f840112610a4b57600080fd5b50813567ffffffffffffffff811115610a6357600080fd5b6020830191508360208260051b8501011115610a7e57600080fd5b9250929050565b60008060208385031215610a9857600080fd5b823567ffffffffffffffff811115610aaf57600080fd5b610abb85828601610a39565b90969095509350505050565b6000815180845260005b81811015610aed57602081850181015186830182015201610ad1565b81811115610aff576000602083870101525b50601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0169290920160200192915050565b600082825180855260208086019550808260051b84010181860160005b84811015610bb1578583037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe001895281518051151584528401516040858501819052610b9d81860183610ac7565b9a86019a9450505090830190600101610b4f565b5090979650505050505050565b602081526000610bd16020830184610b32565b9392505050565b600060408201848352602060408185015281855180845260608601915060608160051b870101935082870160005b82811015610c52577fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa0888703018452610c40868351610ac7565b95509284019290840190600101610c06565b509398975050505050505050565b600080600060408486031215610c7557600080fd5b83358015158114610c8557600080fd5b9250602084013567ffffffffffffffff811115610ca157600080fd5b610cad86828701610a39565b9497909650939450505050565b838152826020820152606060408201526000610cd96060830184610b32565b95945050505050565b600060208284031215610cf457600080fd5b813573ffffffffffffffffffffffffffffffffffffffff81168114610bd157600080fd5b600060208284031215610d2a57600080fd5b5035919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff81833603018112610dc357600080fd5b9190910192915050565b60008083357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe1843603018112610e0257600080fd5b83018035915067ffffffffffffffff821115610e1d57600080fd5b602001915036819003821315610a7e57600080fd5b8183823760009101908152919050565b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc1833603018112610dc357600080fd5b600082357fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa1833603018112610dc357600080fdfea2646970667358221220bb2b5c71a328032f97c676ae39a1ec2148d3e5d6f73d95e9b17910152d61f16264736f6c634300080c0033"
ETH_GENESIS_MULTICALL3_BALANCE="0x0"
ETH_GENESIS_MULTICALL3_NONCE="0x1"

# --- WBERA (Wrapped BERA) ---
# Address: 0x6969696969696969696969696969696969696969
# Purpose: ERC-20 wrapper for the native BERA token
# Allows BERA to be used in DeFi protocols that require ERC-20 tokens
# Equivalent to WETH on Ethereum
ETH_GENESIS_WBERA_ADDRESS="0x6969696969696969696969696969696969696969"
ETH_GENESIS_WBERA_CODE="0x6080604052600436106100dc575f3560e01c806370a082311161007c578063a9059cbb11610057578063a9059cbb14610365578063d0e30db014610384578063d505accf1461038c578063dd62ed3e146103ab575f80fd5b806370a08231146102be5780637ecebe00146102ef57806395d89b4114610320575f80fd5b806323b872dd116100b757806323b872dd1461019b5780632e1a7d4d146101ba578063313ce567146101d95780633644e515146101f4575f80fd5b806306fdde03146100ef578063095ea7b31461014657806318160ddd14610175575f80fd5b366100eb576100e96103df565b005b5f80fd5b3480156100fa575f80fd5b5060408051808201909152600c81527f577261707065642042657261000000000000000000000000000000000000000060208201525b60405161013d9190610865565b60405180910390f35b348015610151575f80fd5b506101656101603660046108e0565b6103eb565b604051901515815260200161013d565b348015610180575f80fd5b506805345cdf77eb68f44c545b60405190815260200161013d565b3480156101a6575f80fd5b506101656101b5366004610908565b61043a565b3480156101c5575f80fd5b506100e96101d4366004610942565b6104f2565b3480156101e4575f80fd5b506040516012815260200161013d565b3480156101ff575f80fd5b50604080518082018252600c81527f577261707065642042657261000000000000000000000000000000000000000060209182015281517f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f81527fb6c9387dd48cdde7d71a807357f57f1fef05232a4af3ed7fdf1f050c8e1a69fe918101919091527fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc69181019190915246606082015230608082015260a0902061018d565b3480156102c9575f80fd5b5061018d6102d8366004610959565b6387a211a2600c9081525f91909152602090205490565b3480156102fa575f80fd5b5061018d610309366004610959565b6338377508600c9081525f91909152602090205490565b34801561032b575f80fd5b5060408051808201909152600581527f57424552410000000000000000000000000000000000000000000000000000006020820152610130565b348015610370575f80fd5b5061016561037f3660046108e0565b610518565b6100e96103df565b348015610397575f80fd5b506100e96103a6366004610979565b61058f565b3480156103b6575f80fd5b5061018d6103c53660046109e6565b602052637f5e9f20600c9081525f91909152603490205490565b6103e93334610768565b565b5f82602052637f5e9f20600c52335f52816034600c2055815f52602c5160601c337f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92560205fa350600192915050565b5f8360601b33602052637f5e9f208117600c526034600c2080548019156104765780851115610470576313be252b5f526004601cfd5b84810382555b50506387a211a28117600c526020600c2080548085111561049e5763f4d678b85f526004601cfd5b84810382555050835f526020600c208381540181555082602052600c5160601c8160601c7fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602080a3505060019392505050565b6104fc33826107e4565b5f385f3884335af16105155763b12d13eb5f526004601cfd5b50565b5f6387a211a2600c52335f526020600c208054808411156105405763f4d678b85f526004601cfd5b83810382555050825f526020600c208281540181555081602052600c5160601c337fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602080a350600192915050565b60408051808201909152600c81527f57726170706564204265726100000000000000000000000000000000000000006020909101527fb6c9387dd48cdde7d71a807357f57f1fef05232a4af3ed7fdf1f050c8e1a69fe7fc89efdaa54c0f20c7adf612882df0950f5a951637e0307cdcb4c672f298b8bc64286101561061b57631a15a3cc5f526004601cfd5b6040518960601b60601c99508860601b60601c985065383775081901600e52895f526020600c2080547f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f835284602084015283604084015246606084015230608084015260a08320602e527f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c983528b60208401528a60408401528960608401528060808401528860a084015260c08320604e526042602c205f528760ff16602052866040528560605260208060805f60015afa8c3d51146107035763ddafbaef5f526004601cfd5b019055777f5e9f20000000000000000000000000000000000000000089176040526034602c20889055888a7f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925602060608501a360405250505f60605250505050505050565b6805345cdf77eb68f44c548181018181101561078b5763e5cfe9575f526004601cfd5b806805345cdf77eb68f44c5550506387a211a2600c52815f526020600c208181540181555080602052600c5160601c5f7fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602080a35050565b6387a211a2600c52815f526020600c2080548083111561080b5763f4d678b85f526004601cfd5b82900390556805345cdf77eb68f44c805482900390555f81815273ffffffffffffffffffffffffffffffffffffffff83167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef602083a35050565b602081525f82518060208401528060208501604085015e5f6040828501015260407fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f83011684010191505092915050565b803573ffffffffffffffffffffffffffffffffffffffff811681146108db575f80fd5b919050565b5f80604083850312156108f1575f80fd5b6108fa836108b8565b946020939093013593505050565b5f805f6060848603121561091a575f80fd5b610923846108b8565b9250610931602085016108b8565b929592945050506040919091013590565b5f60208284031215610952575f80fd5b5035919050565b5f60208284031215610969575f80fd5b610972826108b8565b9392505050565b5f805f805f805f60e0888a03121561098f575f80fd5b610998886108b8565b96506109a6602089016108b8565b95506040880135945060608801359350608088013560ff811681146109c9575f80fd5b9699959850939692959460a0840135945060c09093013592915050565b5f80604083850312156109f7575f80fd5b610a00836108b8565b9150610a0e602084016108b8565b9050925092905056fea164736f6c634300081a000a"
ETH_GENESIS_WBERA_BALANCE="0x0"
ETH_GENESIS_WBERA_NONCE="0x1"

# --- Permit2 (Uniswap) ---
# Address: 0x000000000022D473030F116dDEE9F6B43aC78BA3
# Purpose: Advanced token approval patterns for secure token transfers
# Standard deployment address used across all EVM chains
# Enables time-limited and granular allowances
ETH_GENESIS_PERMIT2_ADDRESS="0x000000000022D473030F116dDEE9F6B43aC78BA3"
ETH_GENESIS_PERMIT2_CODE="0x6040608081526004908136101561001557600080fd5b600090813560e01c80630d58b1db1461126c578063137c29fe146110755780632a2d80d114610db75780632b67b57014610bde57806330f28b7a14610ade5780633644e51514610a9d57806336c7851614610a285780633ff9dcb1146109a85780634fe02b441461093f57806365d9723c146107ac57806387517c451461067a578063927da105146105c3578063cc53287f146104a3578063edd9444b1461033a5763fe8ec1a7146100c657600080fd5b346103365760c07ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103365767ffffffffffffffff833581811161033257610114903690860161164b565b60243582811161032e5761012b903690870161161a565b6101336114e6565b9160843585811161032a5761014b9036908a016115c1565b98909560a43590811161032657610164913691016115c1565b969095815190610173826113ff565b606b82527f5065726d697442617463685769746e6573735472616e7366657246726f6d285460208301527f6f6b656e5065726d697373696f6e735b5d207065726d69747465642c61646472838301527f657373207370656e6465722c75696e74323536206e6f6e63652c75696e74323560608301527f3620646561646c696e652c000000000000000000000000000000000000000000608083015282519a8b9181610222602085018096611f93565b918237018a8152039961025b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe09b8c8101835282611437565b5190209085515161026b81611ebb565b908a5b8181106102f95750506102f6999a6102ed9183516102a081610294602082018095611f66565b03848101835282611437565b519020602089810151858b015195519182019687526040820192909252336060820152608081019190915260a081019390935260643560c08401528260e081015b03908101835282611437565b51902093611cf7565b80f35b8061031161030b610321938c5161175e565b51612054565b61031b828661175e565b52611f0a565b61026e565b8880fd5b8780fd5b8480fd5b8380fd5b5080fd5b5091346103365760807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103365767ffffffffffffffff9080358281116103325761038b903690830161164b565b60243583811161032e576103a2903690840161161a565b9390926103ad6114e6565b9160643590811161049f576103c4913691016115c1565b949093835151976103d489611ebb565b98885b81811061047d5750506102f697988151610425816103f9602082018095611f66565b037fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe08101835282611437565b5190206020860151828701519083519260208401947ffcf35f5ac6a2c28868dc44c302166470266239195f02b0ee408334829333b7668652840152336060840152608083015260a082015260a081526102ed8161141b565b808b61031b8261049461030b61049a968d5161175e565b9261175e565b6103d7565b8680fd5b5082346105bf57602090817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126103325780359067ffffffffffffffff821161032e576104f49136910161161a565b929091845b848110610504578580f35b8061051a610515600193888861196c565b61197c565b61052f84610529848a8a61196c565b0161197c565b3389528385528589209173ffffffffffffffffffffffffffffffffffffffff80911692838b528652868a20911690818a5285528589207fffffffffffffffffffffffff000000000000000000000000000000000000000081541690558551918252848201527f89b1add15eff56b3dfe299ad94e01f2b52fbcb80ae1a3baea6ae8c04cb2b98a4853392a2016104f9565b8280fd5b50346103365760607ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033657610676816105ff6114a0565b936106086114c3565b6106106114e6565b73ffffffffffffffffffffffffffffffffffffffff968716835260016020908152848420928816845291825283832090871683528152919020549251938316845260a083901c65ffffffffffff169084015260d09190911c604083015281906060820190565b0390f35b50346103365760807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610336576106b26114a0565b906106bb6114c3565b916106c46114e6565b65ffffffffffff926064358481169081810361032a5779ffffffffffff0000000000000000000000000000000000000000947fda9fa7c1b00402c17d0161b249b1ab8bbec047c5a52207b9c112deffd817036b94338a5260016020527fffffffffffff0000000000000000000000000000000000000000000000000000858b209873ffffffffffffffffffffffffffffffffffffffff809416998a8d5260205283878d209b169a8b8d52602052868c209486156000146107a457504216925b8454921697889360a01b16911617179055815193845260208401523392a480f35b905092610783565b5082346105bf5760607ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126105bf576107e56114a0565b906107ee6114c3565b9265ffffffffffff604435818116939084810361032a57338852602091600183528489209673ffffffffffffffffffffffffffffffffffffffff80911697888b528452858a20981697888a5283528489205460d01c93848711156109175761ffff9085840316116108f05750907f55eb90d810e1700b35a8e7e25395ff7f2b2259abd7415ca2284dfb1c246418f393929133895260018252838920878a528252838920888a5282528389209079ffffffffffffffffffffffffffffffffffffffffffffffffffff7fffffffffffff000000000000000000000000000000000000000000000000000083549260d01b16911617905582519485528401523392a480f35b84517f24d35a26000000000000000000000000000000000000000000000000000000008152fd5b5084517f756688fe000000000000000000000000000000000000000000000000000000008152fd5b503461033657807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610336578060209273ffffffffffffffffffffffffffffffffffffffff61098f6114a0565b1681528084528181206024358252845220549051908152f35b5082346105bf57817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126105bf577f3704902f963766a4e561bbaab6e6cdc1b1dd12f6e9e99648da8843b3f46b918d90359160243533855284602052818520848652602052818520818154179055815193845260208401523392a280f35b8234610a9a5760807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc360112610a9a57610a606114a0565b610a686114c3565b610a706114e6565b6064359173ffffffffffffffffffffffffffffffffffffffff8316830361032e576102f6936117a1565b80fd5b503461033657817ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033657602090610ad7611b1e565b9051908152f35b508290346105bf576101007ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126105bf57610b1a3661152a565b90807fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7c36011261033257610b4c611478565b9160e43567ffffffffffffffff8111610bda576102f694610b6f913691016115c1565b939092610b7c8351612054565b6020840151828501519083519260208401947f939c21a48a8dbe3a9a2404a1d46691e4d39f6583d6ec6b35714604c986d801068652840152336060840152608083015260a082015260a08152610bd18161141b565b51902091611c25565b8580fd5b509134610336576101007ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033657610c186114a0565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdc360160c08112610332576080855191610c51836113e3565b1261033257845190610c6282611398565b73ffffffffffffffffffffffffffffffffffffffff91602435838116810361049f578152604435838116810361049f57602082015265ffffffffffff606435818116810361032a5788830152608435908116810361049f576060820152815260a435938285168503610bda576020820194855260c4359087830182815260e43567ffffffffffffffff811161032657610cfe90369084016115c1565b929093804211610d88575050918591610d786102f6999a610d7e95610d238851611fbe565b90898c511690519083519260208401947ff3841cd1ff0085026a6327b620b67997ce40f282c88a8e905a7a5626e310f3d086528401526060830152608082015260808152610d70816113ff565b519020611bd9565b916120c7565b519251169161199d565b602492508a51917fcd21db4f000000000000000000000000000000000000000000000000000000008352820152fd5b5091346103365760607ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc93818536011261033257610df36114a0565b9260249081359267ffffffffffffffff9788851161032a578590853603011261049f578051978589018981108282111761104a578252848301358181116103265785019036602383011215610326578382013591610e50836115ef565b90610e5d85519283611437565b838252602093878584019160071b83010191368311611046578801905b828210610fe9575050508a526044610e93868801611509565b96838c01978852013594838b0191868352604435908111610fe557610ebb90369087016115c1565b959096804211610fba575050508998995151610ed681611ebb565b908b5b818110610f9757505092889492610d7892610f6497958351610f02816103f98682018095611f66565b5190209073ffffffffffffffffffffffffffffffffffffffff9a8b8b51169151928551948501957faf1b0d30d2cab0380e68f0689007e3254993c596f2fdd0aaa7f4d04f794408638752850152830152608082015260808152610d70816113ff565b51169082515192845b848110610f78578580f35b80610f918585610f8b600195875161175e565b5161199d565b01610f6d565b80610311610fac8e9f9e93610fb2945161175e565b51611fbe565b9b9a9b610ed9565b8551917fcd21db4f000000000000000000000000000000000000000000000000000000008352820152fd5b8a80fd5b6080823603126110465785608091885161100281611398565b61100b85611509565b8152611018838601611509565b838201526110278a8601611607565b8a8201528d611037818701611607565b90820152815201910190610e7a565b8c80fd5b84896041867f4e487b7100000000000000000000000000000000000000000000000000000000835252fd5b5082346105bf576101407ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126105bf576110b03661152a565b91807fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff7c360112610332576110e2611478565b67ffffffffffffffff93906101043585811161049f5761110590369086016115c1565b90936101243596871161032a57611125610bd1966102f6983691016115c1565b969095825190611134826113ff565b606482527f5065726d69745769746e6573735472616e7366657246726f6d28546f6b656e5060208301527f65726d697373696f6e73207065726d69747465642c6164647265737320737065848301527f6e6465722c75696e74323536206e6f6e63652c75696e7432353620646561646c60608301527f696e652c0000000000000000000000000000000000000000000000000000000060808301528351948591816111e3602085018096611f93565b918237018b8152039361121c7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe095868101835282611437565b5190209261122a8651612054565b6020878101518589015195519182019687526040820192909252336060820152608081019190915260a081019390935260e43560c08401528260e081016102e1565b5082346105bf576020807ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc36011261033257813567ffffffffffffffff92838211610bda5736602383011215610bda5781013592831161032e576024906007368386831b8401011161049f57865b8581106112e5578780f35b80821b83019060807fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffdc83360301126103265761139288876001946060835161132c81611398565b611368608461133c8d8601611509565b9485845261134c60448201611509565b809785015261135d60648201611509565b809885015201611509565b918291015273ffffffffffffffffffffffffffffffffffffffff80808093169516931691166117a1565b016112da565b6080810190811067ffffffffffffffff8211176113b457604052565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6060810190811067ffffffffffffffff8211176113b457604052565b60a0810190811067ffffffffffffffff8211176113b457604052565b60c0810190811067ffffffffffffffff8211176113b457604052565b90601f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0910116810190811067ffffffffffffffff8211176113b457604052565b60c4359073ffffffffffffffffffffffffffffffffffffffff8216820361149b57565b600080fd5b6004359073ffffffffffffffffffffffffffffffffffffffff8216820361149b57565b6024359073ffffffffffffffffffffffffffffffffffffffff8216820361149b57565b6044359073ffffffffffffffffffffffffffffffffffffffff8216820361149b57565b359073ffffffffffffffffffffffffffffffffffffffff8216820361149b57565b7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc01906080821261149b576040805190611563826113e3565b8082941261149b57805181810181811067ffffffffffffffff8211176113b457825260043573ffffffffffffffffffffffffffffffffffffffff8116810361149b578152602435602082015282526044356020830152606435910152565b9181601f8401121561149b5782359167ffffffffffffffff831161149b576020838186019501011161149b57565b67ffffffffffffffff81116113b45760051b60200190565b359065ffffffffffff8216820361149b57565b9181601f8401121561149b5782359167ffffffffffffffff831161149b576020808501948460061b01011161149b57565b91909160608184031261149b576040805191611666836113e3565b8294813567ffffffffffffffff9081811161149b57830182601f8201121561149b578035611693816115ef565b926116a087519485611437565b818452602094858086019360061b8501019381851161149b579086899897969594939201925b8484106116e3575050505050855280820135908501520135910152565b90919293949596978483031261149b578851908982019082821085831117611730578a928992845261171487611509565b81528287013583820152815201930191908897969594936116c6565b602460007f4e487b710000000000000000000000000000000000000000000000000000000081526041600452fd5b80518210156117725760209160051b010190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b92919273ffffffffffffffffffffffffffffffffffffffff604060008284168152600160205282828220961695868252602052818120338252602052209485549565ffffffffffff8760a01c16804211611884575082871696838803611812575b5050611810955016926118b5565b565b878484161160001461184f57602488604051907ff96fb0710000000000000000000000000000000000000000000000000000000082526004820152fd5b7fffffffffffffffffffffffff000000000000000000000000000000000000000084846118109a031691161790553880611802565b602490604051907fd81b2f2e0000000000000000000000000000000000000000000000000000000082526004820152fd5b9060006064926020958295604051947f23b872dd0000000000000000000000000000000000000000000000000000000086526004860152602485015260448401525af13d15601f3d116001600051141617161561190e57565b60646040517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601460248201527f5452414e534645525f46524f4d5f4641494c45440000000000000000000000006044820152fd5b91908110156117725760061b0190565b3573ffffffffffffffffffffffffffffffffffffffff8116810361149b5790565b9065ffffffffffff908160608401511673ffffffffffffffffffffffffffffffffffffffff908185511694826020820151169280866040809401511695169560009187835260016020528383208984526020528383209916988983526020528282209184835460d01c03611af5579185611ace94927fc6a377bfc4eb120024a8ac08eef205be16b817020812c73223e81d1bdb9708ec98979694508715600014611ad35779ffffffffffff00000000000000000000000000000000000000009042165b60a01b167fffffffffffff00000000000000000000000000000000000000000000000000006001860160d01b1617179055519384938491604091949373ffffffffffffffffffffffffffffffffffffffff606085019616845265ffffffffffff809216602085015216910152565b0390a4565b5079ffffffffffff000000000000000000000000000000000000000087611a60565b600484517f756688fe000000000000000000000000000000000000000000000000000000008152fd5b467f00000000000000000000000000000000000000000000000000000000000138de03611b69577f1dc08c4ac637ae13fdbae95e53fb95942c41e44de89165404e5111c4e5b560ae90565b60405160208101907f8cad95687ba82c2ce50e74f7b754645e5117c3a5bec8151c0726d5857980a86682527f9ac997416e8ff9d2ff6bebeb7149f65cdae5e32e2b90440b566bb3044041d36a604082015246606082015230608082015260808152611bd3816113ff565b51902090565b611be1611b1e565b906040519060208201927f190100000000000000000000000000000000000000000000000000000000000084526022830152604282015260428152611bd381611398565b9192909360a435936040840151804211611cc65750602084510151808611611c955750918591610d78611c6594611c60602088015186611e47565b611bd9565b73ffffffffffffffffffffffffffffffffffffffff809151511692608435918216820361149b57611810936118b5565b602490604051907f3728b83d0000000000000000000000000000000000000000000000000000000082526004820152fd5b602490604051907fcd21db4f0000000000000000000000000000000000000000000000000000000082526004820152fd5b959093958051519560409283830151804211611e175750848803611dee57611d2e918691610d7860209b611c608d88015186611e47565b60005b868110611d42575050505050505050565b611d4d81835161175e565b5188611d5a83878a61196c565b01359089810151808311611dbe575091818888886001968596611d84575b50505050505001611d31565b611db395611dad9273ffffffffffffffffffffffffffffffffffffffff6105159351169561196c565b916118b5565b803888888883611d78565b6024908651907f3728b83d0000000000000000000000000000000000000000000000000000000082526004820152fd5b600484517fff633a38000000000000000000000000000000000000000000000000000000008152fd5b6024908551907fcd21db4f0000000000000000000000000000000000000000000000000000000082526004820152fd5b9073ffffffffffffffffffffffffffffffffffffffff600160ff83161b9216600052600060205260406000209060081c6000526020526040600020818154188091551615611e9157565b60046040517f756688fe000000000000000000000000000000000000000000000000000000008152fd5b90611ec5826115ef565b611ed26040519182611437565b8281527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0611f0082946115ef565b0190602036910137565b7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8114611f375760010190565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b805160208092019160005b828110611f7f575050505090565b835185529381019392810192600101611f71565b9081519160005b838110611fab575050016000815290565b8060208092840101518185015201611f9a565b60405160208101917f65626cad6cb96493bf6f5ebea28756c966f023ab9e8a83a7101849d5573b3678835273ffffffffffffffffffffffffffffffffffffffff8082511660408401526020820151166060830152606065ffffffffffff9182604082015116608085015201511660a082015260a0815260c0810181811067ffffffffffffffff8211176113b45760405251902090565b6040516020808201927f618358ac3db8dc274f0cd8829da7e234bd48cd73c4a740aede1adec9846d06a1845273ffffffffffffffffffffffffffffffffffffffff81511660408401520151606082015260608152611bd381611398565b919082604091031261149b576020823592013590565b6000843b61222e5750604182036121ac576120e4828201826120b1565b939092604010156117725760209360009360ff6040608095013560f81c5b60405194855216868401526040830152606082015282805260015afa156121a05773ffffffffffffffffffffffffffffffffffffffff806000511691821561217657160361214c57565b60046040517f815e1d64000000000000000000000000000000000000000000000000000000008152fd5b60046040517f8baa579f000000000000000000000000000000000000000000000000000000008152fd5b6040513d6000823e3d90fd5b60408203612204576121c0918101906120b1565b91601b7f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff84169360ff1c019060ff8211611f375760209360009360ff608094612102565b60046040517f4be6321b000000000000000000000000000000000000000000000000000000008152fd5b929391601f928173ffffffffffffffffffffffffffffffffffffffff60646020957fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0604051988997889687947f1626ba7e000000000000000000000000000000000000000000000000000000009e8f8752600487015260406024870152816044870152868601378b85828601015201168101030192165afa9081156123a857829161232a575b7fffffffff000000000000000000000000000000000000000000000000000000009150160361230057565b60046040517fb0669cbc000000000000000000000000000000000000000000000000000000008152fd5b90506020813d82116123a0575b8161234460209383611437565b810103126103365751907fffffffff0000000000000000000000000000000000000000000000000000000082168203610a9a57507fffffffff0000000000000000000000000000000000000000000000000000000090386122d4565b3d9150612337565b6040513d84823e3d90fdfea164736f6c6343000811000a"
ETH_GENESIS_PERMIT2_BALANCE="0x0"
ETH_GENESIS_PERMIT2_NONCE="0x1"

# --- BeaconDeposit Contract ---
# Address: 0x4242424242424242424242424242424242424242
# Purpose: Handles validator deposits for Berachain's Proof-of-Stake consensus
# Validators deposit BERA (min 10,000) to participate in consensus
# Events from this contract are used by the beacon chain for staking management
ETH_GENESIS_BEACON_DEPOSIT_ADDRESS="0x4242424242424242424242424242424242424242"
ETH_GENESIS_BEACON_DEPOSIT_CODE="0x608060405234801561001057600080fd5b50600436106100935760003560e01c8063621fd130116100665780636353586511610050578063635358651461011f578063c5f2892f14610132578063d2354e4a1461014557600080fd5b80637f8661a11461010c578063a38b4f4114610114575b600080fd5b6100a661009e36600461066c565b600092915050565b60405160ff90911681526020015b60405180910390f35b6100bd61015857610158565b60405190815260200161009e565b61010a6101083660046106df565b565b005b61010a61016957610169565b61010a61012236600461071f565b50565b61010a61013036600461078c565b565b6100bd6101403660046107f8565b610179565b61010a61015336600461080e565b600080fd5b600080fd5b50565b50565b600080fd5b600080fd5b919050565b600080fd5b505050565b50565b600080fd5b50565b50565b600080fd5b50565b600080fd5b6000806000604084860312156101a857600080fd5b833567ffffffffffffffff808211156101c057600080fd5b818601915086601f8301126101d457600080fd5b8135818111156101e357600080fd5b8760208285010111156101f557600080fd5b6020928301955093505084013561020b81610257565b809150509250925092565b60006020828403121561022857600080fd5b5035919050565b60006020828403121561024157600080fd5b813561024c81610257565b809150509291505056fea164736f6c6343000817000a"
ETH_GENESIS_BEACON_DEPOSIT_BALANCE="0x0"
ETH_GENESIS_BEACON_DEPOSIT_NONCE="0x1"
ETH_GENESIS_BEACON_DEPOSIT_STORAGE_KEY="0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000001"
ETH_GENESIS_BEACON_DEPOSIT_STORAGE_VALUE="0x0000000000000000000000000000000000000000000000000000000000000000,0x0000000000000000000000000000000000000000000000000000000000000000"

# =============================================================================
# Prague Upgrade Configurations
# =============================================================================

# --- Prague1 ---
ETH_GENESIS_PRAGUE1_TIME=1756915200
ETH_GENESIS_PRAGUE1_BASE_FEE_CHANGE_DENOMINATOR=48
ETH_GENESIS_PRAGUE1_MIN_BASE_FEE=1000000000
ETH_GENESIS_PRAGUE1_POL_DISTRIBUTOR="0xD2f19a79b026Fb636A7c300bF5947df113940761"
# Empty on purpose
ETH_GENESIS_PRAGUE1_BEX_VAULT=
ETH_GENESIS_PRAGUE1_RESCUE_ADDRESS=
ETH_GENESIS_PRAGUE1_BLOCKED_ADDRESSES=

# --- Prague2 ---
ETH_GENESIS_PRAGUE2_TIME=1759248000
ETH_GENESIS_PRAGUE2_BASE_FEE_CHANGE_DENOMINATOR=
ETH_GENESIS_PRAGUE2_MIN_BASE_FEE=0
ETH_GENESIS_PRAGUE2_POL_DISTRIBUTOR=
ETH_GENESIS_PRAGUE2_BEX_VAULT=
ETH_GENESIS_PRAGUE2_RESCUE_ADDRESS=
ETH_GENESIS_PRAGUE2_BLOCKED_ADDRESSES=

# --- Prague3 ---
ETH_GENESIS_PRAGUE3_TIME=1762164459
ETH_GENESIS_PRAGUE3_BASE_FEE_CHANGE_DENOMINATOR=
ETH_GENESIS_PRAGUE3_MIN_BASE_FEE=
ETH_GENESIS_PRAGUE3_POL_DISTRIBUTOR=
ETH_GENESIS_PRAGUE3_BEX_VAULT="0x4be03f781c497a489e3cb0287833452ca9b9e80b"
ETH_GENESIS_PRAGUE3_RESCUE_ADDRESS="0xD276D30592bE512a418f2448e23f9E7F372b32A2"
ETH_GENESIS_PRAGUE3_BLOCKED_ADDRESSES="0xF8Bec8cB704b8BD427FD209A2058b396C4BC543e,0x0000000000000000000000000000000000000000"

# --- Prague4 ---
ETH_GENESIS_PRAGUE4_TIME=1762963200
ETH_GENESIS_PRAGUE4_BASE_FEE_CHANGE_DENOMINATOR=
ETH_GENESIS_PRAGUE4_MIN_BASE_FEE=
ETH_GENESIS_PRAGUE4_POL_DISTRIBUTOR=
ETH_GENESIS_PRAGUE4_BEX_VAULT=
ETH_GENESIS_PRAGUE4_RESCUE_ADDRESS=
ETH_GENESIS_PRAGUE4_BLOCKED_ADDRESSES=

# =============================================================================
# Default Beacond app.toml - See ./beacond/config/app.toml
# =============================================================================
readonly APPTOML_PRUNING="everything"
readonly APPTOML_PRUNING_KEEP_RECENT="0"
readonly APPTOML_PRUNING_INTERVAL="0"
readonly APPTOML_HALT_HEIGHT=0
readonly APPTOML_HALT_TIME=0
readonly APPTOML_MIN_RETAIN_BLOCKS=0
readonly APPTOML_INTER_BLOCK_CACHE=true
readonly APPTOML_INDEX_EVENTS=() # Ex: ["message.sender", "message.recipient"]
readonly APPTOML_IAVL_CACHE_SIZE=781250
readonly APPTOML_IAVL_DISABLE_FASTNODE=true
readonly APPTOML_APP_DB_BACKEND="pebbledb"

# Telemetry Configuration
readonly APPTOML_TELEMETRY_SERVICE_NAME="beacond_node"
readonly APPTOML_TELEMETRY_ENABLED=true
readonly APPTOML_TELEMETRY_ENABLE_HOSTNAME=true
readonly APPTOML_TELEMETRY_ENABLE_HOSTNAME_LABEL=true
readonly APPTOML_TELEMETRY_ENABLE_SERVICE_LABEL=true
readonly APPTOML_TELEMETRY_PROMETHEUS_RETENTION_TIME=60
readonly APPTOML_TELEMETRY_GLOBAL_LABELS=() # Ex: [["chain_id", "cosmoshub-1"]]
readonly APPTOML_TELEMETRY_METRICS_SINK=""
readonly APPTOML_TELEMETRY_STATSD_ADDR=""
readonly APPTOML_TELEMETRY_DATADOG_HOSTNAME="my_beacond_node"

# BeaconKit Configuration
readonly APPTOML_BEACON_KIT_CHAIN_SPEC="devnet" # Ex: "devnet" | "testnet" | "mainnet"
readonly APPTOML_BEACON_KIT_CHAIN_SPEC_FILE=""  # Ex: "./testing/networks/80094/chain-spec.json"
readonly APPTOML_BEACON_KIT_SHUTDOWN_TIMEOUT="5m0s"

# BeaconKit Engine Configuration
readonly APPTOML_BEACON_KIT_ENGINE_RPC_DIAL_URL="http://localhost:8551"
readonly APPTOML_BEACON_KIT_ENGINE_RPC_TIMEOUT="2s"
readonly APPTOML_BEACON_KIT_ENGINE_RPC_RETRY_INTERVAL="100ms"
readonly APPTOML_BEACON_KIT_ENGINE_RPC_MAX_RETRY_INTERVAL="10s"
readonly APPTOML_BEACON_KIT_ENGINE_RPC_STARTUP_CHECK_INTERVAL="3s"
readonly APPTOML_BEACON_KIT_ENGINE_RPC_JWT_REFRESH_INTERVAL="30s"
readonly APPTOML_BEACON_KIT_ENGINE_JWT_SECRET_PATH="~/config/jwt.hex"

# BeaconKit Logger Configuration
readonly APPTOML_BEACON_KIT_LOGGER_TIME_FORMAT="RFC3339"
readonly APPTOML_BEACON_KIT_LOGGER_LOG_LEVEL="info"
readonly APPTOML_BEACON_KIT_LOGGER_STYLE="pretty"

# BeaconKit KZG Configuration
readonly APPTOML_BEACON_KIT_KZG_TRUSTED_SETUP_PATH="~/config/kzg-trusted-setup.json"
readonly APPTOML_BEACON_KIT_KZG_IMPLEMENTATION="crate-crypto/go-kzg-4844"

# BeaconKit Payload Builder Configuration
readonly APPTOML_BEACON_KIT_PAYLOAD_BUILDER_ENABLED=true
readonly APPTOML_BEACON_KIT_PAYLOAD_BUILDER_SUGGESTED_FEE_RECIPIENT="0x0000000000000000000000000000000000000000"
readonly APPTOML_BEACON_KIT_PAYLOAD_BUILDER_PAYLOAD_TIMEOUT="850ms"

# BeaconKit Validator Configuration
readonly APPTOML_BEACON_KIT_VALIDATOR_GRAFFITI=""
readonly APPTOML_BEACON_KIT_VALIDATOR_AVAILABILITY_WINDOW="8192"

# BeaconKit Node API Configuration
readonly APPTOML_BEACON_KIT_NODE_API_ENABLED="true"
readonly APPTOML_BEACON_KIT_NODE_API_ADDRESS="0.0.0.0:3500"
readonly APPTOML_BEACON_KIT_NODE_API_LOGGING="true"

# =============================================================================
# Default Beacond client.toml - See ./beacond/config/client.toml
# =============================================================================

readonly CLIENTTOML_CHAIN_ID="devnet-beacon-80087"
readonly CLIENTTOML_KEYRING_BACKEND="test"
readonly CLIENTTOML_KEYRING_DEFAULT_KEYNAME=""
readonly CLIENTTOML_OUTPUT="text"
readonly CLIENTTOML_NODE="tcp://localhost:26657"
readonly CLIENTTOML_BROADCAST_MODE="sync"
readonly CLIENTTOML_GRPC_ADDRESS=""
readonly CLIENTTOML_GRPC_INSECURE=false

# =============================================================================
# Default Beacond config.toml - See ./beacond/config/config.toml
# =============================================================================

# Main Base Config
readonly CONFIGTOML_VERSION="1.0.1"
readonly CONFIGTOML_PROXY_APP="tcp://127.0.0.1:26658"
readonly CONFIGTOML_MONIKER="beranode-<MONIKER>"
readonly CONFIGTOML_DB_BACKEND="pebbledb"
readonly CONFIGTOML_DB_DIR="data"
readonly CONFIGTOML_LOG_LEVEL="info"
readonly CONFIGTOML_LOG_FORMAT="plain"
readonly CONFIGTOML_GENESIS_FILE="config/genesis.json"
readonly CONFIGTOML_PRIV_VALIDATOR_KEY_FILE="config/priv_validator_key.json"
readonly CONFIGTOML_PRIV_VALIDATOR_STATE_FILE="data/priv_validator_state.json"
readonly CONFIGTOML_PRIV_VALIDATOR_LADDR=""
readonly CONFIGTOML_NODE_KEY_FILE="config/node_key.json"
readonly CONFIGTOML_ABCI="socket"
readonly CONFIGTOML_FILTER_PEERS=false

# RPC Server Configuration
readonly CONFIGTOML_RPC_LADDR="tcp://127.0.0.1:26657"
readonly CONFIGTOML_RPC_CORS_ALLOWED_ORIGINS=()
readonly CONFIGTOML_RPC_CORS_ALLOWED_METHODS=("HEAD" "GET" "POST")
readonly CONFIGTOML_RPC_CORS_ALLOWED_HEADERS=("Origin" "Accept" "Content-Type" "X-Requested-With" "X-Server-Time")
readonly CONFIGTOML_RPC_UNSAFE=false
readonly CONFIGTOML_RPC_MAX_OPEN_CONNECTIONS=900
readonly CONFIGTOML_RPC_MAX_SUBSCRIPTION_CLIENTS=100
readonly CONFIGTOML_RPC_MAX_SUBSCRIPTIONS_PER_CLIENT=5
readonly CONFIGTOML_RPC_EXPERIMENTAL_SUBSCRIPTION_BUFFER_SIZE=200
readonly CONFIGTOML_RPC_EXPERIMENTAL_WEBSOCKET_WRITE_BUFFER_SIZE=200
readonly CONFIGTOML_RPC_EXPERIMENTAL_CLOSE_ON_SLOW_CLIENT=false
readonly CONFIGTOML_RPC_TIMEOUT_BROADCAST_TX_COMMIT="10s"
readonly CONFIGTOML_RPC_MAX_REQUEST_BATCH_SIZE=10
readonly CONFIGTOML_RPC_MAX_BODY_BYTES=1000000
readonly CONFIGTOML_RPC_MAX_HEADER_BYTES=1048576
readonly CONFIGTOML_RPC_TLS_CERT_FILE=""
readonly CONFIGTOML_RPC_TLS_KEY_FILE=""
readonly CONFIGTOML_RPC_PPROF_LADDR=""

# gRPC Server Configuration
readonly CONFIGTOML_GRPC_LADDR=""
readonly CONFIGTOML_GRPC_VERSION_SERVICE_ENABLED=true
readonly CONFIGTOML_GRPC_BLOCK_SERVICE_ENABLED=true
readonly CONFIGTOML_GRPC_BLOCK_RESULTS_SERVICE_ENABLED=true
readonly CONFIGTOML_GRPC_PRIVILEGED_LADDR=""
readonly CONFIGTOML_GRPC_PRIVILEGED_PRUNING_SERVICE_ENABLED=false

# P2P Configuration
readonly CONFIGTOML_P2P_LADDR="tcp://0.0.0.0:26656"
readonly CONFIGTOML_P2P_EXTERNAL_ADDRESS=""
readonly CONFIGTOML_P2P_SEEDS=""
readonly CONFIGTOML_P2P_PERSISTENT_PEERS=""
readonly CONFIGTOML_P2P_ADDR_BOOK_FILE="config/addrbook.json"
# must be set to false for multiple nodes on the same machine
readonly CONFIGTOML_P2P_ADDR_BOOK_STRICT=false
readonly CONFIGTOML_P2P_MAX_NUM_INBOUND_PEERS=40
readonly CONFIGTOML_P2P_MAX_NUM_OUTBOUND_PEERS=10
readonly CONFIGTOML_P2P_UNCONDITIONAL_PEER_IDS=""
readonly CONFIGTOML_P2P_PERSISTENT_PEERS_MAX_DIAL_PERIOD="0s"
readonly CONFIGTOML_P2P_FLUSH_THROTTLE_TIMEOUT="10ms"
readonly CONFIGTOML_P2P_MAX_PACKET_MSG_PAYLOAD_SIZE=1024
readonly CONFIGTOML_P2P_SEND_RATE=5120000
readonly CONFIGTOML_P2P_RECV_RATE=5120000
readonly CONFIGTOML_P2P_PEX=true
readonly CONFIGTOML_P2P_SEED_MODE=false
readonly CONFIGTOML_P2P_PRIVATE_PEER_IDS=""
# must be set to true for multiple nodes on the same machine
readonly CONFIGTOML_P2P_ALLOW_DUPLICATE_IP=true
readonly CONFIGTOML_P2P_HANDSHAKE_TIMEOUT="20s"
readonly CONFIGTOML_P2P_DIAL_TIMEOUT="3s"

# Mempool Configuration
readonly CONFIGTOML_MEMPOOL_TYPE="nop"
readonly CONFIGTOML_MEMPOOL_RECHECK=false
readonly CONFIGTOML_MEMPOOL_RECHECK_TIMEOUT="0s"
readonly CONFIGTOML_MEMPOOL_BROADCAST=false
readonly CONFIGTOML_MEMPOOL_WAL_DIR=""
readonly CONFIGTOML_MEMPOOL_SIZE=0
readonly CONFIGTOML_MEMPOOL_MAX_TX_BYTES=0
readonly CONFIGTOML_MEMPOOL_MAX_TXS_BYTES=0
readonly CONFIGTOML_MEMPOOL_CACHE_SIZE=0
readonly CONFIGTOML_MEMPOOL_KEEP_INVALID_TXS_IN_CACHE=false
readonly CONFIGTOML_MEMPOOL_EXPERIMENTAL_MAX_GOSSIP_CONNECTIONS_TO_PERSISTENT_PEERS=0
readonly CONFIGTOML_MEMPOOL_EXPERIMENTAL_MAX_GOSSIP_CONNECTIONS_TO_NON_PERSISTENT_PEERS=0

# State Sync Configuration
readonly CONFIGTOML_STATESYNC_ENABLE=false
readonly CONFIGTOML_STATESYNC_RPC_SERVERS=""
readonly CONFIGTOML_STATESYNC_TRUST_HEIGHT=0
readonly CONFIGTOML_STATESYNC_TRUST_HASH=""
readonly CONFIGTOML_STATESYNC_TRUST_PERIOD="168h0m0s"
readonly CONFIGTOML_STATESYNC_DISCOVERY_TIME="15s"
readonly CONFIGTOML_STATESYNC_TEMP_DIR=""
readonly CONFIGTOML_STATESYNC_CHUNK_REQUEST_TIMEOUT="10s"
readonly CONFIGTOML_STATESYNC_CHUNK_FETCHERS="4"

# Block Sync Configuration
readonly CONFIGTOML_BLOCKSYNC_VERSION="v0"

# Consensus Configuration
readonly CONFIGTOML_CONSENSUS_WAL_FILE="data/cs.wal/wal"
readonly CONFIGTOML_CONSENSUS_TIMEOUT_PROPOSE="2s"
readonly CONFIGTOML_CONSENSUS_TIMEOUT_PROPOSE_DELTA="500ms"
readonly CONFIGTOML_CONSENSUS_TIMEOUT_PREVOTE="2s"
readonly CONFIGTOML_CONSENSUS_TIMEOUT_PREVOTE_DELTA="500ms"
readonly CONFIGTOML_CONSENSUS_TIMEOUT_PRECOMMIT="2s"
readonly CONFIGTOML_CONSENSUS_TIMEOUT_PRECOMMIT_DELTA="500ms"
readonly CONFIGTOML_CONSENSUS_TIMEOUT_COMMIT="0s"
readonly CONFIGTOML_CONSENSUS_SKIP_TIMEOUT_COMMIT=false
readonly CONFIGTOML_CONSENSUS_DOUBLE_SIGN_CHECK_HEIGHT=0
readonly CONFIGTOML_CONSENSUS_CREATE_EMPTY_BLOCKS=true
readonly CONFIGTOML_CONSENSUS_CREATE_EMPTY_BLOCKS_INTERVAL="0s"
readonly CONFIGTOML_CONSENSUS_PEER_GOSSIP_SLEEP_DURATION="100ms"
readonly CONFIGTOML_CONSENSUS_PEER_GOSSIP_INTRALOOP_SLEEP_DURATION="0s"
readonly CONFIGTOML_CONSENSUS_PEER_QUERY_MAJ23_SLEEP_DURATION="2s"

# Storage Configuration
readonly CONFIGTOML_STORAGE_DISCARD_ABCI_RESPONSES=true
readonly CONFIGTOML_STORAGE_EXPERIMENTAL_DB_KEY_LAYOUT="v1"
readonly CONFIGTOML_STORAGE_COMPACT=false
readonly CONFIGTOML_STORAGE_COMPACTION_INTERVAL="1000"
readonly CONFIGTOML_STORAGE_PRUNING_INTERVAL="10s"
readonly CONFIGTOML_STORAGE_PRUNING_DATA_COMPANION_ENABLED=false
readonly CONFIGTOML_STORAGE_PRUNING_DATA_COMPANION_INITIAL_BLOCK_RETAIN_HEIGHT=0
readonly CONFIGTOML_STORAGE_PRUNING_DATA_COMPANION_INITIAL_BLOCK_RESULTS_RETAIN_HEIGHT=0

# Transaction Indexer Configuration
readonly CONFIGTOML_TX_INDEX_INDEXER="null"
readonly CONFIGTOML_TX_INDEX_PSQL_CONN=""

# Instrumentation Configuration
readonly CONFIGTOML_INSTRUMENTATION_PROMETHEUS=true
readonly CONFIGTOML_INSTRUMENTATION_PROMETHEUS_LISTEN_ADDR=":26660"
readonly CONFIGTOML_INSTRUMENTATION_MAX_OPEN_CONNECTIONS=800
readonly CONFIGTOML_INSTRUMENTATION_NAMESPACE="cometbft"


# =============================================================================
# logging
# Source: lib/logging.sh
# =============================================================================

if [[ -t 1 ]] && [[ "${TERM:-}" != "dumb" ]]; then
	# Terminal supports colors - enable ANSI escape codes
	readonly RED='\033[0;31m'
	readonly GREEN='\033[0;32m'
	readonly YELLOW='\033[0;33m'
	readonly BLUE='\033[0;34m'
	readonly BOLD='\033[1m'
	readonly DIM='\033[2m'
	readonly RESET='\033[0m'
else
	# Non-interactive or unsupported terminal - disable colors
	readonly RED=''
	readonly GREEN=''
	readonly YELLOW=''
	readonly BLUE=''
	readonly BOLD=''
	readonly DIM=''
	readonly RESET=''
fi

# =============================================================================
# [2] PRINT_HEADER - Section Header Formatter
# =============================================================================
#
# FUNCTION:     print_header
# PURPOSE:      Displays a formatted section header with separator line
# PARAMETERS:   $* - Header text (all arguments concatenated)
# OUTPUT:       Stdout
# DEBUG:        Traces when DEBUG_MODE=true
#
# DESCRIPTION:
#   Creates visually distinct section headers in the CLI output. Used to
#   separate major operations like "Node Initialization", "Starting Services",
#   "Configuration Validation", etc.
#
# EXAMPLE:
#   print_header "Beranode Configuration"
#
# OUTPUT:
#
#   Beranode Configuration
#   
#
# =============================================================================

print_header() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: print_header" >&2

	echo ""
	echo -e "${BOLD}$*${RESET}"
	echo -e "${DIM}$(printf '%.0s' {1..50})${RESET}"
}

# =============================================================================
# [3] LOG_INFO - Informational Messages
# =============================================================================
#
# FUNCTION:     log_info
# PURPOSE:      Display informational messages to the user
# PARAMETERS:   $* - Message text (all arguments concatenated)
# OUTPUT:       Stdout
# COLOR:        Blue [INFO] prefix
# DEBUG:        Traces when DEBUG_MODE=true
#
# DESCRIPTION:
#   Used for general informational messages that don't require user action.
#   Examples include progress updates, status information, and configuration
#   values being applied.
#
# EXAMPLE:
#   log_info "Detected 4 CPU cores, optimizing thread pool..."
#   log_info "Loading configuration from beranode.config"
#
# =============================================================================

log_info() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: log_info" >&2

	echo -e "${BLUE}[INFO]${RESET} $*"
}

# =============================================================================
# [4] LOG_SUCCESS - Success Confirmations
# =============================================================================
#
# FUNCTION:     log_success
# PURPOSE:      Display success messages for completed operations
# PARAMETERS:   $* - Message text (all arguments concatenated)
# OUTPUT:       Stdout
# COLOR:        Green [OK] prefix
# DEBUG:        Traces when DEBUG_MODE=true
#
# DESCRIPTION:
#   Confirms successful completion of operations. Used after critical steps
#   complete successfully, such as node startup, configuration validation,
#   service health checks, etc.
#
# EXAMPLE:
#   log_success "Node started successfully on port 8545"
#   log_success "All health checks passed"
#
# =============================================================================

log_success() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: log_success" >&2

	echo -e "${GREEN}[OK]${RESET} $*"
}

# =============================================================================
# [5] LOG_WARN - Warning Messages
# =============================================================================
#
# FUNCTION:     log_warn
# PURPOSE:      Display warning messages for non-critical issues
# PARAMETERS:   $* - Message text (all arguments concatenated)
# OUTPUT:       Stdout
# COLOR:        Yellow [WARN] prefix
# DEBUG:        Traces when DEBUG_MODE=true
#
# DESCRIPTION:
#   Alerts users to potential issues that don't prevent operation but may
#   require attention. Examples include deprecated options, suboptimal
#   configurations, resource constraints, or fallback behaviors.
#
# EXAMPLE:
#   log_warn "Port 8545 already in use, using 8645 instead"
#   log_warn "Running with default configuration (no beranode.config found)"
#
# =============================================================================

log_warn() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: log_warn" >&2

	echo -e "${YELLOW}[WARN]${RESET} $*"
}

# =============================================================================
# [6] LOG_ERROR - Error Messages
# =============================================================================
#
# FUNCTION:     log_error
# PURPOSE:      Display error messages for failures and critical issues
# PARAMETERS:   $* - Message text (all arguments concatenated)
# OUTPUT:       Stderr (error stream)
# COLOR:        Red [ERROR] prefix
# DEBUG:        Traces when DEBUG_MODE=true
#
# DESCRIPTION:
#   Communicates errors and failures to the user. These messages indicate
#   operations that could not complete successfully. Always outputs to stderr
#   to ensure proper error stream handling in scripts and logs.
#
# NOTE:
#   This function does NOT exit the script - it only displays the message.
#   The calling code is responsible for handling the error and determining
#   whether to exit, retry, or continue.
#
# EXAMPLE:
#   log_error "Failed to connect to execution layer at localhost:8551"
#   log_error "Invalid chain ID: expected 80087, got 80088"
#
# =============================================================================

log_error() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: log_error" >&2

	echo -e "${RED}[ERROR]${RESET} $*" >&2
}

# =============================================================================
# END OF LOGGING MODULE
# =============================================================================


# =============================================================================
# utils
# Source: lib/utils.sh
# =============================================================================

generate_random_name() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: generate_random_name" >&2

	# Word pools for name generation
	local adjectives=("happy" "quick" "silent" "wise" "brave" "fuzzy" "gentle" "shy" "fancy" "tiny" "giant" "strong")
	local actions=("run" "jump" "fly" "swim" "climb" "read" "hello" "goodbye" "sing" "whisper" "smile" "wink")
	local things=("tiger" "mountain" "river" "cloud" "forest" "moon" "star" "something" "echo" "flame" "ocean" "field")

	# Randomly select one word from each pool using RANDOM modulo array length
	local first="${adjectives[$((RANDOM % ${#adjectives[@]}))]}"
	local second="${actions[$((RANDOM % ${#actions[@]}))]}"
	local third="${things[$((RANDOM % ${#things[@]}))]}"

	# Return hyphen-separated combination
	echo "${first}-${second}-${third}"
}

# Removes all occurrences of a given string from a Bash array.
# Usage:
#   filtered_array=($(array_exclude_element seeds[@] "hello"))
# Parameters:
#   $1 - Name of the array variable (passed as "${array[@]}")
#   $2 - String value to exclude
# Returns:
#   Prints array elements (space-separated), excluding the specified value.
array_exclude_element() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: array_exclude_element" >&2

	local -a input_array
	local exclude_value
	local -a result=()

	# Read input: first arg is (name of) array by reference, second is value to exclude$1
	input_array=("${!1}")
	exclude_value="$2"

	for item in "${input_array[@]}"; do
		if [[ "$item" != "$exclude_value" ]]; then
			result+=("$item")
		fi
	done

	# Return new array (as array, not as string)
	echo "${result[@]}"
}

format_csv_as_string() {
	local origins="$1"
	local result=""
	IFS=',' read -ra origins_array <<<"$origins"
	for origin in "${origins_array[@]}"; do
		origin_trimmed="$(echo "$origin" | xargs)"
		if [ -n "$origin_trimmed" ]; then
			if [ -z "$result" ]; then
				result="\"$origin_trimmed\""
			else
				result="$result,\"$origin_trimmed\""
			fi
		fi
	done
	echo "$result"
}

################################################################################
# 2. EVM KEY OPERATIONS
################################################################################

# Generates a new EVM wallet private key using Foundry's 'cast' tool.
# The private key is a 64-character hexadecimal string (with optional 0x prefix).
#
# Dependencies:
#   - Requires 'cast' from Foundry toolkit to be installed and in PATH
#
# Returns:
#   Private key (64 hex chars) on success
#   Exit code 1 on failure
generate_evm_private_key() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: generate_evm_private_key" >&2

	# Use 'cast wallet new' to generate a new wallet and extract the private key
	# Format: "Private key: 0x..." - we parse this with awk and xargs to trim
	local private_key=$(cast wallet new 2>/dev/null | awk -F': ' '/Private key:/ {print $2}' | xargs)

	# Validate that key generation succeeded and returned a non-empty value
	if [[ $? -ne 0 || -z "$private_key" ]]; then
		log_error "Failed to generate EVM private key using cast."
		return 1
	fi

	echo "$private_key"
}

# Derives the EVM wallet address from a given private key using 'cast'.
# The address is computed using standard Ethereum cryptographic operations.
#
# Parameters:
#   $1 - Private key (64 hex chars, with or without 0x prefix)
#
# Returns:
#   EVM address (0x-prefixed, 40 hex chars) on success
#   Exit code 1 on failure
get_evm_address_from_private_key() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: get_evm_address_from_private_key" >&2

	local priv_key="$1"

	# Use 'cast wallet address' to derive the public address from the private key
	local address=$(cast wallet address --private-key "$priv_key" 2>/dev/null)

	# Validate that address derivation succeeded and returned a non-empty value
	if [[ $? -ne 0 || -z "$address" ]]; then
		log_error "Failed to compute EVM address from private key using cast."
		return 1
	fi

	echo "$address"
}

################################################################################
# 3. VERSION CHECKING
################################################################################

# Validates that 'cast' from Foundry is installed and meets minimum version.
# Compares the installed version against SUPPORTED_CAST_VERSION from constants.
#
# Uses semver comparison logic to handle version numbers like "1.2.3".
# Strips any suffix like "-nightly" before comparison.
#
# Dependencies:
#   - Requires 'cast' command to be available in PATH
#   - Requires SUPPORTED_CAST_VERSION to be set in constants
#
# Returns:
#   Exit code 0 if version requirement is met
#   Exit code 1 if cast is not installed or version is insufficient
check_cast_version() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: check_cast_version" >&2

	# First, verify that 'cast' command exists in PATH
	if ! command -v cast >/dev/null 2>&1; then
		log_error "'cast' (from Foundry) is not installed or not in PATH."
		return 1
	fi

	# Extract version from 'cast --version' output
	# Example output: "cast v0.6.0 (abc123 2024-01-01T00:00:00Z)"
	# We extract the 3rd field and strip any suffix like "-nightly"
	cast_version_raw="$(cast --version 2>/dev/null | head -n1 | awk '{print $3}')"
	cast_version="${cast_version_raw%%-*}" # Strip suffix: "1.2.3-nightly" -> "1.2.3"
	required_version="${SUPPORTED_CAST_VERSION}"

	# 
	# Nested function: Semantic version comparison (>= check)
	# 
	# Compares two semver strings (e.g., "1.2.3" vs "1.2.0")
	# Returns 0 (success) if version1 >= version2, 1 otherwise
	version_ge() {
		# Quick check: if versions are identical, return success immediately
		[ "$1" = "$2" ] && return 0

		local IFS=. # Split on dots
		local i ver1=($1) ver2=($2)

		# Normalize arrays: fill shorter array with zeros
		for ((i = ${#ver1[@]}; i < ${#ver2[@]}; i++)); do
			ver1[i]=0
		done

		# Compare each version component (major, minor, patch, etc.)
		for ((i = 0; i < ${#ver1[@]}; i++)); do
			[[ -z ${ver2[i]} ]] && ver2[i]=0

			# Use base-10 notation (10#) to avoid octal interpretation
			if ((10#${ver1[i]} > 10#${ver2[i]})); then
				return 0 # ver1 is greater
			elif ((10#${ver1[i]} < 10#${ver2[i]})); then
				return 1 # ver1 is less
			fi
			# If equal, continue to next component
		done

		return 0 # All components equal, so ver1 >= ver2
	}

	# Perform version comparison and return result
	if version_ge "$cast_version" "$required_version"; then
		log_success "Found 'cast' version $cast_version (required >= $required_version)"
		return 0
	else
		log_error "'cast' version $cast_version is less than required $required_version"
		return 1
	fi
}

check_curl_version() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: check_curl_version" >&2

	# First, verify that 'curl' command exists in PATH
	if ! command -v curl >/dev/null 2>&1; then
		log_error "'curl' is not installed or not in PATH."
		return 1
	fi
}

check_tar_gz_version() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: check_tar_gz_version" >&2

	# First, verify that 'tar' command exists in PATH
	if ! command -v tar >/dev/null 2>&1; then
		log_error "'tar' is not installed or not in PATH."
		return 1
	fi
}

################################################################################
# 4. DIRECTORY MANAGEMENT
################################################################################

# Ensures a directory exists, creating it if necessary (including parent directories).
# Provides user-friendly logging with custom descriptions for each directory.
#
# Parameters:
#   $1 - dir_path:    Absolute or relative path to the directory
#   $2 - description: Human-readable description for logging (e.g., "data directory")
#
# Returns:
#   Exit code 0 if directory exists or was created successfully
#   Exit code 1 if path is empty or directory creation fails
ensure_dir_exists() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: ensure_dir_exists" >&2

	local dir_path="$1"
	local description="$2"

	# Validate that a directory path was provided
	if [[ -z "${dir_path}" ]]; then
		log_error "${description} path is not set."
		return 1
	fi

	# Check if directory already exists
	if [[ ! -d "${dir_path}" ]]; then
		log_info "Creating ${description}: ${dir_path}"

		# Create directory with parent directories (-p flag)
		mkdir -p "${dir_path}"

		# Verify creation succeeded
		if [[ $? -ne 0 ]]; then
			log_error "Failed to create ${description}: ${dir_path}"
			return 1
		fi

		log_success "${description} created: ${dir_path}"
	fi

	# Confirm directory exists (either pre-existing or just created)
	log_info "${description} exists: ${dir_path}"
}


# =============================================================================
# validation
# Source: lib/validation.sh
# =============================================================================

: "${DEBUG_MODE:=false}"
#
# This module provides validation functions for beranodes.config.json fields
# using regex patterns to ensure correct formatting and data integrity.
#
# LEGEND - Function Reference by Section:
# 
# 1. REGEX VALIDATORS
#     validate_string()               : Validate non-empty string
#     validate_boolean()              : Validate true/false boolean string
#     validate_integer()              : Validate integer number
#     validate_port()                 : Validate port number (1-65535)
#     validate_hex_address()          : Validate Ethereum address (0x + 40 hex)
#     validate_hex_private_key()      : Validate private key (0x + 64 hex)
#     validate_hex_string()           : Validate generic hex string with 0x
#     validate_jwt()                  : Validate JWT token (0x + 64 hex)
#     validate_path()                 : Validate file/directory path
#     validate_url()                  : Validate URL (http/tcp/ws)
#     validate_duration()             : Validate time duration (e.g., 5m0s, 10s)
#     validate_network()              : Validate network name (devnet, testnet, mainnet)
#     validate_moniker()              : Validate node moniker
#     validate_pubkey()               : Validate BLS public key
#
# 2. FIELD-SPECIFIC VALIDATORS
#     validate_node_object()          : Validate individual node configuration
#     validate_deposit_object()       : Validate genesis deposit object
#     validate_config_field()         : Validate a specific config field by name
#
# 3. MAIN VALIDATION
#     validate_beranodes_config()     : Validate entire beranodes.config.json
#
################################################################################

################################################################################
# 1. REGEX VALIDATORS
################################################################################

# Validates a non-empty string
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_string() {
	local value="$1"
	[[ -n "$value" ]]
}

# Validates a boolean string (true or false)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_boolean() {
	local value="$1"
	[[ "$value" =~ ^(true|false)$ ]]
}

# Validates an integer number
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_integer() {
	local value="$1"
	[[ "$value" =~ ^[0-9]+$ ]]
}

# Validates a port number (1-65535)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_port() {
	local value="$1"
	if [[ "$value" =~ ^[0-9]+$ ]]; then
		((value > 0 && value <= 65535))
	else
		return 1
	fi
}

# Validates an Ethereum address (0x followed by 40 hex characters)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_hex_address() {
	local value="$1"
	[[ "$value" =~ ^0x[0-9a-fA-F]{40}$ ]]
}

# Validates a private key (0x followed by 64 hex characters)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_hex_private_key() {
	local value="$1"
	[[ "$value" =~ ^0x[0-9a-fA-F]{64}$ ]]
}

# Validates a generic hex string with 0x prefix
# Parameters: $1 - value to validate, $2 - expected length (optional)
# Returns: 0 if valid, 1 if invalid
validate_hex_string() {
	local value="$1"
	local expected_length="${2:-}"

	if [[ -n "$expected_length" ]]; then
		[[ "$value" =~ ^0x[0-9a-fA-F]{${expected_length}}$ ]]
	else
		[[ "$value" =~ ^0x[0-9a-fA-F]+$ ]]
	fi
}

# Validates a JWT token (0x followed by 64 hex characters)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_jwt() {
	local value="$1"
	[[ "$value" =~ ^0x[0-9a-fA-F]{64}$ ]]
}

# Validates a file or directory path (absolute or relative)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_path() {
	local value="$1"
	# Path must be non-empty and not contain null bytes
	[[ -n "$value" && ! "$value" =~ $'\0' ]]
}

# Validates a URL (http, https, tcp, ws, wss)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_url() {
	local value="$1"
	[[ "$value" =~ ^(http|https|tcp|ws|wss)://.*$ ]]
}

# Validates a time duration (e.g., 5m0s, 10s, 1h30m, 0s)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_duration() {
	local value="$1"
	[[ "$value" =~ ^[0-9]+(h|m|s|ms|us|ns)([0-9]+(h|m|s|ms|us|ns))*$ || "$value" == "0s" || "$value" == "0" ]]
}

# Validates network name (devnet, testnet, mainnet, or custom)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_network() {
	local value="$1"
	[[ "$value" =~ ^[a-zA-Z0-9_-]+$ ]]
}

# Validates a node moniker (alphanumeric with hyphens, underscores)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_moniker() {
	local value="$1"
	[[ "$value" =~ ^[a-zA-Z0-9_-]+$ && ${#value} -ge 3 && ${#value} -le 64 ]]
}

# Validates a BLS public key (0x followed by 96 hex characters)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_pubkey() {
	local value="$1"
	[[ "$value" =~ ^0x[0-9a-fA-F]{96}$ ]]
}

# Validates a base64 string
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_base64() {
	local value="$1"
	[[ "$value" =~ ^[A-Za-z0-9+/]+=*$ ]]
}

# Validates a CometBFT address (uppercase hex, 40 chars)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_comet_address() {
	local value="$1"
	[[ "$value" =~ ^[0-9A-F]{40}$ ]]
}

# Validates mode (local, dev, testnet, mainnet)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_mode() {
	local value="$1"
	[[ "$value" =~ ^(local|dev|testnet|mainnet)$ ]]
}

# Validates role (validator, full_node, pruned_node)
# Parameters: $1 - value to validate
# Returns: 0 if valid, 1 if invalid
validate_role() {
	local value="$1"
	[[ "$value" =~ ^(validator|full_node|pruned_node)$ ]]
}

################################################################################
# 2. FIELD-SPECIFIC VALIDATORS
################################################################################

# Validates an individual node object
# Parameters: $1 - JSON node object string
# Returns: 0 if valid, 1 if invalid (sets $VALIDATION_ERROR on failure)
validate_node_object() {
	local node_json="$1"
	local errors=()

	# Extract and validate fields
	local role=$(echo "$node_json" | jq -r '.role')
	local moniker=$(echo "$node_json" | jq -r '.moniker')
	local network=$(echo "$node_json" | jq -r '.network')
	local wallet_address=$(echo "$node_json" | jq -r '.wallet_address')
	local ethrpc_port=$(echo "$node_json" | jq -r '.ethrpc_port')
	local jwt=$(echo "$node_json" | jq -r '.beacond_config.jwt')
	local comet_address=$(echo "$node_json" | jq -r '.beacond_config.comet_address')
	local comet_pubkey=$(echo "$node_json" | jq -r '.beacond_config.comet_pubkey')
	local eth_beacon_pubkey=$(echo "$node_json" | jq -r '.beacond_config.eth_beacon_pubkey')

	validate_role "$role" || errors+=("Invalid role: $role")
	validate_moniker "$moniker" || errors+=("Invalid moniker: $moniker")
	validate_network "$network" || errors+=("Invalid network: $network")
	[[ -z "$wallet_address" ]] || validate_hex_address "$wallet_address" || errors+=("Invalid wallet_address: $wallet_address")
	validate_port "$ethrpc_port" || errors+=("Invalid ethrpc_port: $ethrpc_port")
	validate_jwt "$jwt" || errors+=("Invalid jwt: $jwt")
	validate_comet_address "$comet_address" || errors+=("Invalid comet_address: $comet_address")
	validate_pubkey "$eth_beacon_pubkey" || errors+=("Invalid eth_beacon_pubkey: $eth_beacon_pubkey")

	if [[ ${#errors[@]} -gt 0 ]]; then
		VALIDATION_ERROR="${errors[*]}"
		return 1
	fi
	return 0
}

# Validates a genesis deposit object
# Parameters: $1 - JSON deposit object string
# Returns: 0 if valid, 1 if invalid (sets $VALIDATION_ERROR on failure)
validate_deposit_object() {
	local deposit_json="$1"
	local errors=()

	local pubkey=$(echo "$deposit_json" | jq -r '.pubkey')
	local credentials=$(echo "$deposit_json" | jq -r '.credentials')
	local amount=$(echo "$deposit_json" | jq -r '.amount')
	local signature=$(echo "$deposit_json" | jq -r '.signature')
	local index=$(echo "$deposit_json" | jq -r '.index')

	validate_pubkey "$pubkey" || errors+=("Invalid pubkey: $pubkey")
	validate_hex_string "$credentials" || errors+=("Invalid credentials: $credentials")
	validate_hex_string "$amount" || errors+=("Invalid amount: $amount")
	validate_hex_string "$signature" || errors+=("Invalid signature: $signature")
	validate_integer "$index" || errors+=("Invalid index: $index")

	if [[ ${#errors[@]} -gt 0 ]]; then
		VALIDATION_ERROR="${errors[*]}"
		return 1
	fi
	return 0
}

# Validates a specific config field by name and value
# Parameters: $1 - field name, $2 - field value
# Returns: 0 if valid, 1 if invalid
validate_config_field() {
	local field="$1"
	local value="$2"

	case "$field" in
	# Empty strings or simple strings allowed for optional fields (check first!)
	*_keyring_default_keyname | *_graffiti | *_cors_* | *_wal_dir | *_external_address | *_seeds | *_persistent_peers | *_global_labels | *_metrics_sink | *_statsd_addr | *_chain_spec_file | *_priv_validator_laddr | *_tls_*_file | *_pprof_laddr | *_grpc_*_laddr | *_unconditional_peer_ids | *_private_peer_ids | *_rpc_servers | *_trust_hash | *_temp_dir | *_psql_conn | *_grpc_address)
		return 0
		;;

	# Boolean fields (must be specific!)
	skip_genesis | force | *_enabled | *_strict | *_unsafe | *_close_on_slow_client | *_keep_invalid_txs_in_cache | *_inter_block_cache | *_cache | *_broadcast | *_recheck | *_pex | *_seed_mode | *_disable_fastnode | *_addr_book_strict | *_allow_duplicate_ip | *_logging | apptoml_telemetry_enabled | apptoml_telemetry_enable_hostname | apptoml_telemetry_enable_hostname_label | apptoml_telemetry_enable_service_label | *_skip_timeout_commit | *_create_empty_blocks | *_discard_abci_responses | *_compact | configtoml_instrumentation_prometheus | configtoml_statesync_enable | configtoml_rpc_unsafe | configtoml_filter_peers | *_pruning_*_enabled | *_service_enabled)
		validate_boolean "$value"
		;;

	# Top-level fields
	moniker | configtoml_moniker) validate_moniker "$value" ;;
	network | apptoml_beacon_kit_chain_spec) validate_network "$value" ;;
	validators | full_nodes | pruned_nodes | total_nodes) validate_integer "$value" ;;
	beranode_dir | genesis_file | genesis_eth_file | *_path | *_file | *_dir) validate_path "$value" ;;
	mode) validate_mode "$value" ;;
	wallet_private_key) validate_hex_private_key "$value" ;;
	wallet_address)
		[[ -z "$value" ]] || validate_hex_address "$value"
		;;
	wallet_balance | deposit_amount) validate_hex_string "$value" || validate_integer "$value" ;;
	validator_root) validate_hex_string "$value" ;;
	*_suggested_fee_recipient) validate_hex_address "$value" ;;

	# Port fields (more specific than _address patterns)
	*_port | *ethrpc_port | *ethp2p_port | *ethproxy_port | *authrpc_port | *eth_port | *prometheus_port)
		validate_port "$value"
		;;

	# URL/Address fields (allow PORT_DEFINED_BY_NODE placeholder)
	*_dial_url | *_laddr | *_address)
		[[ "$value" =~ \<PORT_DEFINED_BY_NODE\> ]] || [[ -z "$value" ]] || validate_url "$value" || [[ "$value" =~ ^[0-9.:] ]] || return 0
		;;

	# Duration fields (specific timeout/interval/period patterns)
	*_timeout | *_period | apptoml_beacon_kit_shutdown_timeout | apptoml_beacon_kit_engine_rpc_* | apptoml_beacon_kit_payload_builder_payload_timeout | configtoml_p2p_persistent_peers_max_dial_period | configtoml_p2p_flush_throttle_timeout | configtoml_p2p_handshake_timeout | configtoml_p2p_dial_timeout | configtoml_mempool_recheck_timeout | configtoml_statesync_trust_period | configtoml_statesync_discovery_time | configtoml_statesync_chunk_request_timeout | configtoml_consensus_timeout_* | configtoml_consensus_peer_*_duration | configtoml_storage_pruning_interval)
		validate_duration "$value"
		;;

	# Integer interval/window fields (after duration patterns)
	configtoml_storage_compaction_interval | apptoml_pruning_interval | *_pruning_keep_recent | *_availability_window)
		validate_integer "$value"
		;;

	# Chain ID
	*chain_id) validate_string "$value" ;;

	# Integer configuration values
	*_height | *_retain_* | *_max_* | *_keep_* | apptoml_halt_* | apptoml_min_* | apptoml_iavl_cache_size | apptoml_telemetry_prometheus_retention_time | configtoml_*_buffer_size | configtoml_*_batch_size | configtoml_*_body_bytes | configtoml_*_header_bytes | configtoml_mempool_size | configtoml_mempool_max_tx_bytes | configtoml_mempool_max_txs_bytes | configtoml_mempool_cache_size | configtoml_mempool_experimental_* | configtoml_storage_compaction_interval | configtoml_*_send_rate | configtoml_*_recv_rate | configtoml_*_num_*_peers | configtoml_*_packet_* | configtoml_instrumentation_max_open_connections | configtoml_statesync_trust_height | configtoml_statesync_chunk_fetchers | configtoml_consensus_double_sign_check_height | configtoml_*_pruning_*_retain_height)
		validate_integer "$value"
		;;

	# Backend/type/implementation strings
	*_backend | *_db_backend | *_type | *_implementation | *_indexer | *_abci) validate_string "$value" ;;

	# Versions
	*_version) validate_string "$value" ;;

	# Log levels, formats, styles, names, hostnames
	*_log_level | *_log_format | *_style | *_output | *_time_format | *_service_name | apptoml_telemetry_datadog_hostname | *_namespace | *_experimental_db_key_layout) validate_string "$value" ;;

	# Default: non-empty string
	*) validate_string "$value" ;;
	esac
}

################################################################################
# 3. MAIN VALIDATION
################################################################################

# Validates the entire beranodes.config.json file
# Parameters: $1 - path to beranodes.config.json
# Returns: 0 if all validations pass, 1 if any fail
# Output: Prints validation errors to stderr
validate_beranodes_config() {
	local config_file="$1"
	local validation_errors=0

	# Check if file exists
	if [[ ! -f "$config_file" ]]; then
		echo "ERROR: Config file not found: $config_file" >&2
		return 1
	fi

	# Check if file is valid JSON
	if ! jq empty "$config_file" 2>/dev/null; then
		echo "ERROR: Invalid JSON in config file: $config_file" >&2
		return 1
	fi

	echo "Validating beranodes configuration: $config_file"

	# Read all top-level fields
	local fields=$(jq -r 'to_entries | .[] | select(.value | type != "array" and type != "object") | "\(.key)=\(.value)"' "$config_file")

	# Validate each field
	while IFS='=' read -r field value; do
		if ! validate_config_field "$field" "$value"; then
			echo "   Field '$field' failed validation: '$value'" >&2
			((validation_errors++))
		fi
	done <<<"$fields"

	# Validate nodes array
	local nodes_count=$(jq '.nodes | length' "$config_file")
	for ((i = 0; i < nodes_count; i++)); do
		local node=$(jq ".nodes[$i]" "$config_file")
		if ! validate_node_object "$node"; then
			echo "   Node $i validation failed: $VALIDATION_ERROR" >&2
			((validation_errors++))
		fi
	done

	# Validate genesis_deposits array
	local deposits_count=$(jq '.genesis_deposits | length' "$config_file")
	for ((i = 0; i < deposits_count; i++)); do
		local deposit=$(jq ".genesis_deposits[$i]" "$config_file")
		if ! validate_deposit_object "$deposit"; then
			echo "   Genesis deposit $i validation failed: $VALIDATION_ERROR" >&2
			((validation_errors++))
		fi
	done

	# Summary
	if [[ $validation_errors -eq 0 ]]; then
		echo " All validations passed successfully"
		return 0
	else
		echo " Validation failed with $validation_errors error(s)" >&2
		return 1
	fi
}

################################################################################
# EXPORT FUNCTIONS
################################################################################

# Export all validation functions for use in other scripts
export -f validate_string
export -f validate_boolean
export -f validate_integer
export -f validate_port
export -f validate_hex_address
export -f validate_hex_private_key
export -f validate_hex_string
export -f validate_jwt
export -f validate_path
export -f validate_url
export -f validate_duration
export -f validate_network
export -f validate_moniker
export -f validate_pubkey
export -f validate_base64
export -f validate_comet_address
export -f validate_mode
export -f validate_role
export -f validate_node_object
export -f validate_deposit_object
export -f validate_config_field
export -f validate_beranodes_config


# =============================================================================
# genesis
# Source: lib/genesis.sh
# =============================================================================

generate_eth_genesis_file() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: generate_eth_genesis_file" >&2

	# -------------------------------------------------------------------------
	# Section 1.1: Chain Identity Configuration
	# -------------------------------------------------------------------------
	# Chain ID uniquely identifies this blockchain network for transaction
	# signing (EIP-155) to prevent replay attacks across different networks.
	#
	# Network Chain IDs:
	#   - 80087: Berachain devnet (default)
	#   - 80069: Berachain bepolia testnet
	#   - 80094: Berachain mainnet
	# -------------------------------------------------------------------------
	local config_dir="${BERANODES_PATH_DEFAULT}"
	local genesis_file_path="${BERANODES_PATH_DEFAULT}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}"
	local chain_id="$CHAIN_ID_DEVNET" # Default: Berachain devnet chain ID
	local chain_id_beacond="${CHAIN_NAME_DEVNET}-beacon-${CHAIN_ID_DEVNET}"

	# -------------------------------------------------------------------------
	# Section 1.2: Ethereum Hard Fork Activation Blocks
	# -------------------------------------------------------------------------
	# These parameters specify at which block number each Ethereum hard fork
	# activates. Setting all values to "0" means all upgrades are active from
	# the genesis block, which is standard practice for new EVM-compatible
	# chains that want full Ethereum compatibility from launch.
	#
	# Historical Context:
	# - Block-based forks: Homestead through Merge (pre-PoS upgrades)
	# - Time-based forks: Shanghai onwards (post-Merge, PoS upgrades)
	# -------------------------------------------------------------------------

	# Homestead (March 2016): Early protocol improvements
	# - EIP-2: Homestead gas cost changes
	# - EIP-7: DELEGATECALL opcode
	# - EIP-8: devp2p forward compatibility
	local eth_genesis_homestead_block="0"

	# DAO Fork (July 2016): Response to the DAO hack
	# daoForkSupport=true means we follow the forked chain (like mainnet Ethereum)
	local eth_genesis_dao_fork_block="0"
	local eth_genesis_dao_fork_support="true"

	# Tangerine Whistle / EIP-150 (October 2016)
	# Gas cost increases for IO-heavy operations to prevent DoS attacks
	local eth_genesis_eip150_block="0"

	# Spurious Dragon (November 2016)
	# - EIP-155: Replay attack protection using chain ID in tx signatures
	# - EIP-158: State clearing, account nonce rules
	local eth_genesis_eip155_block="0"
	local eth_genesis_eip158_block="0"

	# Byzantium (October 2017): Major upgrade including
	# - REVERT opcode, STATICCALL, precompiled contracts for zkSNARKs
	local eth_genesis_byzantium_block="0"

	# Constantinople (February 2019): Gas optimizations
	# - Bitwise shifting, CREATE2, EXTCODEHASH
	local eth_genesis_constantinople_block="0"

	# Petersburg (February 2019): Removed EIP-1283 due to reentrancy concerns
	local eth_genesis_petersburg_block="0"

	# Istanbul (December 2019): Gas repricing, new precompiles
	local eth_genesis_istanbul_block="0"

	# Muir Glacier (January 2020): Difficulty bomb delay
	local eth_genesis_muir_glacier_block="0"

	# Berlin (April 2021): Gas cost changes, access lists (EIP-2929, EIP-2930)
	local eth_genesis_berlin_block="0"

	# London (August 2021): EIP-1559 fee market, BASEFEE opcode
	local eth_genesis_london_block="0"

	# Arrow Glacier (December 2021): Difficulty bomb delay
	local eth_genesis_arrow_glacier_block="0"

	# Gray Glacier (June 2022): Final difficulty bomb delay before The Merge
	local eth_genesis_gray_glacier_block="0"

	# Merge Netsplit Block: The Merge transition (PoW -> PoS)
	local eth_genesis_merge_netsplit_block="0"

	# -------------------------------------------------------------------------
	# Section 1.3: Time-Based Fork Activation (Post-Merge)
	# -------------------------------------------------------------------------
	# Post-Merge Ethereum upgrades use Unix timestamps instead of block numbers.
	# Timestamp 0 = active from genesis block.
	# -------------------------------------------------------------------------

	# Shanghai (April 2023): Beacon chain withdrawals, warm COINBASE, PUSH0 opcode
	local eth_genesis_shanghai_time="0"

	# Cancun (March 2024): Blob transactions (EIP-4844) for L2 data availability
	local eth_genesis_cancun_time="0"

	# Prague: Future Ethereum upgrade - customized for Berachain features
	# Unix timestamp: 1749056400 = Wednesday, June 4, 2025 1:00:00 PM UTC
	local eth_genesis_prague_time="0"

	# -------------------------------------------------------------------------
	# Section 1.4: Proof-of-Stake Configuration
	# -------------------------------------------------------------------------
	# Terminal Total Difficulty (TTD) determines when the chain transitions
	# from PoW to PoS. Setting TTD=0 means the chain starts as PoS from
	# genesis with no Proof-of-Work mining phase.
	# -------------------------------------------------------------------------
	local eth_genesis_terminal_total_difficulty="0"
	local eth_genesis_terminal_total_difficulty_passed="true"

	# -------------------------------------------------------------------------
	# Section 1.5: Blob Transaction Configuration (EIP-4844)
	# -------------------------------------------------------------------------
	# Blob transactions are large data chunks (up to 128KB each) used primarily
	# by Layer 2 rollups for data availability. These parameters control blob
	# gas pricing via a separate fee market from regular transaction gas.
	#
	# Fee Adjustment: Blob base fee adjusts using the formula:
	#   new_fee = old_fee * e^((actual-target)/update_fraction)
	# -------------------------------------------------------------------------

	# Target blobs per block (the "ideal" number for fee stability)
	local eth_genesis_blob_target="3"

	# Maximum blobs allowed per block
	local eth_genesis_blob_max="6"

	# Controls how quickly blob base fee adjusts to demand
	# Higher value = slower adjustment. Formula: new_fee = old_fee * e^((actual-target)/fraction)
	local eth_genesis_blob_base_fee_update_fraction="3338477"

	# -------------------------------------------------------------------------
	# Section 1.6: Berachain-Specific Configuration (Prague 1-N)
	# -------------------------------------------------------------------------
	# Berachain implements a series of Prague upgrades (Prague 1, 2, 3, etc.)
	# to introduce custom features while maintaining Ethereum compatibility.
	#
	# Key Features per Prague Upgrade:
	#   Prague 1: Base fee adjustments, POL distributor
	#   Prague 2: Minimum base fee modifications
	#   Prague 3: BEX vault integration, rescue address, blocked addresses
	#   Prague 4+: Future feature deployments
	#
	# These are configurable via flags: --prague1-time, --prague2-time, etc.
	# -------------------------------------------------------------------------
	local -a prague_times=()
	local -a prague_base_fee_change_denominator=()
	local -a prague_min_base_fee=()
	local -a prague_pol_distributor=()
	local -a prague_bex_vault=()
	local -a prague_rescue_address=()
	local -a prague_blocked_addresses=()

	# -------------------------------------------------------------------------
	# Section 1.7: Genesis Block Parameters
	# -------------------------------------------------------------------------
	# Initial parameters for the genesis block (block #0). These are standard
	# Ethereum genesis block fields that establish the chain's initial state.
	# -------------------------------------------------------------------------
	local genesis_coinbase_address="0x0000000000000000000000000000000000000000"
	local genesis_difficulty="0x01" # Minimal difficulty (PoS)
	local genesis_extra_data="0x0000000000000000000000000000000000000000000000000000000000000000"
	local genesis_gas_limit="0x1c9c380" # ~30M gas (decimal: 30,000,000)
	local genesis_nonce="0x1234"
	local genesis_mix_hash="0x0000000000000000000000000000000000000000000000000000000000000000"
	local genesis_parent_hash="0x0000000000000000000000000000000000000000000000000000000000000000"
	local genesis_timestamp="0"

	# -------------------------------------------------------------------------
	# Section 1.8: Pre-Deployed Smart Contract Configurations
	# -------------------------------------------------------------------------
	# Essential smart contracts deployed at genesis with deterministic addresses.
	# These contracts are available immediately without requiring separate
	# deployment transactions.
	#
	# Standard Contracts:
	#   - Beacon Roots (EIP-4788): Exposes beacon chain state to EVM
	#   - CREATE2 Deployer: Deterministic contract deployment factory
	#   - Multicall3: Batch multiple contract calls in a single transaction
	#   - Permit2: Universal token approval for improved UX
	#
	# Berachain-Specific Contracts:
	#   - WBERA: Wrapped BERA (native token) for ERC-20 compatibility
	#   - Beacon Deposit: Validator deposit contract for staking
	# -------------------------------------------------------------------------
	local eth_genesis_beacon_roots_address="$ETH_GENESIS_BEACON_ROOTS_ADDRESS"
	local eth_genesis_beacon_roots_code="$ETH_GENESIS_BEACON_ROOTS_CODE"
	local eth_genesis_beacon_roots_balance="$ETH_GENESIS_BEACON_ROOTS_BALANCE"
	local eth_genesis_beacon_roots_nonce="$ETH_GENESIS_BEACON_ROOTS_NONCE"
	local eth_genesis_create2_deployer_address="$ETH_GENESIS_CREATE2_DEPLOYER_ADDRESS"
	local eth_genesis_create2_deployer_code="$ETH_GENESIS_CREATE2_DEPLOYER_CODE"
	local eth_genesis_create2_deployer_balance="$ETH_GENESIS_CREATE2_DEPLOYER_BALANCE"
	local eth_genesis_create2_deployer_nonce="$ETH_GENESIS_CREATE2_DEPLOYER_NONCE"
	local eth_genesis_multicall3_address="$ETH_GENESIS_MULTICALL3_ADDRESS"
	local eth_genesis_multicall3_balance="$ETH_GENESIS_MULTICALL3_BALANCE"
	local eth_genesis_multicall3_nonce="$ETH_GENESIS_MULTICALL3_NONCE"
	local eth_genesis_multicall3_code="$ETH_GENESIS_MULTICALL3_CODE"
	local eth_genesis_wbera_address="$ETH_GENESIS_WBERA_ADDRESS"
	local eth_genesis_wbera_code="$ETH_GENESIS_WBERA_CODE"
	local eth_genesis_wbera_balance="$ETH_GENESIS_WBERA_BALANCE"
	local eth_genesis_wbera_nonce="$ETH_GENESIS_WBERA_NONCE"
	local eth_genesis_permit2_address="$ETH_GENESIS_PERMIT2_ADDRESS"
	local eth_genesis_permit2_code="$ETH_GENESIS_PERMIT2_CODE"
	local eth_genesis_permit2_balance="$ETH_GENESIS_PERMIT2_BALANCE"
	local eth_genesis_permit2_nonce="$ETH_GENESIS_PERMIT2_NONCE"
	local eth_genesis_beacon_deposit_address="$ETH_GENESIS_BEACON_DEPOSIT_ADDRESS"
	local eth_genesis_beacon_deposit_code="$ETH_GENESIS_BEACON_DEPOSIT_CODE"
	local eth_genesis_beacon_deposit_balance="$ETH_GENESIS_BEACON_DEPOSIT_BALANCE"
	local eth_genesis_beacon_deposit_nonce="$ETH_GENESIS_BEACON_DEPOSIT_NONCE"
	local eth_genesis_beacon_deposit_storage_key="$ETH_GENESIS_BEACON_DEPOSIT_STORAGE_KEY"
	local eth_genesis_beacon_deposit_storage_value="$ETH_GENESIS_BEACON_DEPOSIT_STORAGE_VALUE"

	# -------------------------------------------------------------------------
	# Section 1.9: Custom Contract Deployments
	# -------------------------------------------------------------------------
	# Allows deployment of user-defined contracts at genesis. Useful for
	# deploying protocol-specific contracts, governance systems, or test
	# fixtures. Each custom contract can have:
	#   - address: Deployment address
	#   - code: Contract bytecode
	#   - balance: Initial ETH/BERA balance
	#   - nonce: Initial nonce value
	#   - storage: Pre-initialized storage slots
	#
	# Usage: --eth-genesis-custom1-contract-address 0x123...
	# -------------------------------------------------------------------------
	local -a eth_genesis_custom_contract_address=()
	local -a eth_genesis_custom_contract_nonce=()
	local -a eth_genesis_custom_contract_code=()
	local -a eth_genesis_custom_contract_balance=()
	local -a eth_genesis_custom_contract_storage=()

	# -------------------------------------------------------------------------
	# Section 1.10: Genesis Account Allocations
	# -------------------------------------------------------------------------
	# Pre-fund accounts with initial BERA balances at genesis. Used for:
	#   - Developer accounts
	#   - Faucet addresses
	#   - Test wallets
	#   - Protocol treasury
	#
	# Format: address=balance (e.g., 0x123...=1000000000000000000)
	# -------------------------------------------------------------------------
	local eth_genesis_allocations=()

	# -------------------------------------------------------------------------
	# Section 1.11: Flag Parsing
	# -------------------------------------------------------------------------
	# Process command-line flags to override default configuration values.
	# Supports both simple flags (--chain-id) and complex array flags
	# (--prague1-time, --eth-genesis-custom*-...).
	# -------------------------------------------------------------------------
	while [[ $# -gt 0 ]]; do
		key="$1"
		case $key in
		--config-dir)
			config_dir="$2"
			if [[ ! -d "$config_dir" ]]; then
				config_dir="${BERANODES_PATH_DEFAULT}"
				genesis_file_path="${BERANODES_PATH_DEFAULT}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}"
				log_warn "Config directory not found at $config_dir, using default directory ${BERANODES_PATH_DEFAULT}"
			fi
			shift 2
			;;
		--chain-id)
			chain_id="$2"
			shift 2
			;;
		--homestead-block)
			eth_genesis_homestead_block="${2:-0}"
			shift 2
			;;
		--dao-fork-block)
			eth_genesis_dao_fork_block="${2:-0}"
			shift 2
			;;
		--dao-fork-support)
			eth_genesis_dao_fork_support="${2:-true}"
			shift 2
			;;
		--eip150-block)
			eth_genesis_eip150_block="${2:-0}"
			shift 2
			;;
		--eip155-block)
			eth_genesis_eip155_block="${2:-0}"
			shift 2
			;;
		--eip158-block)
			eth_genesis_eip158_block="${2:-0}"
			shift 2
			;;
		--byzantium-block)
			eth_genesis_byzantium_block="${2:-0}"
			shift 2
			;;
		--constantinople-block)
			eth_genesis_constantinople_block="${2:-0}"
			shift 2
			;;
		--petersburg-block)
			eth_genesis_petersburg_block="${2:-0}"
			shift 2
			;;
		--istanbul-block)
			eth_genesis_istanbul_block="${2:-0}"
			shift 2
			;;
		--muir-glacier-block)
			eth_genesis_muir_glacier_block="${2:-0}"
			shift 2
			;;
		--berlin-block)
			eth_genesis_berlin_block="${2:-0}"
			shift 2
			;;
		--london-block)
			eth_genesis_london_block="${2:-0}"
			shift 2
			;;
		--arrow-glacier-block)
			eth_genesis_arrow_glacier_block="${2:-0}"
			shift 2
			;;
		--gray-glacier-block)
			eth_genesis_gray_glacier_block="${2:-0}"
			shift 2
			;;
		--merge-netsplit-block)
			eth_genesis_merge_netsplit_block="${2:-0}"
			shift 2
			;;
		--shanghai-time)
			eth_genesis_shanghai_time="${2:-0}"
			shift 2
			;;
		--cancun-time)
			eth_genesis_cancun_time="${2:-0}"
			shift 2
			;;
		--prague-time)
			eth_genesis_prague_time="${2:-0}"
			shift 2
			;;
		--terminal-total-difficulty)
			eth_genesis_terminal_total_difficulty="${2:-0}"
			shift 2
			;;
		--terminal-total-difficulty-passed)
			eth_genesis_terminal_total_difficulty_passed="${2:-true}"
			shift 2
			;;
		--blob-target)
			eth_genesis_blob_target="${2:-3}"
			shift 2
			;;
		--blob-max)
			eth_genesis_blob_max="${2:-6}"
			shift 2
			;;
		--blob-base-fee-update-fraction)
			eth_genesis_blob_base_fee_update_fraction="${2:-3338477}"
			shift 2
			;;
		# Handle --pragueN-... flags generically for N in [1, 2, ...]
		--prague*-time)
			prague_epoch="${1#--prague}"
			prague_num="${prague_epoch%%-*}"
			prague_times[prague_num]="$2"
			shift 2
			;;
		--prague*-base-fee-change-denominator)
			prague_epoch="${1#--prague}"
			prague_num="${prague_epoch%%-*}"
			prague_base_fee_change_denominator[prague_num]="$2"
			shift 2
			;;
		--prague*-min-base-fee)
			prague_epoch="${1#--prague}"
			prague_num="${prague_epoch%%-*}"
			prague_min_base_fee[prague_num]="$2"
			shift 2
			;;
		--prague*-pol-distributor)
			prague_epoch="${1#--prague}"
			prague_num="${prague_epoch%%-*}"
			prague_pol_distributor[prague_num]="$2"
			shift 2
			;;
		--prague*-bex-vault)
			prague_epoch="${1#--prague}"
			prague_num="${prague_epoch%%-*}"
			prague_bex_vault[prague_num]="$2"
			shift 2
			;;
		--prague*-rescue-address)
			prague_epoch="${1#--prague}"
			prague_num="${prague_epoch%%-*}"
			prague_rescue_address[prague_num]="$2"
			shift 2
			;;
		--prague*-blocked-addresses)
			prague_epoch="${1#--prague}"
			prague_num="${prague_epoch%%-*}"
			IFS=',' read -ra addresses <<<"$2"

			valid_addresses=1
			formatted_addresses=()
			for addr in "${addresses[@]}"; do
				if [[ "$addr" =~ ^0x[0-9a-fA-F]+$ ]]; then
					formatted_addresses+=("$addr")
				else
					valid_addresses=0
					break
				fi
			done

			if [[ $valid_addresses -eq 1 ]]; then
				# Store as comma-separated values (as in original)
				prague_blocked_addresses[prague_num]=$(
					IFS=,
					echo "${formatted_addresses[*]}"
				)
			else
				log_error "Invalid format for $1: expected comma-separated 0x addresses, got '$2'"
				return 1
			fi
			shift 2
			;;
		--genesis-coinbase-address)
			genesis_coinbase_address="${2:-0x0000000000000000000000000000000000000000}"
			shift 2
			;;
		--genesis-difficulty)
			genesis_difficulty="${2:-0x01}"
			shift 2
			;;
		--genesis-extra-data)
			genesis_extra_data="${2:-0x0000000000000000000000000000000000000000000000000000000000000000}"
			shift 2
			;;
		--genesis-gas-limit)
			genesis_gas_limit="${2:-0x1c9c380}"
			shift 2
			;;
		--genesis-nonce)
			genesis_nonce="${2:-0x1234}"
			shift 2
			;;
		--genesis-mix-hash)
			genesis_mix_hash="${2:-0x0000000000000000000000000000000000000000000000000000000000000000}"
			shift 2
			;;
		--genesis-parent-hash)
			genesis_parent_hash="${2:-0x0000000000000000000000000000000000000000000000000000000000000000}"
			shift 2
			;;
		--genesis-timestamp)
			genesis_timestamp="${2:-0}"
			shift 2
			;;
		--eth-genesis-beacon-roots-address)
			eth_genesis_beacon_roots_address="${2:-$ETH_GENESIS_BEACON_ROOTS_ADDRESS}"
			shift 2
			;;
		--eth-genesis-beacon-roots-code)
			eth_genesis_beacon_roots_code="${2:-$ETH_GENESIS_BEACON_ROOTS_CODE}"
			shift 2
			;;
		--eth-genesis-beacon-roots-balance)
			eth_genesis_beacon_roots_balance="${2:-$ETH_GENESIS_BEACON_ROOTS_BALANCE}"
			shift 2
			;;
		--eth-genesis-beacon-roots-nonce)
			eth_genesis_beacon_roots_nonce="${2:-$ETH_GENESIS_BEACON_ROOTS_NONCE}"
			shift 2
			;;
		--eth-genesis-create2-deployer-address)
			eth_genesis_create2_deployer_address="${2:-$ETH_GENESIS_CREATE2_DEPLOYER_ADDRESS}"
			shift 2
			;;
		--eth-genesis-create2-deployer-code)
			eth_genesis_create2_deployer_code="${2:-$ETH_GENESIS_CREATE2_DEPLOYER_CODE}"
			shift 2
			;;
		--eth-genesis-create2-deployer-balance)
			eth_genesis_create2_deployer_balance="${2:-$ETH_GENESIS_CREATE2_DEPLOYER_BALANCE}"
			shift 2
			;;
		--eth-genesis-create2-deployer-nonce)
			eth_genesis_create2_deployer_nonce="${2:-$ETH_GENESIS_CREATE2_DEPLOYER_NONCE}"
			shift 2
			;;
		--eth-genesis-multicall3-address)
			eth_genesis_multicall3_address="${2:-$ETH_GENESIS_MULTICALL3_ADDRESS}"
			shift 2
			;;
		--eth-genesis-multicall3-code)
			eth_genesis_multicall3_code="${2:-$ETH_GENESIS_MULTICALL3_CODE}"
			shift 2
			;;
		--eth-genesis-multicall3-balance)
			eth_genesis_multicall3_balance="${2:-$ETH_GENESIS_MULTICALL3_BALANCE}"
			shift 2
			;;
		--eth-genesis-multicall3-nonce)
			eth_genesis_multicall3_nonce="${2:-$ETH_GENESIS_MULTICALL3_NONCE}"
			shift 2
			;;
		--eth-genesis-wbera-address)
			eth_genesis_wbera_address="${2:-$ETH_GENESIS_WBERA_ADDRESS}"
			shift 2
			;;
		--eth-genesis-wbera-code)
			eth_genesis_wbera_code="${2:-$ETH_GENESIS_WBERA_CODE}"
			shift 2
			;;
		--eth-genesis-wbera-balance)
			eth_genesis_wbera_balance="${2:-$ETH_GENESIS_WBERA_BALANCE}"
			shift 2
			;;
		--eth-genesis-wbera-nonce)
			eth_genesis_wbera_nonce="${2:-$ETH_GENESIS_WBERA_NONCE}"
			shift 2
			;;
		--eth-genesis-permit2-address)
			eth_genesis_permit2_address="${2:-$ETH_GENESIS_PERMIT2_ADDRESS}"
			shift 2
			;;
		--eth-genesis-permit2-code)
			eth_genesis_permit2_code="${2:-$ETH_GENESIS_PERMIT2_CODE}"
			shift 2
			;;
		--eth-genesis-permit2-balance)
			eth_genesis_permit2_balance="${2:-$ETH_GENESIS_PERMIT2_BALANCE}"
			shift 2
			;;
		--eth-genesis-permit2-nonce)
			eth_genesis_permit2_nonce="${2:-$ETH_GENESIS_PERMIT2_NONCE}"
			shift 2
			;;
		--eth-genesis-beacon-deposit-address)
			eth_genesis_beacon_deposit_address="${2:-$ETH_GENESIS_BEACON_DEPOSIT_ADDRESS}"
			shift 2
			;;
		--eth-genesis-beacon-deposit-code)
			eth_genesis_beacon_deposit_code="${2:-$ETH_GENESIS_BEACON_DEPOSIT_CODE}"
			shift 2
			;;
		--eth-genesis-beacon-deposit-balance)
			eth_genesis_beacon_deposit_balance="${2:-$ETH_GENESIS_BEACON_DEPOSIT_BALANCE}"
			shift 2
			;;
		--eth-genesis-beacon-deposit-nonce)
			eth_genesis_beacon_deposit_nonce="${2:-$ETH_GENESIS_BEACON_DEPOSIT_NONCE}"
			shift 2
			;;
		--eth-genesis-beacon-deposit-storage-key)
			# Accept an array of storage keys as a comma-separated string, and split into a Bash array
			IFS=',' read -ra eth_genesis_beacon_deposit_storage_key <<<"${2:-$(
				IFS=,
				echo "${ETH_GENESIS_BEACON_DEPOSIT_STORAGE_KEY[*]}"
			)}"
			shift 2
			;;
		--eth-genesis-beacon-deposit-storage-value)
			# Accept an array of storage values as a comma-separated string, and split into a Bash array
			IFS=',' read -ra eth_genesis_beacon_deposit_storage_value <<<"${2:-$(
				IFS=,
				echo "${ETH_GENESIS_BEACON_DEPOSIT_STORAGE_VALUE[*]}"
			)}"
			shift 2
			;;
		--eth-genesis-custom*-contract-address)
			# Extract the custom contract index from the flag (e.g., --eth-genesis-custom1-contract-address)
			# Valid flag pattern is --eth-genesis-custom<index>-contract-address
			index="${1#--eth-genesis-custom}"
			index="${index%-contract-address}"

			# Only process if the provided address starts with 0x01 (as a hex string)
			if [[ "${2}" == 0x* ]]; then
				eth_genesis_custom_contract_address[index]="${2}"
			fi
			shift 2
			;;
		--eth-genesis-custom*-contract-code)
			# Extract the custom contract index from the flag (e.g., --eth-genesis-custom1-contract-code)
			# Valid flag pattern is --eth-genesis-custom<index>-contract-code
			index="${1#--eth-genesis-custom}"
			index="${index%-contract-code}"

			# Only process if the provided code starts with 0x01 (as a hex string)
			if [[ "${2}" == 0x* ]]; then
				eth_genesis_custom_contract_code[index]="${2}"
			fi
			shift 2
			;;
		--eth-genesis-custom*-contract-balance)
			# Extract the custom contract index from the flag (e.g., --eth-genesis-custom1-contract-balance)
			# Valid flag pattern is --eth-genesis-custom<index>-contract-balance
			index="${1#--eth-genesis-custom}"
			index="${index%-contract-balance}"

			# Only process if the provided balance starts with 0x01 (as a hex string)
			eth_genesis_custom_contract_balance[index]="${2}"
			shift 2
			;;
		--eth-genesis-custom*-contract-nonce)
			# Extract the custom contract index from the flag (e.g., --eth-genesis-custom1-contract-nonce)
			# Valid flag pattern is --eth-genesis-custom<index>-contract-nonce
			index="${1#--eth-genesis-custom}"
			index="${index%-contract-nonce}"

			# Only process if the provided nonce starts with 0x01 (as a hex string)
			if [[ "${2}" == 0x* ]]; then
				eth_genesis_custom_contract_nonce[index]="${2}"
			fi
			shift 2
			;;
		--eth-genesis-custom*-contract-storage)
			# Extract the custom contract index from the flag (e.g., --eth-genesis-custom7-contract-storage)
			# Valid flag pattern is --eth-genesis-custom<index>-contract-storage
			index="${1#--eth-genesis-custom}"
			index="${index%-contract-storage}"

			# The value must be a comma-separated list of storage entries: 0xKEY=VALUE,...
			# We'll validate and transform this to a canonical format array
			storage_arg="$2"
			valid_format=1
			formatted_storage=""

			# Check the whole flag value for expected format: 0xKEY=VALUE,0xKEY2=VALUE2,...
			IFS=',' read -ra entries <<<"$storage_arg"
			for entry in "${entries[@]}"; do
				# Each entry must be of the form 0xKEY=VALUE
				if [[ "$entry" =~ ^0x[0-9a-fA-F]+=[0-9a-fA-Fx]+$ ]]; then
					# Format each pair as JSON-style string for later use if needed.
					[[ -n "$formatted_storage" ]] && formatted_storage+=","
					formatted_storage+="$entry"
				else
					valid_format=0
					break
				fi
			done

			if [[ $valid_format -eq 1 ]]; then
				eth_genesis_custom_contract_storage[index]="$formatted_storage"
			else
				log_error "Invalid format for $1: expected '0xKEY=VALUE[,0xKEY2=VALUE2...]' got '$2'"
				return 1
			fi
			shift 2
			;;
		--eth-genesis-allocations)
			# Accept one or more allocations of the form 0xADDR=VALUE[,0xADDR2=VALUE2...]
			# Handle both multiple and single value scenarios
			if [[ -n "${2-}" ]]; then
				IFS=',' read -ra eth_genesis_allocations <<<"$2"
			else
				# Fallback to ETH_GENESIS_ALLOCATIONS env or default
				IFS=',' read -ra eth_genesis_allocations <<<"${ETH_GENESIS_ALLOCATIONS[*]}"
			fi
			shift 2
			;;
		*)
			echo "Unknown flag: $1"
			shift
			;;
		esac
	done

	# Print first instance of eth_genesis_custom_contract_address if set
	if [[ ${#eth_genesis_custom_contract_address[@]} -gt 0 ]]; then
		echo "eth_genesis_custom_contract_address: ${eth_genesis_custom_contract_address[0]}"
	else
		echo "eth_genesis_custom_contract_address: (unset)"
	fi

	# Check for required arguments
	if [[ -z "$genesis_file_path" ]]; then
		log_error "Missing eth genesis file ${GENESIS_ETH_NAME_DEFAULT} at ${genesis_file_path}"
		return 1
	fi

	# -------------------------------------------------------------------------
	# Section 1.12: Helper Function - Build Berachain Config Section
	# -------------------------------------------------------------------------
	# Constructs the "berachain" section of the genesis JSON containing
	# Prague 1-N upgrade configurations. This is Berachain-specific and
	# not part of standard Ethereum genesis format.
	# -------------------------------------------------------------------------
	_eth_genesis_build_berachain_section() {
		local sections=()

		# Iterate over prague_times array (should be indexed by prague number)
		for i in "${!prague_times[@]}"; do
			# Only build for pragueN where time is set and non-empty
			if [[ -n "${prague_times[$i]}" ]]; then
				local section_lines=()
				local indent='            '

				# time
				if [[ -n "${prague_times[$i]}" ]]; then
					section_lines+=("${indent}\"time\": ${prague_times[$i]}")
				fi

				# baseFeeChangeDenominator
				if [[ -n "${prague_base_fee_change_denominator[$i]:-}" ]]; then
					section_lines+=("${indent}\"baseFeeChangeDenominator\": ${prague_base_fee_change_denominator[$i]}")
				fi

				# minimumBaseFeeWei
				if [[ -n "${prague_min_base_fee[$i]:-}" ]]; then
					section_lines+=("${indent}\"minimumBaseFeeWei\": ${prague_min_base_fee[$i]}")
				fi

				# polDistributorAddress
				if [[ -n "${prague_pol_distributor[$i]:-}" ]]; then
					section_lines+=("${indent}\"polDistributorAddress\": \"${prague_pol_distributor[$i]}\"")
				fi

				# bexVaultAddress
				if [[ -n "${prague_bex_vault[$i]:-}" ]]; then
					section_lines+=("${indent}\"bexVaultAddress\": \"${prague_bex_vault[$i]}\"")
				fi

				# rescueAddress
				if [[ -n "${prague_rescue_address[$i]:-}" ]]; then
					section_lines+=("${indent}\"rescueAddress\": \"${prague_rescue_address[$i]}\"")
				fi

				# blockedAddresses
				if [[ -n "${prague_blocked_addresses[$i]+set}" && -n "${prague_blocked_addresses[$i]}" ]]; then
					IFS=',' read -ra addresses <<<"${prague_blocked_addresses[$i]}"
					local formatted="[\n"
					local num_addresses=0
					for j in "${!addresses[@]}"; do
						local addr_trimmed="$(echo -n "${addresses[j]}" | xargs)"
						if [[ -n "$addr_trimmed" ]]; then
							((num_addresses > 0)) && formatted+=",\n"
							formatted+="                \"$addr_trimmed\""
							((num_addresses++))
						fi
					done
					formatted+="\n            ]"
					section_lines+=("${indent}\"blockedAddresses\": ${formatted}")
				fi

				# Build the section json with correct indentation (12 spaces for level 2, 8 for berachain line)
				local section="        \"prague${i}\": {\n"
				for j in "${!section_lines[@]}"; do
					section+="${section_lines[$j]}"
					[[ $j -lt $((${#section_lines[@]} - 1)) ]] && section+=",\n" || section+="\n"
				done
				section+="        }"
				sections+=("$section")
			fi
		done

		# Output all sections, comma-separated (with no trailing comma), add appropriate tabs
		local output=""
		for idx in "${!sections[@]}"; do
			[[ $idx -gt 0 ]] && output+=",\n"
			output+="${sections[$idx]}"
		done
		echo -e "$output"
	}

	# -------------------------------------------------------------------------
	# Section 1.13: Helper Function - Build Standard Contract Allocations
	# -------------------------------------------------------------------------
	# Constructs the "alloc" section for pre-deployed standard contracts:
	#   - Beacon Roots Contract
	#   - CREATE2 Deployer
	#   - Multicall3
	#   - WBERA (Wrapped BERA)
	#   - Permit2
	#   - Beacon Deposit Contract
	#
	# Each contract includes: address, balance, nonce, code, and optional storage
	# -------------------------------------------------------------------------
	_build_contracts_alloc() {
		# ! DO NOT add DEBUG_MODE here
		local contract_alloc_lines=()
		local indent='    '

		# beacon roots
		if [[ -n "${eth_genesis_beacon_roots_address}" ]]; then
			contract_alloc_lines+=("${indent}\"${eth_genesis_beacon_roots_address}\": {")
			contract_alloc_lines+=("${indent}  \"balance\": \"${eth_genesis_beacon_roots_balance}\",")
			contract_alloc_lines+=("${indent}  \"nonce\": \"${eth_genesis_beacon_roots_nonce}\",")
			contract_alloc_lines+=("${indent}  \"code\": \"${eth_genesis_beacon_roots_code}\"")
			if [[ -n "${eth_genesis_create2_deployer_address}" ]]; then
				contract_alloc_lines+=("${indent}},")
			else
				contract_alloc_lines+=("${indent}}")
			fi
		fi

		# create2 deployer
		if [[ -n "${eth_genesis_create2_deployer_address}" ]]; then
			contract_alloc_lines+=("${indent}\"${eth_genesis_create2_deployer_address}\": {")
			contract_alloc_lines+=("${indent}  \"balance\": \"${eth_genesis_create2_deployer_balance}\",")
			contract_alloc_lines+=("${indent}  \"nonce\": \"${eth_genesis_create2_deployer_nonce}\",")
			contract_alloc_lines+=("${indent}  \"code\": \"${eth_genesis_create2_deployer_code}\"")
			if [[ -n "${eth_genesis_multicall3_address}" ]]; then
				contract_alloc_lines+=("${indent}},")
			else
				contract_alloc_lines+=("${indent}}")
			fi
		fi

		# multicall3
		if [[ -n "${eth_genesis_multicall3_address}" ]]; then
			contract_alloc_lines+=("${indent}\"${eth_genesis_multicall3_address}\": {")
			contract_alloc_lines+=("${indent}  \"balance\": \"${eth_genesis_multicall3_balance}\",")
			contract_alloc_lines+=("${indent}  \"nonce\": \"${eth_genesis_multicall3_nonce}\",")
			contract_alloc_lines+=("${indent}  \"code\": \"${eth_genesis_multicall3_code}\"")
			if [[ -n "${eth_genesis_wbera_address}" ]]; then
				contract_alloc_lines+=("${indent}},")
			else
				contract_alloc_lines+=("${indent}}")
			fi
		fi

		# wbera
		if [[ -n "${eth_genesis_wbera_address}" ]]; then
			contract_alloc_lines+=("${indent}\"${eth_genesis_wbera_address}\": {")
			contract_alloc_lines+=("${indent}  \"balance\": \"${eth_genesis_wbera_balance}\",")
			contract_alloc_lines+=("${indent}  \"nonce\": \"${eth_genesis_wbera_nonce}\",")
			contract_alloc_lines+=("${indent}  \"code\": \"${eth_genesis_wbera_code}\"")
			if [[ -n "${eth_genesis_permit2_address}" ]]; then
				contract_alloc_lines+=("${indent}},")
			else
				contract_alloc_lines+=("${indent}}")
			fi
		fi

		# permit2
		if [[ -n "${eth_genesis_permit2_address}" ]]; then
			contract_alloc_lines+=("${indent}\"${eth_genesis_permit2_address}\": {")
			contract_alloc_lines+=("${indent}  \"balance\": \"${eth_genesis_permit2_balance}\",")
			contract_alloc_lines+=("${indent}  \"nonce\": \"${eth_genesis_permit2_nonce}\",")
			contract_alloc_lines+=("${indent}  \"code\": \"${eth_genesis_permit2_code}\"")
			if [[ -n "${eth_genesis_beacon_deposit_address}" ]]; then
				contract_alloc_lines+=("${indent}},")
			else
				contract_alloc_lines+=("${indent}}")
			fi
		fi

		# beacon deposit
		if [[ -n "${eth_genesis_beacon_deposit_address}" ]]; then
			contract_alloc_lines+=("${indent}\"${eth_genesis_beacon_deposit_address}\": {")
			contract_alloc_lines+=("${indent}  \"balance\": \"${eth_genesis_beacon_deposit_balance}\",")
			contract_alloc_lines+=("${indent}  \"nonce\": \"${eth_genesis_beacon_deposit_nonce}\",")
			if [[ -n "${eth_genesis_beacon_deposit_storage_key}" ]]; then
				contract_alloc_lines+=("${indent}  \"code\": \"${eth_genesis_beacon_deposit_code}\",")
				contract_alloc_lines+=("${indent}  \"storage\": {")
				# Split storage keys/values on comma if string contains ',' (to support "0x1,0x2" format)
				storage_keys=()
				storage_values=()
				if [[ "${#eth_genesis_beacon_deposit_storage_key[@]}" -eq 1 && "${eth_genesis_beacon_deposit_storage_key[0]}" == *,* ]]; then
					IFS=',' read -ra storage_keys <<<"${eth_genesis_beacon_deposit_storage_key[0]}"
				else
					storage_keys=("${eth_genesis_beacon_deposit_storage_key[@]}")
				fi
				if [[ "${#eth_genesis_beacon_deposit_storage_value[@]}" -eq 1 && "${eth_genesis_beacon_deposit_storage_value[0]}" == *,* ]]; then
					IFS=',' read -ra storage_values <<<"${eth_genesis_beacon_deposit_storage_value[0]}"
				else
					storage_values=("${eth_genesis_beacon_deposit_storage_value[@]}")
				fi

				storage_len=${#storage_keys[@]}
				for i in "${!storage_keys[@]}"; do
					if [[ $i -lt $((storage_len - 1)) ]]; then
						contract_alloc_lines+=("${indent}    \"${storage_keys[$i]}\": \"${storage_values[$i]}\",")
					else
						contract_alloc_lines+=("${indent}    \"${storage_keys[$i]}\": \"${storage_values[$i]}\"")
					fi
				done
				contract_alloc_lines+=("${indent}  }")
			else
				contract_alloc_lines+=("${indent}  \"code\": \"${eth_genesis_beacon_deposit_code}\"")
			fi
			contract_alloc_lines+=("${indent}}")
		fi

		# Output all contract allocations, comma-separated (with no trailing comma), add appropriate tabs
		local output=""
		for idx in "${!contract_alloc_lines[@]}"; do
			[[ $idx -gt 0 ]] && output+="\n"
			output+="${contract_alloc_lines[$idx]}"
		done
		echo -e "$output"
	}

	# -------------------------------------------------------------------------
	# Section 1.14: Helper Function - Build Custom Contract Allocations
	# -------------------------------------------------------------------------
	# Constructs the "alloc" section for user-defined custom contracts.
	# Supports multiple custom contracts (custom0, custom1, custom2, ...)
	# with full flexibility for address, balance, nonce, code, and storage.
	# -------------------------------------------------------------------------
	_build_custom_alloc() {
		# ! DO NOT add DEBUG_MODE here
		local contract_custom_alloc_lines=()
		local indent='    '
		local contract_custom_alloc_count=${#eth_genesis_custom_contract_address[@]}

		for index in "${!eth_genesis_custom_contract_address[@]}"; do
			# Only proceed if the contract address is set (required for a valid allocation)
			if [[ -n "${eth_genesis_custom_contract_address[$index]:-}" ]]; then
				contract_custom_alloc_lines+=("${indent}\"${eth_genesis_custom_contract_address[$index]}\": {")
				# Only include balance if set
				if [[ -n "${eth_genesis_custom_contract_balance[$index]:-}" ]]; then
					local line="${indent}  \"balance\": \"${eth_genesis_custom_contract_balance[$index]}\""
					if [[ -n "${eth_genesis_custom_contract_nonce[$index]:-}" || -n "${eth_genesis_custom_contract_code[$index]:-}" || -n "${eth_genesis_custom_contract_storage[$index]:-}" ]]; then
						line+=","
					fi
					contract_custom_alloc_lines+=("${line}")
				fi
				# Only include nonce if set
				if [[ -n "${eth_genesis_custom_contract_nonce[$index]:-}" ]]; then
					local line="${indent}  \"nonce\": \"${eth_genesis_custom_contract_nonce[$index]}\""
					if [[ -n "${eth_genesis_custom_contract_code[$index]:-}" || -n "${eth_genesis_custom_contract_storage[$index]:-}" ]]; then
						line+=","
					fi
					contract_custom_alloc_lines+=("${line}")
				fi
				# Only include code if set
				if [[ -n "${eth_genesis_custom_contract_code[$index]:-}" ]]; then
					local line="${indent}  \"code\": \"${eth_genesis_custom_contract_code[$index]}\""
					if [[ -n "${eth_genesis_custom_contract_storage[$index]:-}" ]]; then
						line+=","
					fi
					contract_custom_alloc_lines+=("${line}")
				fi
				# Only include storage if set
				if [[ -n "${eth_genesis_custom_contract_storage[$index]:-}" ]]; then
					local line="${indent}  \"storage\": {\n"

					# Process comma-separated storage entries for the current custom contract
					# eth_genesis_custom_contract_storage[$index] will look like: "0x01=0x01,0x02=0x02,0x03=0x05"
					if [[ -n "${eth_genesis_custom_contract_storage[$index]}" ]]; then
						IFS=',' read -ra storage_entries <<<"${eth_genesis_custom_contract_storage[$index]}"
						for entry_idx in "${!storage_entries[@]}"; do
							entry="${storage_entries[$entry_idx]}"
							storage_key="${entry%%=*}"
							storage_value="${entry#*=}"
							line+="${indent}    \"${storage_key}\": \"${storage_value}\""
							# If not the last entry, add a comma
							if [[ $entry_idx -lt $((${#storage_entries[@]} - 1)) ]]; then
								line+=",\n"
							else
								line+="\n"
							fi
						done
					fi

					line+="${indent}  }"
					contract_custom_alloc_lines+=("${line}")
				fi

				# Remove trailing comma if present before closing } (optional for improved JSON validity)
				# if [[ "${contract_custom_alloc_lines[-1]}" =~ ,$ ]]; then
				# 	contract_custom_alloc_lines[-1]="${contract_custom_alloc_lines[-1]%,}"
				# fi
				if [[ $index -lt $((contract_custom_alloc_count - 1)) ]]; then
					contract_custom_alloc_lines+=("${indent}},")
				else
					contract_custom_alloc_lines+=("${indent}}")
				fi
			fi
		done

		# Output all custom contract allocations, comma-separated (with no trailing comma), add appropriate tabs
		local output=""
		if [[ ${#contract_custom_alloc_lines[@]} -gt 0 ]]; then
			output+=",\n"
		fi
		for idx in "${!contract_custom_alloc_lines[@]}"; do
			[[ $idx -gt 0 ]] && output+="\n"
			output+="${contract_custom_alloc_lines[$idx]}"
		done
		echo -e "$output"
	}

	# -------------------------------------------------------------------------
	# Section 1.15: Generate Final eth-genesis.json
	# -------------------------------------------------------------------------
	# Assembles all configuration sections into the final Ethereum genesis JSON.
	# Format follows Geth/Reth specification with Berachain extensions.
	#
	# Structure:
	#   - config: Chain configuration and fork activation parameters
	#   - coinbase/difficulty/nonce: Genesis block metadata
	#   - alloc: Pre-deployed contracts and account balances
	# -------------------------------------------------------------------------
	cat >"$genesis_file_path" <<EOF
{
  "config": {
    "chainId": ${chain_id},
    "homesteadBlock": ${eth_genesis_homestead_block},
    "daoForkBlock": ${eth_genesis_dao_fork_block},
    "daoForkSupport": ${eth_genesis_dao_fork_support},
    "eip150Block": ${eth_genesis_eip150_block},
    "eip155Block": ${eth_genesis_eip155_block},
    "eip158Block": ${eth_genesis_eip158_block},
    "byzantiumBlock": ${eth_genesis_byzantium_block},
    "constantinopleBlock": ${eth_genesis_constantinople_block},
    "petersburgBlock": ${eth_genesis_petersburg_block},
    "istanbulBlock": ${eth_genesis_istanbul_block},
    "muirGlacierBlock": ${eth_genesis_muir_glacier_block},
    "berlinBlock": ${eth_genesis_berlin_block},
    "londonBlock": ${eth_genesis_london_block},
    "arrowGlacierBlock": ${eth_genesis_arrow_glacier_block},
    "grayGlacierBlock": ${eth_genesis_gray_glacier_block},
    "mergeNetsplitBlock": ${eth_genesis_merge_netsplit_block},
    "shanghaiTime": ${eth_genesis_shanghai_time},
    "cancunTime": ${eth_genesis_cancun_time},
    "pragueTime": ${eth_genesis_prague_time},
    "terminalTotalDifficulty": ${eth_genesis_terminal_total_difficulty},
    "terminalTotalDifficultyPassed": ${eth_genesis_terminal_total_difficulty_passed},
    "blobSchedule": {
      "cancun": {
        "target": ${eth_genesis_blob_target},
        "max": ${eth_genesis_blob_max},
        "baseFeeUpdateFraction": ${eth_genesis_blob_base_fee_update_fraction}
      },
      "prague": {
        "target": ${eth_genesis_blob_target},
        "max": ${eth_genesis_blob_max},
        "baseFeeUpdateFraction": ${eth_genesis_blob_base_fee_update_fraction}
      }
    },
    "berachain": {
$(_eth_genesis_build_berachain_section)
    },
    "ethash": {}
  },
  "coinbase": "${genesis_coinbase_address}",
  "difficulty": "${genesis_difficulty}",
  "extraData": "${genesis_extra_data}",
  "gasLimit": "${genesis_gas_limit}",
  "nonce": "${genesis_nonce}",
  "mixhash": "${genesis_mix_hash}",
  "parentHash": "${genesis_parent_hash}",
  "timestamp": "${genesis_timestamp}",
  "alloc": {
    $(_build_contracts_alloc)$(_build_custom_alloc)
  }
}
EOF

	# -------------------------------------------------------------------------
	# Section 1.16: Validate and Format Genesis JSON
	# -------------------------------------------------------------------------
	# Uses jq to validate JSON syntax and apply consistent formatting.
	# This ensures the genesis file is valid before use with Bera-Reth.
	# -------------------------------------------------------------------------
	if [[ -f "${genesis_file_path}" ]]; then
		if jq . "${genesis_file_path}" >"${genesis_file_path}.formatted" 2>/dev/null; then
			mv "${genesis_file_path}.formatted" "${genesis_file_path}"
			log_success "${GENESIS_ETH_NAME_DEFAULT} at ${genesis_file_path} is valid JSON and has been formatted with jq."
		else
			log_error "${GENESIS_ETH_NAME_DEFAULT} at ${genesis_file_path} is not valid JSON or is corrupted."
			rm -f "${genesis_file_path}.formatted"
			return 1
		fi
	else
		log_error "${GENESIS_ETH_NAME_DEFAULT} does not exist at ${genesis_file_path}."
		return 1
	fi
}

# =============================================================================
# [2] GENERATE BEACOND VALIDATOR KEYS
# =============================================================================
# Generates validator keys and configuration for Berachain consensus layer
# nodes. This function creates cryptographic keys required for validator
# operation and stores them in beranodes.config.json.
#
# Key Components Generated:
#   - node_key.json: P2P networking identity
#   - priv_validator_key.json: Validator signing keys (CometBFT)
#   - JWT secret: Engine API authentication between EL and CL
#   - Validator keys: Comet address, public keys for beacon chain
#   - Premined deposits: Genesis validator deposits (for validators only)
#
# Parameters (via flags):
#   --config-dir    : Base directory containing beranodes.config.json
#   --chain-spec    : Network specification (devnet/testnet/mainnet)
#
# Side Effects:
#   - Updates beranodes.config.json with generated keys for each node
#   - Creates temporary beacond directory (cleaned up after each node)
#
# Usage:
#   generate_base_beacond_config --config-dir /path/to/beranodes \
#                         --chain-spec devnet
# =============================================================================
generate_base_beacond_config() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: generate_base_beacond_config" >&2
	local config_dir="$1"
	local chain_spec="$2"
	local chain_id="$3"
	local chain_id_beacond="${CHAIN_NAME_DEVNET}-beacon-${CHAIN_ID_DEVNET}"

	# Parse flags
	while [[ $# -gt 0 ]]; do
		key="$1"
		case $key in
		--config-dir)
			config_dir="$2"
			shift 2
			;;
		--chain-spec)
			chain_spec="$2"
			if [[ "$chain_spec" == "${CHAIN_NAME_DEVNET}" ]]; then
				chain_id="${CHAIN_ID_DEVNET}"
				chain_id_beacond="${CHAIN_NAME_DEVNET}-beacon-${CHAIN_ID_DEVNET}"
			elif [[ "$chain_spec" == "${CHAIN_NAME_TESTNET}" ]]; then
				chain_id="${CHAIN_ID_TESTNET}"
				chain_id_beacond="${CHAIN_NAME_TESTNET}-beacon-${CHAIN_ID_TESTNET}"
			elif [[ "$chain_spec" == "${CHAIN_NAME_MAINNET}" ]]; then
				chain_id="${CHAIN_ID_MAINNET}"
				chain_id_beacond="${CHAIN_NAME_MAINNET}-beacon-${CHAIN_ID_MAINNET}"
			else
				echo "Unknown chain spec: ${chain_spec}"
				return 1
			fi
			shift 2
			;;
		*)
			echo "Unknown flag: $1"
			shift
			;;
		esac
	done

	# Check if bin/bera-reth exists in ${config_dir}/bin and is executable
	local bera_reth_binary="${config_dir}/bin/bera-reth"
	if [[ ! -x "${bera_reth_binary}" ]]; then
		log_error "bera-reth binary not found or not executable at: ${bera_reth_binary}"
		return 1
	fi

	# Check if bin/beacond exists in ${config_dir}/bin and is executable
	local beacond_binary="${config_dir}/bin/beacond"
	if [[ ! -x "${beacond_binary}" ]]; then
		log_error "beacond binary not found or not executable at: ${beacond_binary}"
		return 1
	fi

	# Clean up any existing beacond directory
	if [[ -d "${config_dir}/tmp/beacond" ]]; then
		log_info "Removing existing beacond directory at ${config_dir}/tmp/beacond"
		rm -rf "${config_dir}/tmp/beacond"
		if [[ $? -ne 0 ]]; then
			log_error "Failed to remove existing beacond directory at ${config_dir}/tmp/beacond"
			return 1
		fi
		log_success "Removed existing beacond directory at ${config_dir}/tmp/beacond"
	fi

	# Clean up any existing bera-reth directory
	if [[ -d "${config_dir}/tmp/bera-reth" ]]; then
		log_info "Removing existing bera-reth directory at ${config_dir}/tmp/bera-reth"
		rm -rf "${config_dir}/tmp/bera-reth"
		if [[ $? -ne 0 ]]; then
			log_error "Failed to remove existing bera-reth directory at ${config_dir}/tmp/bera-reth"
			return 1
		fi
	fi

	beranode_config_file="${config_dir}/beranodes.config.json"
	if [[ ! -f "${beranode_config_file}" ]]; then
		log_error "Beranode configuration file not found at ${beranode_config_file}"
		return 1
	fi

	# Retrieve all the .nodes from the beranodes.config.json file
	nodes_json=$(jq -c '.nodes' "${beranode_config_file}")
	if [[ $? -ne 0 ]] || [[ -z "$nodes_json" ]]; then
		log_error "Failed to read or parse .nodes from ${beranode_config_file}"
		return 1
	fi
	nodes_count=$(echo "$nodes_json" | jq 'length')
	echo "Number of nodes: $nodes_count"

	# Retrieve withdraw address from beranodes.config.json
	withdraw_address="$(jq -r '.wallet_address' "${beranode_config_file}")"
	if [[ $? -ne 0 ]] || [[ -z "$withdraw_address" ]]; then
		log_error "Failed to read or parse .wallet_address from ${beranode_config_file}"
		return 1
	fi

	echo "Initializing beacond nodes..."
	for ((i = 0; i < nodes_count; i++)); do
		node_json=$(echo "$nodes_json" | jq ".[$i]")
		local moniker=$(echo "$node_json" | jq -r '.moniker')
		local role=$(echo "$node_json" | jq -r '.role')

		mkdir -p "${config_dir}/tmp/beacond"
		${beacond_binary} init ${moniker} --chain-id "${chain_id_beacond}" --beacon-kit.chain-spec ${chain_spec} --home ${config_dir}/tmp/beacond >/dev/null 2>&1
		if [[ $? -ne 0 ]]; then
			log_error "Failed to initialize beacond node at ${config_dir}/tmp/beacond"
			return 1
		fi
		log_success "Initialized beacond node ${i} - ${moniker} at ${config_dir}/tmp/beacond"

		# Read node_key.json
		node_key_file="${config_dir}/tmp/beacond/config/node_key.json"
		if [[ ! -f "${node_key_file}" ]]; then
			log_error "node_key.json not found at ${node_key_file}"
			return 1
		fi
		node_key_json=$(jq -c '.' "${node_key_file}")
		if [[ $? -ne 0 ]] || [[ -z "$node_key_json" ]]; then
			log_error "Failed to read or parse node_key.json from ${node_key_file}"
			return 1
		fi

		# Read priv_validator_key.json
		priv_validator_key_file="${config_dir}/tmp/beacond/config/priv_validator_key.json"
		if [[ ! -f "${priv_validator_key_file}" ]]; then
			log_error "priv_validator_key.json not found at ${priv_validator_key_file}"
			return 1
		fi
		priv_validator_key_json=$(jq -c '.' "${priv_validator_key_file}")
		if [[ $? -ne 0 ]] || [[ -z "$priv_validator_key_json" ]]; then
			log_error "Failed to read or parse priv_validator_key.json from ${priv_validator_key_file}"
			return 1
		fi

		# Read validator keys
		validator_keys=""
		validator_keys="$(${beacond_binary} deposit validator-keys --home ${config_dir}/tmp/beacond)"
		if [[ $? -ne 0 ]]; then
			log_error "Failed to read validator keys at ${config_dir}/tmp/beacond"
			return 1
		fi

		node_id=$(${beacond_binary} tendermint show-node-id --beacon-kit.chain-spec ${chain_spec} --home ${config_dir}/tmp/beacond)
		if [[ $? -ne 0 ]]; then
			log_error "Failed to read node id at ${config_dir}/tmp/beacond"
			return 1
		fi

		premined_deposit_json="null"
		if [[ "$role" == "validator" ]]; then
			# Add premined deposit
			${beacond_binary} genesis add-premined-deposit ${GENESIS_DEPOSIT_AMOUNT} "${withdraw_address}" --beacon-kit.chain-spec ${chain_spec} --home ${config_dir}/tmp/beacond
			if [[ $? -ne 0 ]]; then
				log_error "Failed to add premined deposit at ${config_dir}/tmp/beacond"
				return 1
			fi

			# Get the contents from the premined-deposit-*.json file
			premined_deposit_file=$(ls ${config_dir}/tmp/beacond/config/premined-deposits/premined-deposit-*.json 2>/dev/null | head -n 1)

			if [[ -n "${premined_deposit_file}" && -f "${premined_deposit_file}" ]]; then
				# Ensure the file contains valid JSON, and get as raw object for jq
				premined_deposit_json=$(jq -c '.' "${premined_deposit_file}")
				if [[ $? -ne 0 ]] || [[ -z "$premined_deposit_json" ]]; then
					log_error "Failed to read or parse premined deposit json from ${premined_deposit_file}"
					return 1
				fi
			else
				log_error "premined deposit json file not found for node ${moniker} at ${config_dir}/tmp/beacond/premined-deposits/"
				return 1
			fi
		fi

		# Extract Comet Address
		comet_address=$(echo "$validator_keys" | sed -n '2p' | xargs | tr -d '[:space:]')
		comet_pubkey=$(echo "$validator_keys" | sed -n '5p' | xargs | tr -d '[:space:]')
		eth_beacon_pubkey=$(echo "$validator_keys" | sed -n '8p' | xargs | tr -d '[:space:]')

		# Get deposit amount
		deposit_amount=$GENESIS_DEPOSIT_AMOUNT

		# Generate JWT file
		${beacond_binary} >/dev/null 2>&1 jwt generate -o ${config_dir}/tmp/beacond/jwt.hex
		if [[ $? -ne 0 ]]; then
			log_error "Failed to generate JWT file at ${jwt_file}"
			return 1
		fi
		# Add JWT value to beranodes.config.json
		jwt_value=$(cat ${config_dir}/tmp/beacond/jwt.hex)
		if [[ $? -ne 0 ]] || [[ -z "$jwt_value" ]]; then
			log_error "Failed to read JWT value from ${config_dir}/tmp/beacond/jwt.hex"
			return 1
		fi

		# Add bera-reth config
		# - Placeholder
		private_key="$(cast wallet new --json | jq -r '.[0].private_key')"
		public_key="$(cast wallet public-key --private-key ${private_key})"
		berareth_config="{
      \"private_key\": \"$(echo "${private_key}" | sed 's/^0x//')\",
      \"public_key\": \"$(echo "${public_key}" | sed 's/^0x//')\"
    }"

		# Add beacond config
		beacond_config="{
      \"comet_address\": \"$comet_address\",
      \"comet_pubkey\": \"$comet_pubkey\",
      \"node_id\": \"$node_id\",
      \"deposit_amount\": \"$deposit_amount\",
      \"jwt\": \"$jwt_value\",
      \"eth_beacon_pubkey\": \"$eth_beacon_pubkey\",
      \"node_key\": $node_key_json,
      \"premined_deposit\": $premined_deposit_json,
      \"priv_validator_key\": $priv_validator_key_json
    }"

		# Build json object with the validator keys
		tmp_beranode_config="${beranode_config_file}.tmp"
		jq --arg idx "$((i))" \
			--argjson node_key "$node_key_json" \
			--argjson priv_validator_key "$priv_validator_key_json" \
			--arg comet_address "$comet_address" \
			--arg comet_pubkey "$comet_pubkey" \
			--arg eth_beacon_pubkey "$eth_beacon_pubkey" \
			--arg node_id "$node_id" \
			--argjson premined_deposit "$premined_deposit_json" \
			--arg deposit_amount "$deposit_amount" \
			--arg jwt "$jwt_value" \
			--argjson berareth_config "$berareth_config" \
			--argjson beacond_config "$beacond_config" \
			'
         .nodes |=
           (.[($idx|tonumber)] += {
              berareth_config: $berareth_config,
              beacond_config: $beacond_config,
           })
       ' "${beranode_config_file}" >"${tmp_beranode_config}"
		if [[ $? -ne 0 ]]; then
			log_error "Failed to add node_key to node $((i - 1)) in ${beranode_config_file}"
			rm -f "${tmp_beranode_config}"
			return 1
		fi
		mv "${tmp_beranode_config}" "${beranode_config_file}"

		# Clean up the tmp/beacond folder for each iteration
		if [[ -d "${config_dir}/tmp/beacond" ]]; then
			rm -rf "${config_dir}/tmp/beacond"
			if [[ $? -ne 0 ]]; then
				log_error "Failed to clean up ${config_dir}/tmp/beacond before initializing node ${moniker}"
				return 1
			fi
			log_info "Cleaned up ${config_dir}/tmp/beacond before initializing node ${moniker}"
		fi

		log_success "Added node_key to node $((i - 1)) in ${beranode_config_file}"
	done
}

# =============================================================================
# [4] GENERATE COMPREHENSIVE BEACOND GENESIS
# =============================================================================
# Creates a complete beacon chain genesis file with validator deposits and
# execution payload configuration. This is the primary function for genesis
# generation in production deployments.
#
# Workflow:
#   1. Read validator configurations from beranodes.config.json
#   2. Initialize temporary beacond node with first validator's keys
#   3. Collect premined deposits from all validators
#   4. Generate validator root for genesis
#   5. Configure deposit contract storage in eth-genesis.json
#   6. Set execution payload from eth-genesis.json
#   7. Finalize genesis.json and eth-genesis.json
#
# Key Features:
#   - Multi-validator genesis support
#   - Automatic deposit contract initialization
#   - Validator root calculation for beacon chain
#   - Integration of EL and CL genesis files
#
# Parameters (via flags):
#   --config-dir    : Base directory containing beranodes.config.json
#   --chain-spec    : Network specification (devnet/testnet/mainnet)
#   --chain-id      : Optional explicit chain ID override
#
# Inputs:
#   - beranodes.config.json: Node configurations with validator keys
#   - tmp/eth-genesis.json: Ethereum genesis (modified with deposits)
#
# Outputs:
#   - tmp/genesis.json: Complete beacon chain genesis
#   - tmp/eth-genesis.json: Updated with deposit contract storage
#   - beranodes.config.json: Updated with genesis_deposits and validator_root
#
# Usage:
#   generate_beacond_genesis_file_and_premined_deposits_storage --config-dir /path/to/beranodes \
#                            --chain-spec devnet
# =============================================================================
generate_beacond_genesis_file_and_premined_deposits_storage() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: generate_beacond_genesis_file_and_premined_deposits_storage" >&2
	local config_dir="$1"
	local chain_spec="$2"
	local chain_id=""
	local chain_id_beacond="${CHAIN_NAME_DEVNET}-beacon-${CHAIN_ID_DEVNET}"
	local beranode_config_file=""

	# Parse flags
	while [[ $# -gt 0 ]]; do
		key="$1"
		case $key in
		--config-dir)
			config_dir="$2"
			beranode_config_file="${config_dir}/beranodes.config.json"
			shift 2
			;;
		--chain-spec)
			chain_spec="$2"
			if [[ "$chain_spec" == "${CHAIN_NAME_DEVNET}" ]]; then
				chain_id="${CHAIN_ID_DEVNET}"
				chain_id_beacond="${CHAIN_NAME_DEVNET}-beacon-${CHAIN_ID_DEVNET}"
			elif [[ "$chain_spec" == "${CHAIN_NAME_TESTNET}" ]]; then
				chain_id="${CHAIN_ID_TESTNET}"
				chain_id_beacond="${CHAIN_NAME_TESTNET}-beacon-${CHAIN_ID_TESTNET}"
			elif [[ "$chain_spec" == "${CHAIN_NAME_MAINNET}" ]]; then
				chain_id="${CHAIN_ID_MAINNET}"
				chain_id_beacond="${CHAIN_NAME_MAINNET}-beacon-${CHAIN_ID_MAINNET}"
			else
				echo "Unknown chain spec: ${chain_spec}"
				shift 2
				return 1
			fi
			shift 2
			;;
		--chain-id)
			chain_id="$2"
			shift 2
			;;
		*)
			echo "Unknown flag: $1"
			shift
			;;
		esac
	done

	# Check if beranodes.config.json file exists in ${config_dir}/tmp/beranodes.config.json
	if [[ ! -f "${beranode_config_file}" ]]; then
		log_error "Beranode configuration file not found at ${beranode_config_file}"
		return 1
	fi

	# Check for eht-genesis.json file exists in ${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}
	if [[ ! -f "${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}" ]]; then
		log_error "${GENESIS_ETH_NAME_DEFAULT} file not found at ${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}"
		return 1
	fi

	# Check if existing genesis.json file exists in ${config_dir}/tmp/genesis.json
	# TODO refactor as a prompt or remove
	local genesis_file="${config_dir}${BERANODES_PATH_TMP}/${GENESIS_BEACON_NAME_DEFAULT}"
	if [ -f "${genesis_file}" ]; then
		log_info "Genesis file already exists at ${genesis_file}"
	fi

	# Check if bin/beacond exists in ${config_dir}/bin and is executable
	local beacond_binary="${config_dir}/bin/beacond"
	if [[ ! -x "${beacond_binary}" ]]; then
		log_error "beacond binary not found or not executable at: ${beacond_binary}"
		return 1
	fi

	# Retrieve all the .nodes from the beranodes.config.json file
	nodes_json=$(jq -c '.nodes' "${beranode_config_file}")
	if [[ $? -ne 0 ]] || [[ -z "$nodes_json" ]]; then
		log_error "Failed to read or parse .nodes from ${beranode_config_file}"
		return 1
	fi
	nodes_count=$(echo "$nodes_json" | jq 'length')
	if [[ "$nodes_count" -eq 0 ]]; then
		log_error "No nodes found in ${beranode_config_file}, cannot generate beacond genesis file."
		return 1
	fi

	# Iterate through all the nodes to find role == validator
	for i in $(seq 1 ${nodes_count}); do
		role=$(echo "$node_json" | jq -r '.role')
		if [[ "$role" == "validator" ]]; then
			node_json=$(echo "$nodes_json" | jq ".[$i-1]")
			moniker=$(echo "$node_json" | jq -r '.moniker')
			role=$(echo "$node_json" | jq -r '.role')
			jwt=$(echo "$node_json" | jq -r '.jwt // empty')
		fi
	done

	if [[ -z "$node_json" ]]; then
		log_error "No validator found in ${beranode_config_file}, cannot generate beacond genesis file."
		return 1
	fi

	# node key
	node_key_type=$(echo "$node_json" | jq -r '.node_key.type // empty')
	node_key_value=$(echo "$node_json" | jq -r '.node_key.value // empty')

	# priv validator key
	priv_validator_key_address=$(echo "$node_json" | jq -r '.priv_validator_key.address // empty')
	priv_validator_key_pubkey_type=$(echo "$node_json" | jq -r '.priv_validator_key.pub_key.type // empty')
	priv_validator_key_pubkey_value=$(echo "$node_json" | jq -r '.priv_validator_key.pub_key.value // empty')
	priv_validator_key_privkey_type=$(echo "$node_json" | jq -r '.priv_validator_key.priv_key.type // empty')
	priv_validator_key_privkey_value=$(echo "$node_json" | jq -r '.priv_validator_key.priv_key.value // empty')

	# comet address
	comet_address=$(echo "$node_json" | jq -r '.comet_address // empty')
	comet_pubkey=$(echo "$node_json" | jq -r '.comet_pubkey // empty')
	eth_beacon_pubkey=$(echo "$node_json" | jq -r '.eth_beacon_pubkey // empty')

	# deposit amount
	deposit_amount=$(echo "$node_json" | jq -r '.deposit_amount // empty')

	# make tmp/beacond directory
	mkdir -p "${config_dir}${BERANODES_PATH_TMP}/beacond"
	if [[ $? -ne 0 ]]; then
		log_error "Failed to create ${BERANODES_PATH_TMP}beacond directory at ${config_dir}${BERANODES_PATH_TMP}/beacond"
		return 1
	fi

	# beacond init
	${beacond_binary} init ${moniker} --chain-id "${chain_id_beacond}" --beacon-kit.chain-spec ${chain_spec} --home ${config_dir}/tmp/beacond >/dev/null 2>&1
	if [[ $? -ne 0 ]]; then
		log_error "Failed to initialize beacond node at ${config_dir}${BERANODES_PATH_TMP}/beacond"
		return 1
	fi
	log_success "Initialized beacond node ${i} - ${moniker} at ${config_dir}${BERANODES_PATH_TMP}/beacond"

	# replace existing node key in the required format
	node_key_file="${config_dir}${BERANODES_PATH_TMP}/beacond/config/node_key.json"
	cat >"${node_key_file}" <<EOF
{
"priv_key": {
  "type": "${node_key_type}",
  "value": "${node_key_value}"
}
}
EOF
	if [[ $? -ne 0 ]]; then
		log_error "Failed to write new node key format to ${node_key_file}"
		return 1
	fi
	log_success "Replaced existing node key at ${node_key_file} in new format"

	# replace priv_validator_key.json in the required format
	priv_validator_key_file="${config_dir}${BERANODES_PATH_TMP}/beacond/config/priv_validator_key.json"
	cat >"${priv_validator_key_file}" <<EOF
{
"address": "${priv_validator_key_address}",
"pub_key": {
  "type": "${priv_validator_key_pubkey_type}",
  "value": "${priv_validator_key_pubkey_value}"
},
"priv_key": {
  "type": "${priv_validator_key_privkey_type}",
  "value": "${priv_validator_key_privkey_value}"
}
}
EOF
	if [[ $? -ne 0 ]]; then
		log_error "Failed to write new priv_validator_key format to ${priv_validator_key_file}"
		return 1
	fi
	log_success "Replaced existing priv_validator_key at ${priv_validator_key_file} in new format"

	# add jwt
	jwt_file="${config_dir}/tmp/beacond/config/jwt.hex"
	cat >"${jwt_file}" <<EOF
${jwt}
EOF
	if [[ $? -ne 0 ]]; then
		log_error "Failed to write new jwt format to ${jwt_file}"
		return 1
	fi
	log_success "Added jwt at ${jwt_file}"

	# Modify app.toml for jwt-secret-path = ${jwt_file}
	app_toml_file="${config_dir}/tmp/beacond/config/app.toml"
	sed "${SED_OPT[@]}" "s|^jwt-secret-path = \".*\"|jwt-secret-path = \"${jwt_file}\"|" "${app_toml_file}"
	if [[ $? -ne 0 ]]; then
		log_error "Failed to modify app.toml for jwt-secret-path at ${app_toml_file}"
		return 1
	fi
	log_success "Modified app.toml for jwt-secret-path at ${app_toml_file}"

	# add kzg-trusted-setup.json config to app.toml
	kzg_file="${config_dir}/tmp/kzg-trusted-setup.json"
	sed "${SED_OPT[@]}" "s|^trusted-setup-path = \".*\"|trusted-setup-path = \"${kzg_file}\"|" "${app_toml_file}"
	if [[ $? -ne 0 ]]; then
		log_error "Failed to add kzg-trusted-setup.json config to app.toml at ${app_toml_file}"
		return 1
	fi
	log_success "Added kzg-trusted-setup.json config to app.toml at ${app_toml_file}"

	# add premined deposits
	mkdir -p "${config_dir}${BERANODES_PATH_TMP}/beacond/config/premined-deposits"
	# Check if beranodes.config.json has a key called "genesis_deposits" which is an array
	beranode_config_file="${config_dir}/beranodes.config.json"
	has_genesis_deposits=$(jq 'has("genesis_deposits") and (.genesis_deposits|type == "array")' "${beranode_config_file}" 2>/dev/null)
	if [[ "${has_genesis_deposits}" == "true" ]]; then
		log_info "\"genesis_deposits\" key exists and is an array in ${beranode_config_file}"
	else
		log_warn "\"genesis_deposits\" key not present or not an array in ${beranode_config_file} creating..."

		# Iterate through the "nodes" array in beranodes.config.json and process each node
		nodes_length=$(jq '.nodes | length' "${beranode_config_file}")
		for ((node_idx = 0; node_idx < nodes_length; node_idx++)); do
			# if .node role == validator then add premined deposit
			node_role=$(jq -r ".nodes[${node_idx}].role" "${beranode_config_file}")
			if [[ "$node_role" == "validator" ]]; then
				node=$(jq -c ".nodes[${node_idx}]" "${beranode_config_file}")
				node_moniker=$(jq -r ".nodes[${node_idx}].moniker" "${beranode_config_file}")

				# premined deposit
				preminded_deposit_pubkey=$(echo "$node" | jq -r '.beacond_config.premined_deposit.pubkey // empty')
				preminded_deposit_credentials=$(echo "$node" | jq -r '.beacond_config.premined_deposit.credentials // empty')
				preminded_deposit_amount=$(echo "$node" | jq -r '.beacond_config.premined_deposit.amount // empty')
				preminded_deposit_signature=$(echo "$node" | jq -r '.beacond_config.premined_deposit.signature // empty')
				preminded_deposit_index=$(echo "$node" | jq -r '.beacond_config.premined_deposit.index // empty')

				# create a deposit file in "beranodes/tmp/beacond/config/premined-deposits"
				deposit_file="${config_dir}${BERANODES_PATH_TMP}/beacond/config/premined-deposits/premined-deposit-${preminded_deposit_pubkey}.json"
				cat >"${deposit_file}" <<EOF
{
"pubkey": "${preminded_deposit_pubkey}",
"credentials": "${preminded_deposit_credentials}",
"amount": "${preminded_deposit_amount}",
"signature": "${preminded_deposit_signature}",
"index": ${preminded_deposit_index}
}
EOF
			fi
		done

		${beacond_binary} genesis collect-premined-deposits --beacon-kit.chain-spec ${chain_spec} --home ${config_dir}${BERANODES_PATH_TMP}/beacond
		if [[ $? -ne 0 ]]; then
			log_error "Failed to collect premined deposits at ${config_dir}${BERANODES_PATH_TMP}/beacond"
			return 1
		fi
		log_success "Collected premined deposits at ${config_dir}${BERANODES_PATH_TMP}/beacond"

		# validate if genesis.json has an key called .app_state.beacon.deposits which is an array and it matches the number of premined deposits
		genesis_file="${config_dir}${BERANODES_PATH_TMP}/beacond/config/${GENESIS_BEACON_NAME_DEFAULT}"
		deposits_count=$(jq '.app_state.beacon.deposits | length' "${genesis_file}")
		if [[ $? -ne 0 ]] || [[ -z "$deposits_count" ]]; then
			log_error "Failed to read or parse .app_state.beacon.deposits from ${genesis_file}"
			return 1
		fi
		# get .validators value beranodes.config.json
		validators_count=$(jq '.validators | length' "${beranode_config_file}")
		if [[ $? -ne 0 ]] || [[ -z "$validators_count" ]]; then
			log_error "Failed to read or parse .validators from ${beranode_config_file}"
			return 1
		fi
		if [[ "$deposits_count" -ne "$validators_count" ]]; then
			log_error "Number of premined deposits does not match the number of nodes in ${genesis_file}"
			return 1
		fi
		log_success "Number of premined deposits matches the number of nodes in ${genesis_file}"

		# copy .app_state.beacon.deposits from ${config_dir}${BERANODES_PATH_TMP}/beacond/config/${GENESIS_BEACON_NAME_DEFAULT} to beranodes.config.json
		deposits_json=$(jq -c '.app_state.beacon.deposits' "${genesis_file}")
		if [[ $? -ne 0 ]] || [[ -z "$deposits_json" ]]; then
			log_error "Failed to read or parse .app_state.beacon.deposits from ${genesis_file}"
			return 1
		fi
		jq --argjson deposits "$deposits_json" '
      .genesis_deposits = $deposits
    ' "${beranode_config_file}" >"${beranode_config_file}.tmp"
		mv "${beranode_config_file}.tmp" "${beranode_config_file}"
		log_success "Copied .app_state.beacon.deposits from ${config_dir}${BERANODES_PATH_TMP}/beacond/config/${GENESIS_BEACON_NAME_DEFAULT} to beranodes.config.json"

		# generate validator root
		validator_root=$(${beacond_binary} genesis validator-root ${config_dir}${BERANODES_PATH_TMP}/beacond/config/${GENESIS_BEACON_NAME_DEFAULT} --beacon-kit.chain-spec ${chain_spec} --home ${config_dir}${BERANODES_PATH_TMP}/beacond)
		if [[ $? -ne 0 ]] || [[ -z "$validator_root" ]]; then
			log_error "Failed to generate validator root at ${config_dir}${BERANODES_PATH_TMP}/beacond/config/${GENESIS_BEACON_NAME_DEFAULT}"
			return 1
		fi
		log_success "Generated validator root at ${config_dir}${BERANODES_PATH_TMP}/beacond/config/${GENESIS_BEACON_NAME_DEFAULT}"
		echo "Validator root: $validator_root"

		# validator_root to beranodes.config.json
		jq --arg validator_root "$validator_root" '
      .validator_root = $validator_root
    ' "${beranode_config_file}" >"${beranode_config_file}.tmp"
		mv "${beranode_config_file}.tmp" "${beranode_config_file}"
		log_success "Replaced validator root in beranodes.config.json"

		# Modifies eth-genesis.json file to set deposit storage
		# set deposit storage - makes a copy of the eth-genesis.json file to ${config_dir}${BERANODES_PATH_TMP}/beacond/eth-genesis.json and modifies the 0x4242... storage slots
		${beacond_binary} genesis set-deposit-storage ${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT} --beacon-kit.chain-spec ${chain_spec} --home ${config_dir}${BERANODES_PATH_TMP}/beacond
		if [[ $? -ne 0 ]] || [[ ! -f "${config_dir}${BERANODES_PATH_TMP}/beacond/${GENESIS_ETH_NAME_DEFAULT}" ]]; then
			log_error "Failed to set deposit storage at ${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}"
			return 1
		fi
		# cp the json object .alloc.0x4242424242424242424242424242424242424242.storage and replace it with the json object from ${config_dir}/tmp/beacond/eth-genesis.json
		storage_json=$(jq -c '.alloc."0x4242424242424242424242424242424242424242".storage' "${config_dir}${BERANODES_PATH_TMP}/beacond/${GENESIS_ETH_NAME_DEFAULT}")
		if [[ $? -ne 0 ]] || [[ -z "$storage_json" ]]; then
			log_error "Failed to read or parse .alloc.\"0x4242424242424242424242424242424242424242\".storage from ${config_dir}${BERANODES_PATH_TMP}/beacond/${GENESIS_ETH_NAME_DEFAULT}"
			return 1
		fi
		jq --argjson storage "$storage_json" '
      .alloc."0x4242424242424242424242424242424242424242".storage = $storage
    ' "${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}" >"${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}.tmp"
		mv "${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}.tmp" "${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}"
		log_success "Replaced .alloc.\"0x4242424242424242424242424242424242424242\".storage in ${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}"

		# Modifies genesis.json file to set execution payload
		# execution payload
		${beacond_binary} genesis execution-payload ${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT} --beacon-kit.chain-spec ${chain_spec} --home ${config_dir}${BERANODES_PATH_TMP}/beacond
		if [[ $? -ne 0 ]]; then
			log_error "Failed to set execution payload at ${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}"
			return 1
		fi
		log_success "Set execution payload at ${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}"

		# Copy genesis.json to beranodes/tmp/genesis.json
		cp ${config_dir}${BERANODES_PATH_TMP}/beacond/config/${GENESIS_BEACON_NAME_DEFAULT} ${config_dir}${BERANODES_PATH_TMP}/genesis.json
		if [[ $? -ne 0 ]]; then
			log_error "Failed to copy ${GENESIS_BEACON_NAME_DEFAULT} to ${BERANODES_PATH_TMP}/${GENESIS_BEACON_NAME_DEFAULT}"
			return 1
		fi
		log_success "Copied ${GENESIS_BEACON_NAME_DEFAULT} to ${BERANODES_PATH_TMP}/${GENESIS_BEACON_NAME_DEFAULT}"

		# Modify beranodes/tmp/genesis.json to add key values of genesis_file and genesis_eth_file
		jq --arg genesis_file "${config_dir}${BERANODES_PATH_TMP}/beacond/config/${GENESIS_BEACON_NAME_DEFAULT}" \
			--arg genesis_eth_file "${config_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}" '
      .genesis_file = $genesis_file
      | .genesis_eth_file = $genesis_eth_file
    ' "${config_dir}/beranodes.config.json" >"${config_dir}/beranodes.config.json.tmp"
		mv "${config_dir}/beranodes.config.json.tmp" "${config_dir}/beranodes.config.json"
		log_success "Modified beranodes.config.json to add key values of genesis_file and genesis_eth_file"
	fi

	# Ensure the beacond directory is removed, regardless of its existence
	rm -rf "${config_dir}${BERANODES_PATH_TMP}/beacond"
	if [[ -d "${config_dir}${BERANODES_PATH_TMP}/beacond" ]]; then
		log_error "Failed to remove beacond directory at ${config_dir}${BERANODES_PATH_TMP}/beacond"
		return 1
	else
		log_success "Ensured removal of beacond directory at ${config_dir}${BERANODES_PATH_TMP}/beacond"
	fi

	# Ensure that bera-reth directory is removed, regardless of its existence
	rm -rf "${config_dir}${BERANODES_PATH_TMP}/bera-reth"
	if [[ -d "${config_dir}${BERANODES_PATH_TMP}/bera-reth" ]]; then
		log_error "Failed to remove bera-reth directory at ${config_dir}${BERANODES_PATH_TMP}/bera-reth"
		return 1
	else
		log_success "Ensured removal of bera-reth directory at ${config_dir}${BERANODES_PATH_TMP}/bera-reth"
	fi
}


# =============================================================================
# download
# Source: lib/download.sh
# =============================================================================

download_beranodes_binary() {
  [[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: download_beranodes_binary" >&2

  # Local variables
  local config_dir="${BERANODES_PATH_DEFAULT}"
  local bin_dir="${config_dir}${BERANODES_PATH_BIN}"
  local binary_to_download="" # either $BIN_BERARETH or $BIN_BEACONKIT
  local version_tag="latest"
  local is_docker=false

  # Parse flags
	while [[ $# -gt 0 ]]; do
		case "$1" in
		--config-dir)
			if [[ -n "$2" ]]; then
				check_dir="$2"
				if [[ ! -d "$check_dir" ]]; then
					log_warn "Config directory not found at $config_dir, using default directory ${BERANODES_PATH_DEFAULT}"
        else
          config_dir="$check_dir"
          bin_dir="${config_dir}${BERANODES_PATH_BIN}"
				fi
				shift 2
			else
				log_warn "--config-dir is not set. defaulting to ${BERANODES_PATH_DEFAULT}"
				shift
			fi
			;;
      --binary-to-download)
        if [[ -n "$2" ]]; then
          check_binary_to_download="$2"
          if [[ "$check_binary_to_download" != "$BIN_BERARETH" && "$check_binary_to_download" != "$BIN_BEACONKIT" ]]; then
            log_error "--binary-to-download is not set to ether '${BIN_BERARETH}' or '${BIN_BEACONKIT}'"
            return 1
          fi
          binary_to_download="$check_binary_to_download"
          shift 2
        else
          log_erorr "--binary-to-download is not set to ether '${BIN_BERARETH}' or '${BIN_BEACONKIT}'"
          return 1
        fi
        ;;
      --version-tag)
        if [[ -n "$2" ]]; then
          # version_tag="$2"
          check_version_tag="$2"
          if [[ ! "$check_version_tag" =~ ^(latest|v\.?[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+(\.[0-9]+)?)?)$ ]]; then
            log_error "--version-tag must match format (latest or v<MAJ>.<MIN>.<PATCH> or v<MAJ>.<MIN>.<PATCH>-rc<N>) (e.g., latest, v0.6.0, v0.6.0-rc2)"
            return 1
          fi
          version_tag="$check_version_tag"
          log_info "Using version tag: $version_tag"
          shift 2
        else
          log_warn "--version-tag is not set. defaulting to ${version_tag}"
          shift
        fi
        ;;
      --docker)
        is_docker=true
        shift
        ;;
      *)
        log_error "Unknown option: $1"
        return 1
        ;;
		esac
	done
  
  # Download bera-reth binary
  if [[ "$binary_to_download" == "$BIN_BERARETH" ]]; then
    local release_url="${RELEASE_BERARETH}/releases$( [[ "$version_tag" == "latest" ]] && echo "/latest" || echo "/tags/${version_tag}" )"
    local download_url=""

    log_info "Checking bera-reth binary from: $release_url"
    # Check if the URL doesn't return a 404 before using it
    local response=$(curl -s -w "\n%{http_code}" "$release_url")
    local http_status=$(echo "$response" | tail -n1)
    local response_body=$(echo "$response" | sed '$d')
    if [[ "$http_status" == "404" ]]; then
      log_error "Release URL not found (404): $release_url"
      return 1
    fi
    # Check if the response is valid JSON (for GitHub API)
    if ! echo "$response_body" | jq . >/dev/null 2>&1; then
      log_error "Response from $release_url is not valid JSON."
      return 1
    fi

    local version=$(echo "$response_body" | jq -r '.tag_name')
    if [[ "$version" == "null" ]]; then
      log_error "Failed to get version from response: $response"
      return 1
    fi

    log_info "Using version: $version"

    local arch="unknown"
    if [[ "$IS_MACOS" == true ]]; then
      arch="darwin-arm64"
      download_url=$(echo "$response_body" | jq -r '.assets[] | select(.name | contains("darwin-arm64") and endswith(".tar.gz") and (contains(".sig") | not)) | .browser_download_url')
    elif [[ "$IS_LINUX" == true ]]; then
      if [[ "$IS_LINUX_ARM" == true ]]; then
        arch="linux-arm64"
        download_url=$(echo "$response" | jq -r '.assets[] | select(.name | contains("linux-arm64") and endswith(".tar.gz") and (contains(".sig") | not)) | .browser_download_url')
      else
        arch="linux-amd64"
        download_url=$(echo "$response" | jq -r '.assets[] | select(.name | contains("linux-amd64") and endswith(".tar.gz") and (contains(".sig") | not)) | .browser_download_url')
      fi
    else
      log_error "Unsupported platform: $PLATFORM - $ARCH"
      return 1
    fi

    if [[ -z "$download_url" ]]; then
      log_error "No download URL found for the required binary for '$arch'."
      return 1
    fi

    # Ensure the bin directory exists
    ensure_dir_exists "${config_dir}${BERANODES_PATH_BIN}" "binary directory: ${config_dir}${BERANODES_PATH_BIN}"

    log_info "Downloading $binary_to_download from $download_url"

    # curl -L --output "${config_dir}${BERANODES_PATH_BIN}/${binary_to_download}.tar.gz" "$download_url"
    tar_file_name=$(basename "$download_url")
    curl -L --output-dir "${config_dir}${BERANODES_PATH_BIN}" -O "$download_url"
    if [[ $? -ne 0 ]]; then
      log_error "Failed to download $binary_to_download from $download_url"
      return 1
    fi
    log_success "Downloaded ${tar_file_name} to ${config_dir}${BERANODES_PATH_BIN}"

    # untar the file in that directory
    tar -xzf "${config_dir}${BERANODES_PATH_BIN}/${tar_file_name}" -C "${config_dir}${BERANODES_PATH_BIN}"

    # rename the file to the binary name
    file_name="${tar_file_name%.tar.gz}"
    mv "${config_dir}${BERANODES_PATH_BIN}/${file_name}" "${config_dir}${BERANODES_PATH_BIN}/${binary_to_download}"

    # permissions to the binary
    chmod +x "${config_dir}${BERANODES_PATH_BIN}/${binary_to_download}"

    # check if binary is executable
    local binary_version=$("${config_dir}${BERANODES_PATH_BIN}/${binary_to_download}" --version)
    if [[ ! -x "${config_dir}${BERANODES_PATH_BIN}/${binary_to_download}" ]] || [[ -z "$binary_version" ]]; then
      log_error "Binary ${binary_to_download} is not executable."
      return 1
    fi
    log_success "Binary ${binary_to_download} is executable."
    log_info $binary_version
  # Download beacond binary
  elif [[ "$binary_to_download" == "$BIN_BEACONKIT" ]]; then
    local release_url="${RELEASE_BEACONKIT}/releases$( [[ "$version_tag" == "latest" ]] && echo "/latest" || echo "/tags/${version_tag}" )"
    local download_url=""

    log_info "Checking beacond binary from: $release_url"
    # Check if the URL doesn't return a 404 before using it
    local response=$(curl -s -w "\n%{http_code}" "$release_url")
    local http_status=$(echo "$response" | tail -n1)
    local response_body=$(echo "$response" | sed '$d')
    if [[ "$http_status" == "404" ]]; then
      log_error "Release URL not found (404): $release_url"
      return 1
    fi
    # Check if the response is valid JSON (for GitHub API)
    if ! echo "$response_body" | jq . >/dev/null 2>&1; then
      log_error "Response from $release_url is not valid JSON."
      return 1
    fi

    local version=$(echo "$response_body" | jq -r '.tag_name')
    if [[ "$version" == "null" ]]; then
      log_error "Failed to get version from response: $response"
      return 1
    fi

    log_info "Using version: $version"
    local arch="unknown"
    if [[ "$IS_MACOS" == true ]]; then
      arch="darwin-arm64"
      download_url=$(echo "$response_body" | jq -r '.assets[] | select(.name | contains("darwin-arm64") and endswith(".tar.gz") and (contains(".sig") | not)) | .browser_download_url')
    elif [[ "$IS_LINUX" == true ]]; then
      if [[ "$IS_LINUX_ARM" == true ]]; then
        arch="linux-arm64"
        download_url=$(echo "$response" | jq -r '.assets[] | select(.name | contains("linux-arm64") and endswith(".tar.gz") and (contains(".sig") | not)) | .browser_download_url')
      else
        arch="linux-amd64"
        download_url=$(echo "$response" | jq -r '.assets[] | select(.name | contains("linux-amd64") and endswith(".tar.gz") and (contains(".sig") | not)) | .browser_download_url')
      fi
    else
      log_error "Unsupported platform: $PLATFORM - $ARCH"
      return 1
    fi

    if [[ -z "$download_url" ]]; then
      log_error "No download URL found for the required binary for '$arch'."
      return 1
    fi

    # Ensure the bin directory exists
    ensure_dir_exists "${config_dir}${BERANODES_PATH_BIN}" "binary directory: ${config_dir}${BERANODES_PATH_BIN}"

    log_info "Downloading $binary_to_download from $download_url"

    # curl -L --output "${config_dir}${BERANODES_PATH_BIN}/${binary_to_download}.tar.gz" "$download_url"
    tar_file_name=$(basename "$download_url")
    curl -L --output-dir "${config_dir}${BERANODES_PATH_BIN}" -O "$download_url"
    if [[ $? -ne 0 ]]; then
      log_error "Failed to download $binary_to_download from $download_url"
      return 1
    fi
    log_success "Downloaded ${tar_file_name} to ${config_dir}${BERANODES_PATH_BIN}"

    # untar the file in that directory
    tar -xzf "${config_dir}${BERANODES_PATH_BIN}/${tar_file_name}" -C "${config_dir}${BERANODES_PATH_BIN}"

    # rename the file to the binary name
    file_name="${tar_file_name%.tar.gz}"
    mv "${config_dir}${BERANODES_PATH_BIN}/${file_name}" "${config_dir}${BERANODES_PATH_BIN}/${binary_to_download}"

    # permissions to the binary
    chmod +x "${config_dir}${BERANODES_PATH_BIN}/${binary_to_download}"

    # check if binary is executable
    local binary_version=$("${config_dir}${BERANODES_PATH_BIN}/${binary_to_download}" version)
    if [[ ! -x "${config_dir}${BERANODES_PATH_BIN}/${binary_to_download}" ]] || [[ -z "$binary_version" ]]; then
      log_error "Binary ${binary_to_download} is not executable."
      return 1
    fi
    log_success "Binary ${binary_to_download} is executable."
    log_info $binary_version
  fi
}


# =============================================================================
# common
# Source: commands/common.sh
# =============================================================================



# =============================================================================
# init
# Source: commands/init.sh
# =============================================================================

show_init_help() {
	cat <<EOF
beranode init - Initialize a new Berachain node configuration

USAGE:
    beranode init [OPTIONS]

GENERAL OPTIONS:
    --beranodes-dir <path>           Directory for beranodes data (default: ./beranodes)
    --moniker <name>                Custom name for your node
    --network <network>             Network to connect to: devnet, bepolia, mainnet (default: devnet)
    --validators <count>            Number of validator nodes (default: 1)
    --full-nodes <count>            Number of full nodes (default: 0)
    --pruned-nodes <count>          Number of pruned nodes (default: 0)
    --docker                        Enable Docker mode
    --wallet-private-key <key>      Private key for the wallet
    --wallet-address <address>      Wallet address
    --wallet-balance <amount>       Initial wallet balance
    --help|-h                       Display this help message

CLIENT.TOML OPTIONS:
    --clienttoml-chain-id <id>                      Chain ID
    --clienttoml-keyring-backend <backend>          Keyring backend
    --clienttoml-keyring-default-keyname <name>     Default keyring keyname
    --clienttoml-output <format>                    Output format
    --clienttoml-node <url>                         Node URL
    --clienttoml-broadcast-mode <mode>              Broadcast mode
    --clienttoml-grpc-address <address>             gRPC address
    --clienttoml-grpc-insecure <bool>               gRPC insecure mode

APP.TOML OPTIONS:
  Base Configuration:
    --apptoml-pruning <strategy>                    Pruning strategy
    --apptoml-pruning-keep-recent <num>             Number of recent states to keep
    --apptoml-pruning-interval <num>                Pruning interval
    --apptoml-halt-height <height>                  Block height to halt
    --apptoml-halt-time <time>                      Time to halt
    --apptoml-min-retain-blocks <num>               Minimum blocks to retain
    --apptoml-inter-block-cache <bool>              Enable inter-block cache
    --apptoml-iavl-cache-size <size>                IAVL cache size
    --apptoml-iavl-disable-fastnode <bool>          Disable IAVL fastnode
    --apptoml-app-db-backend <backend>              Application database backend

  Telemetry Configuration:
    --apptoml-telemetry-service-name <name>         Service name for telemetry
    --apptoml-telemetry-enabled <bool>              Enable telemetry
    --apptoml-telemetry-enable-hostname <bool>      Include hostname in metrics
    --apptoml-telemetry-enable-hostname-label <bool> Enable hostname label
    --apptoml-telemetry-enable-service-label <bool> Enable service label
    --apptoml-telemetry-prometheus-retention-time <time> Prometheus retention time
    --apptoml-telemetry-metrics-sink <sink>         Metrics sink
    --apptoml-telemetry-statsd-addr <address>       StatsD address
    --apptoml-telemetry-datadog-hostname <host>     Datadog hostname

  BeaconKit Configuration:
    --apptoml-beacon-kit-chain-spec <spec>          Chain specification
    --apptoml-beacon-kit-chain-spec-file <file>     Chain specification file
    --apptoml-beacon-kit-shutdown-timeout <time>    Shutdown timeout

  BeaconKit Engine Configuration:
    --apptoml-beacon-kit-engine-rpc-dial-url <url>              Engine RPC dial URL
    --apptoml-beacon-kit-engine-rpc-timeout <time>              Engine RPC timeout
    --apptoml-beacon-kit-engine-rpc-retry-interval <time>       Engine RPC retry interval
    --apptoml-beacon-kit-engine-rpc-max-retry-interval <time>   Engine RPC max retry interval
    --apptoml-beacon-kit-engine-rpc-startup-check-interval <time> Engine startup check interval
    --apptoml-beacon-kit-engine-rpc-jwt-refresh-interval <time> JWT refresh interval
    --apptoml-beacon-kit-engine-jwt-secret-path <path>          JWT secret file path

  BeaconKit Logger Configuration:
    --apptoml-beacon-kit-logger-time-format <format> Logger time format
    --apptoml-beacon-kit-logger-log-level <level>    Logger level
    --apptoml-beacon-kit-logger-style <style>        Logger style

  BeaconKit KZG Configuration:
    --apptoml-beacon-kit-kzg-trusted-setup-path <path> KZG trusted setup path
    --apptoml-beacon-kit-kzg-implementation <impl>     KZG implementation

  BeaconKit Payload Builder Configuration:
    --apptoml-beacon-kit-payload-builder-enabled <bool> Enable payload builder
    --apptoml-beacon-kit-payload-builder-suggested-fee-recipient <address> Fee recipient
    --apptoml-beacon-kit-payload-builder-payload-timeout <time> Payload timeout

  BeaconKit Validator Configuration:
    --apptoml-beacon-kit-validator-graffiti <text>          Validator graffiti
    --apptoml-beacon-kit-validator-availability-window <num> Availability window

  BeaconKit Node API Configuration:
    --apptoml-beacon-kit-node-api-enabled <bool>    Enable node API
    --apptoml-beacon-kit-node-api-address <address> Node API address
    --apptoml-beacon-kit-node-api-logging <bool>    Enable node API logging

CONFIG.TOML OPTIONS:
  Base Configuration:
    --configtoml-version <version>                  Config version
    --configtoml-proxy-app <url>                    Proxy app URL
    --configtoml-db-backend <backend>               Database backend
    --configtoml-db-dir <path>                      Database directory
    --configtoml-log-level <level>                  Log level
    --configtoml-log-format <format>                Log format
    --configtoml-genesis-file <path>                Genesis file path
    --configtoml-priv-validator-key-file <path>     Private validator key file
    --configtoml-priv-validator-state-file <path>   Private validator state file
    --configtoml-priv-validator-laddr <address>     Private validator listen address
    --configtoml-node-key-file <path>               Node key file
    --configtoml-abci <type>                        ABCI type
    --configtoml-filter-peers <bool>                Filter peers

  RPC Server Configuration:
    --configtoml-rpc-laddr <address>                                 RPC listen address
    --configtoml-rpc-unsafe <bool>                                   Enable unsafe RPC
    --configtoml-rpc-cors-allowed-origins <origins>                  CORS allowed origins
    --configtoml-rpc-cors-allowed-methods <methods>                  CORS allowed methods
    --configtoml-rpc-cors-allowed-headers <headers>                  CORS allowed headers
    --configtoml-rpc-max-open-connections <num>                      Max open connections
    --configtoml-rpc-max-subscription-clients <num>                  Max subscription clients
    --configtoml-rpc-max-subscriptions-per-client <num>              Max subscriptions per client
    --configtoml-rpc-experimental-subscription-buffer-size <size>    Subscription buffer size
    --configtoml-rpc-experimental-websocket-write-buffer-size <size> WebSocket write buffer size
    --configtoml-rpc-experimental-close-on-slow-client <bool>        Close on slow client
    --configtoml-rpc-timeout-broadcast-tx-commit <time>              Broadcast TX commit timeout
    --configtoml-rpc-max-request-batch-size <size>                   Max request batch size
    --configtoml-rpc-max-body-bytes <bytes>                          Max body bytes
    --configtoml-rpc-max-header-bytes <bytes>                        Max header bytes
    --configtoml-rpc-tls-cert-file <path>                            TLS certificate file
    --configtoml-rpc-tls-key-file <path>                             TLS key file
    --configtoml-rpc-pprof-laddr <address>                           Pprof listen address

  gRPC Server Configuration:
    --configtoml-grpc-laddr <address>                           gRPC listen address
    --configtoml-grpc-version-service-enabled <bool>            Enable version service
    --configtoml-grpc-block-service-enabled <bool>              Enable block service
    --configtoml-grpc-block-results-service-enabled <bool>      Enable block results service
    --configtoml-grpc-privileged-laddr <address>                Privileged gRPC address
    --configtoml-grpc-privileged-pruning-service-enabled <bool> Enable privileged pruning service

  P2P Configuration:
    --configtoml-p2p-laddr <address>                                        P2P listen address
    --configtoml-p2p-external-address <address>                             External address
    --configtoml-p2p-seeds <peers>                                          Seed nodes
    --configtoml-p2p-persistent-peers <peers>                               Persistent peers
    --configtoml-p2p-addr-book-file <path>                                  Address book file
    --configtoml-p2p-addr-book-strict <bool>                                Strict address book
    --configtoml-p2p-max-num-inbound-peers <num>                            Max inbound peers
    --configtoml-p2p-max-num-outbound-peers <num>                           Max outbound peers
    --configtoml-p2p-unconditional-peer-ids <ids>                           Unconditional peer IDs
    --configtoml-p2p-persistent-peers-max-dial-period <time>                Max dial period
    --configtoml-p2p-flush-throttle-timeout <time>                          Flush throttle timeout
    --configtoml-p2p-max-packet-msg-payload-size <size>                     Max packet message payload size
    --configtoml-p2p-send-rate <rate>                                       Send rate
    --configtoml-p2p-recv-rate <rate>                                       Receive rate
    --configtoml-p2p-pex <bool>                                             Enable peer exchange
    --configtoml-p2p-seed-mode <bool>                                       Seed mode
    --configtoml-p2p-private-peer-ids <ids>                                 Private peer IDs
    --configtoml-p2p-allow-duplicate-ip <bool>                              Allow duplicate IP
    --configtoml-p2p-handshake-timeout <time>                               Handshake timeout
    --configtoml-p2p-dial-timeout <time>                                    Dial timeout

  Mempool Configuration:
    --configtoml-mempool-type <type>                                                        Mempool type
    --configtoml-mempool-recheck <bool>                                                     Enable recheck
    --configtoml-mempool-recheck-timeout <time>                                             Recheck timeout
    --configtoml-mempool-broadcast <bool>                                                   Enable broadcast
    --configtoml-mempool-wal-dir <path>                                                     WAL directory
    --configtoml-mempool-size <size>                                                        Mempool size
    --configtoml-mempool-max-tx-bytes <bytes>                                               Max transaction bytes
    --configtoml-mempool-max-txs-bytes <bytes>                                              Max transactions bytes
    --configtoml-mempool-cache-size <size>                                                  Cache size
    --configtoml-mempool-keep-invalid-txs-in-cache <bool>                                   Keep invalid transactions
    --configtoml-mempool-experimental-max-gossip-connections-to-persistent-peers <num>      Max gossip to persistent peers
    --configtoml-mempool-experimental-max-gossip-connections-to-non-persistent-peers <num>  Max gossip to non-persistent peers

  State Sync Configuration:
    --configtoml-statesync-enable <bool>                 Enable state sync
    --configtoml-statesync-rpc-servers <servers>         RPC servers
    --configtoml-statesync-trust-height <height>         Trust height
    --configtoml-statesync-trust-hash <hash>             Trust hash
    --configtoml-statesync-trust-period <time>           Trust period
    --configtoml-statesync-discovery-time <time>         Discovery time
    --configtoml-statesync-temp-dir <path>               Temp directory
    --configtoml-statesync-chunk-request-timeout <time>  Chunk request timeout
    --configtoml-statesync-chunk-fetchers <num>          Number of chunk fetchers

  Block Sync Configuration:
    --configtoml-blocksync-version <version>    Block sync version

  Consensus Configuration:
    --configtoml-consensus-wal-file <path>                            WAL file
    --configtoml-consensus-timeout-propose <time>                     Propose timeout
    --configtoml-consensus-timeout-propose-delta <time>               Propose delta timeout
    --configtoml-consensus-timeout-prevote <time>                     Prevote timeout
    --configtoml-consensus-timeout-prevote-delta <time>               Prevote delta timeout
    --configtoml-consensus-timeout-precommit <time>                   Precommit timeout
    --configtoml-consensus-timeout-precommit-delta <time>             Precommit delta timeout
    --configtoml-consensus-timeout-commit <time>                      Commit timeout
    --configtoml-consensus-skip-timeout-commit <bool>                 Skip commit timeout
    --configtoml-consensus-double-sign-check-height <height>          Double sign check height
    --configtoml-consensus-create-empty-blocks <bool>                 Create empty blocks
    --configtoml-consensus-create-empty-blocks-interval <time>        Empty blocks interval
    --configtoml-consensus-peer-gossip-sleep-duration <time>          Peer gossip sleep duration
    --configtoml-consensus-peer-gossip-intraloop-sleep-duration <time> Intraloop sleep duration
    --configtoml-consensus-peer-query-maj23-sleep-duration <time>     Query maj23 sleep duration

  Storage Configuration:
    --configtoml-storage-discard-abci-responses <bool>                              Discard ABCI responses
    --configtoml-storage-experimental-db-key-layout <layout>                         DB key layout
    --configtoml-storage-compact <bool>                                              Enable compaction
    --configtoml-storage-compaction-interval <time>                                  Compaction interval
    --configtoml-storage-pruning-interval <time>                                     Pruning interval
    --configtoml-storage-pruning-data-companion-enabled <bool>                       Enable data companion pruning
    --configtoml-storage-pruning-data-companion-initial-block-retain-height <height> Initial block retain height
    --configtoml-storage-pruning-data-companion-initial-block-results-retain-height <height> Initial block results retain height

  Transaction Indexer Configuration:
    --configtoml-tx-index-indexer <indexer>     Transaction indexer
    --configtoml-tx-index-psql-conn <conn>      PostgreSQL connection string

  Instrumentation Configuration:
    --configtoml-instrumentation-prometheus <bool>             Enable Prometheus metrics
    --configtoml-instrumentation-prometheus-listen-addr <addr> Prometheus listen address
    --configtoml-instrumentation-max-open-connections <num>    Max open connections
    --configtoml-instrumentation-namespace <namespace>         Metrics namespace

EXAMPLES:
    beranode init --network devnet --validators 1
    beranode init --moniker mynode --validators 2 --full-nodes 1
    beranode init --network bepolia --validators 1 --wallet-balance 5000000000000000000000000000

For more information, visit: https://github.com/berachain/beranode-cli2
EOF
}

# =============================================================================
# SECTION 2: MAIN INIT COMMAND
# =============================================================================
# The cmd_init function is the entry point for the init command. It orchestrates
# the entire initialization process following the numbered legend above.
# =============================================================================

cmd_init() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: cmd_init" >&2

	# =========================================================================
	# [1] HELP & VALIDATION
	# =========================================================================
	# Check for help flag first before any other processing

	if [[ "$1" == "--help" ]] || [[ "$1" == "-h" ]]; then
		show_init_help
		return 0
	fi

	# Check dependencies - cast version must be supported
	print_header "Checking Dependencies"
	check_cast_version
	if [[ $? -ne 0 ]]; then
		log_error "Cast version is not supported. Please upgrade to version $SUPPORTED_CAST_VERSION or higher."
		return 1
	fi
	log_success "Cast version is supported."

  # Check curl version
  check_curl_version
  if [[ $? -ne 0 ]]; then
    log_error "Curl version is not supported. Please upgrade to version $SUPPORTED_CURL_VERSION or higher."
    return 1
  fi
  log_success "Curl version is supported."

	print_header "Initializing Berachain Node"

  # Check for .tar.gz installed locally
  check_tar_gz_version
  if [[ $? -ne 0 ]]; then
    log_error "Tar.gz version is not supported. Please upgrade to version $SUPPORTED_TAR_GZ_VERSION or higher."
    return 1
  fi
  log_success "Tar.gz version is supported."

	# =========================================================================
	# [2] VARIABLE INITIALIZATION
	# =========================================================================
	# Initialize all configuration variables with defaults from constants.sh

	# General settings
	local moniker="$(generate_random_name)"
	local network=$CHAIN_NAME_DEVNET
	local chain_id=$CHAIN_ID_DEVNET
	local force=false
	local skip_genesis=false
	local total_nodes=0
	local validators=1
	local full_nodes=0
	local pruned_nodes=0
	local docker_mode=false
	local mode="local"
	local wallet_private_key=""
	local wallet_address=""
	local wallet_balance=${DEFAULT_WALLET_BALANCE}
  local beacond_version="latest"
  local berareth_version="latest"

	# Client.toml configuration variables
	local clienttoml_chain_id="${CLIENTTOML_CHAIN_ID}"
	local clienttoml_keyring_backend="${CLIENTTOML_KEYRING_BACKEND}"
	local clienttoml_keyring_default_keyname="${CLIENTTOML_KEYRING_DEFAULT_KEYNAME}"
	local clienttoml_output="${CLIENTTOML_OUTPUT}"
	local clienttoml_node="${CLIENTTOML_NODE}"
	local clienttoml_broadcast_mode="${CLIENTTOML_BROADCAST_MODE}"
	local clienttoml_grpc_address="${CLIENTTOML_GRPC_ADDRESS}"
	local clienttoml_grpc_insecure="${CLIENTTOML_GRPC_INSECURE}"

	# App.toml configuration variables - Base Configuration
	local apptoml_pruning="${APPTOML_PRUNING}"
	local apptoml_pruning_keep_recent="${APPTOML_PRUNING_KEEP_RECENT}"
	local apptoml_pruning_interval="${APPTOML_PRUNING_INTERVAL}"
	local apptoml_halt_height="${APPTOML_HALT_HEIGHT}"
	local apptoml_halt_time="${APPTOML_HALT_TIME}"
	local apptoml_min_retain_blocks="${APPTOML_MIN_RETAIN_BLOCKS}"
	local apptoml_inter_block_cache="${APPTOML_INTER_BLOCK_CACHE}"
	local apptoml_iavl_cache_size="${APPTOML_IAVL_CACHE_SIZE}"
	local apptoml_iavl_disable_fastnode="${APPTOML_IAVL_DISABLE_FASTNODE}"
	local apptoml_app_db_backend="${APPTOML_APP_DB_BACKEND}"

	# App.toml - Telemetry Configuration
	local apptoml_telemetry_service_name="${APPTOML_TELEMETRY_SERVICE_NAME}"
	local apptoml_telemetry_enabled="${APPTOML_TELEMETRY_ENABLED}"
	local apptoml_telemetry_enable_hostname="${APPTOML_TELEMETRY_ENABLE_HOSTNAME}"
	local apptoml_telemetry_enable_hostname_label="${APPTOML_TELEMETRY_ENABLE_HOSTNAME_LABEL}"
	local apptoml_telemetry_enable_service_label="${APPTOML_TELEMETRY_ENABLE_SERVICE_LABEL}"
	local apptoml_telemetry_prometheus_retention_time="${APPTOML_TELEMETRY_PROMETHEUS_RETENTION_TIME}"
	local apptoml_telemetry_global_labels="${APPTOML_TELEMETRY_GLOBAL_LABELS}"
	local apptoml_telemetry_metrics_sink="${APPTOML_TELEMETRY_METRICS_SINK}"
	local apptoml_telemetry_statsd_addr="${APPTOML_TELEMETRY_STATSD_ADDR}"
	local apptoml_telemetry_datadog_hostname="${APPTOML_TELEMETRY_DATADOG_HOSTNAME}"

	# App.toml - BeaconKit Configuration
	local apptoml_beacon_kit_chain_spec="${APPTOML_BEACON_KIT_CHAIN_SPEC}"
	local apptoml_beacon_kit_chain_spec_file="${APPTOML_BEACON_KIT_CHAIN_SPEC_FILE}"
	local apptoml_beacon_kit_shutdown_timeout="${APPTOML_BEACON_KIT_SHUTDOWN_TIMEOUT}"

	# App.toml - BeaconKit Engine Configuration
	local apptoml_beacon_kit_engine_rpc_dial_url="${APPTOML_BEACON_KIT_ENGINE_RPC_DIAL_URL}"
	local apptoml_beacon_kit_engine_rpc_timeout="${APPTOML_BEACON_KIT_ENGINE_RPC_TIMEOUT}"
	local apptoml_beacon_kit_engine_rpc_retry_interval="${APPTOML_BEACON_KIT_ENGINE_RPC_RETRY_INTERVAL}"
	local apptoml_beacon_kit_engine_rpc_max_retry_interval="${APPTOML_BEACON_KIT_ENGINE_RPC_MAX_RETRY_INTERVAL}"
	local apptoml_beacon_kit_engine_rpc_startup_check_interval="${APPTOML_BEACON_KIT_ENGINE_RPC_STARTUP_CHECK_INTERVAL}"
	local apptoml_beacon_kit_engine_rpc_jwt_refresh_interval="${APPTOML_BEACON_KIT_ENGINE_RPC_JWT_REFRESH_INTERVAL}"
	local apptoml_beacon_kit_engine_jwt_secret_path="${APPTOML_BEACON_KIT_ENGINE_JWT_SECRET_PATH}"

	# App.toml - BeaconKit Logger Configuration
	local apptoml_beacon_kit_logger_time_format="${APPTOML_BEACON_KIT_LOGGER_TIME_FORMAT}"
	local apptoml_beacon_kit_logger_log_level="${APPTOML_BEACON_KIT_LOGGER_LOG_LEVEL}"
	local apptoml_beacon_kit_logger_style="${APPTOML_BEACON_KIT_LOGGER_STYLE}"

	# App.toml - BeaconKit KZG Configuration
	local apptoml_beacon_kit_kzg_trusted_setup_path="${APPTOML_BEACON_KIT_KZG_TRUSTED_SETUP_PATH}"
	local apptoml_beacon_kit_kzg_implementation="${APPTOML_BEACON_KIT_KZG_IMPLEMENTATION}"

	# App.toml - BeaconKit Payload Builder Configuration
	local apptoml_beacon_kit_payload_builder_enabled="${APPTOML_BEACON_KIT_PAYLOAD_BUILDER_ENABLED}"
	local apptoml_beacon_kit_payload_builder_suggested_fee_recipient="${APPTOML_BEACON_KIT_PAYLOAD_BUILDER_SUGGESTED_FEE_RECIPIENT}"
	local apptoml_beacon_kit_payload_builder_payload_timeout="${APPTOML_BEACON_KIT_PAYLOAD_BUILDER_PAYLOAD_TIMEOUT}"

	# App.toml - BeaconKit Validator Configuration
	local apptoml_beacon_kit_validator_graffiti="${APPTOML_BEACON_KIT_VALIDATOR_GRAFFITI}"
	local apptoml_beacon_kit_validator_availability_window="${APPTOML_BEACON_KIT_VALIDATOR_AVAILABILITY_WINDOW}"

	# App.toml - BeaconKit Node API Configuration
	local apptoml_beacon_kit_node_api_enabled="${APPTOML_BEACON_KIT_NODE_API_ENABLED}"
	local apptoml_beacon_kit_node_api_address="${APPTOML_BEACON_KIT_NODE_API_ADDRESS}"
	local apptoml_beacon_kit_node_api_logging="${APPTOML_BEACON_KIT_NODE_API_LOGGING}"

	# Config.toml configuration variables - Base Configuration
	local configtoml_version="${CONFIGTOML_VERSION}"
	local configtoml_proxy_app="${CONFIGTOML_PROXY_APP}"
	local configtoml_moniker="${CONFIGTOML_MONIKER}"
	local configtoml_db_backend="${CONFIGTOML_DB_BACKEND}"
	local configtoml_db_dir="${CONFIGTOML_DB_DIR}"
	local configtoml_log_level="${CONFIGTOML_LOG_LEVEL}"
	local configtoml_log_format="${CONFIGTOML_LOG_FORMAT}"
	local configtoml_genesis_file="${CONFIGTOML_GENESIS_FILE}"
	local configtoml_priv_validator_key_file="${CONFIGTOML_PRIV_VALIDATOR_KEY_FILE}"
	local configtoml_priv_validator_state_file="${CONFIGTOML_PRIV_VALIDATOR_STATE_FILE}"
	local configtoml_priv_validator_laddr="${CONFIGTOML_PRIV_VALIDATOR_LADDR}"
	local configtoml_node_key_file="${CONFIGTOML_NODE_KEY_FILE}"
	local configtoml_abci="${CONFIGTOML_ABCI}"
	local configtoml_filter_peers="${CONFIGTOML_FILTER_PEERS}"

	# Config.toml - RPC Server Configuration
	local configtoml_rpc_laddr="${CONFIGTOML_RPC_LADDR}"
	local configtoml_rpc_unsafe="${CONFIGTOML_RPC_UNSAFE}"
	local configtoml_rpc_cors_allowed_origins="$(
		IFS=,
		echo "${CONFIGTOML_RPC_CORS_ALLOWED_ORIGINS[*]}"
	)"
	local configtoml_rpc_cors_allowed_methods="$(
		IFS=,
		echo "${CONFIGTOML_RPC_CORS_ALLOWED_METHODS[*]}"
	)"
	local configtoml_rpc_cors_allowed_headers="$(
		IFS=,
		echo "${CONFIGTOML_RPC_CORS_ALLOWED_HEADERS[*]}"
	)"
	local configtoml_rpc_max_open_connections="${CONFIGTOML_RPC_MAX_OPEN_CONNECTIONS}"
	local configtoml_rpc_max_subscription_clients="${CONFIGTOML_RPC_MAX_SUBSCRIPTION_CLIENTS}"
	local configtoml_rpc_max_subscriptions_per_client="${CONFIGTOML_RPC_MAX_SUBSCRIPTIONS_PER_CLIENT}"
	local configtoml_rpc_experimental_subscription_buffer_size="${CONFIGTOML_RPC_EXPERIMENTAL_SUBSCRIPTION_BUFFER_SIZE}"
	local configtoml_rpc_experimental_websocket_write_buffer_size="${CONFIGTOML_RPC_EXPERIMENTAL_WEBSOCKET_WRITE_BUFFER_SIZE}"
	local configtoml_rpc_experimental_close_on_slow_client="${CONFIGTOML_RPC_EXPERIMENTAL_CLOSE_ON_SLOW_CLIENT}"
	local configtoml_rpc_timeout_broadcast_tx_commit="${CONFIGTOML_RPC_TIMEOUT_BROADCAST_TX_COMMIT}"
	local configtoml_rpc_max_request_batch_size="${CONFIGTOML_RPC_MAX_REQUEST_BATCH_SIZE}"
	local configtoml_rpc_max_body_bytes="${CONFIGTOML_RPC_MAX_BODY_BYTES}"
	local configtoml_rpc_max_header_bytes="${CONFIGTOML_RPC_MAX_HEADER_BYTES}"
	local configtoml_rpc_tls_cert_file="${CONFIGTOML_RPC_TLS_CERT_FILE}"
	local configtoml_rpc_tls_key_file="${CONFIGTOML_RPC_TLS_KEY_FILE}"
	local configtoml_rpc_pprof_laddr="${CONFIGTOML_RPC_PPROF_LADDR}"

	# Config.toml - gRPC Server Configuration
	local configtoml_grpc_laddr="${CONFIGTOML_GRPC_LADDR}"
	local configtoml_grpc_version_service_enabled="${CONFIGTOML_GRPC_VERSION_SERVICE_ENABLED}"
	local configtoml_grpc_block_service_enabled="${CONFIGTOML_GRPC_BLOCK_SERVICE_ENABLED}"
	local configtoml_grpc_block_results_service_enabled="${CONFIGTOML_GRPC_BLOCK_RESULTS_SERVICE_ENABLED}"
	local configtoml_grpc_privileged_laddr="${CONFIGTOML_GRPC_PRIVILEGED_LADDR}"
	local configtoml_grpc_privileged_pruning_service_enabled="${CONFIGTOML_GRPC_PRIVILEGED_PRUNING_SERVICE_ENABLED}"

	# Config.toml - P2P Configuration
	local configtoml_p2p_laddr="${CONFIGTOML_P2P_LADDR}"
	local configtoml_p2p_external_address="${CONFIGTOML_P2P_EXTERNAL_ADDRESS}"
	local configtoml_p2p_seeds="${CONFIGTOML_P2P_SEEDS}"
	local configtoml_p2p_persistent_peers="${CONFIGTOML_P2P_PERSISTENT_PEERS}"
	local configtoml_p2p_addr_book_file="${CONFIGTOML_P2P_ADDR_BOOK_FILE}"
	local configtoml_p2p_addr_book_strict="${CONFIGTOML_P2P_ADDR_BOOK_STRICT}"
	local configtoml_p2p_max_num_inbound_peers="${CONFIGTOML_P2P_MAX_NUM_INBOUND_PEERS}"
	local configtoml_p2p_max_num_outbound_peers="${CONFIGTOML_P2P_MAX_NUM_OUTBOUND_PEERS}"
	local configtoml_p2p_unconditional_peer_ids="${CONFIGTOML_P2P_UNCONDITIONAL_PEER_IDS}"
	local configtoml_p2p_persistent_peers_max_dial_period="${CONFIGTOML_P2P_PERSISTENT_PEERS_MAX_DIAL_PERIOD}"
	local configtoml_p2p_flush_throttle_timeout="${CONFIGTOML_P2P_FLUSH_THROTTLE_TIMEOUT}"
	local configtoml_p2p_max_packet_msg_payload_size="${CONFIGTOML_P2P_MAX_PACKET_MSG_PAYLOAD_SIZE}"
	local configtoml_p2p_send_rate="${CONFIGTOML_P2P_SEND_RATE}"
	local configtoml_p2p_recv_rate="${CONFIGTOML_P2P_RECV_RATE}"
	local configtoml_p2p_pex="${CONFIGTOML_P2P_PEX}"
	local configtoml_p2p_seed_mode="${CONFIGTOML_P2P_SEED_MODE}"
	local configtoml_p2p_private_peer_ids="${CONFIGTOML_P2P_PRIVATE_PEER_IDS}"
	local configtoml_p2p_allow_duplicate_ip="${CONFIGTOML_P2P_ALLOW_DUPLICATE_IP}"
	local configtoml_p2p_handshake_timeout="${CONFIGTOML_P2P_HANDSHAKE_TIMEOUT}"
	local configtoml_p2p_dial_timeout="${CONFIGTOML_P2P_DIAL_TIMEOUT}"

	# Config.toml - Mempool Configuration
	local configtoml_mempool_type="${CONFIGTOML_MEMPOOL_TYPE}"
	local configtoml_mempool_recheck="${CONFIGTOML_MEMPOOL_RECHECK}"
	local configtoml_mempool_recheck_timeout="${CONFIGTOML_MEMPOOL_RECHECK_TIMEOUT}"
	local configtoml_mempool_broadcast="${CONFIGTOML_MEMPOOL_BROADCAST}"
	local configtoml_mempool_wal_dir="${CONFIGTOML_MEMPOOL_WAL_DIR}"
	local configtoml_mempool_size="${CONFIGTOML_MEMPOOL_SIZE}"
	local configtoml_mempool_max_tx_bytes="${CONFIGTOML_MEMPOOL_MAX_TX_BYTES}"
	local configtoml_mempool_max_txs_bytes="${CONFIGTOML_MEMPOOL_MAX_TXS_BYTES}"
	local configtoml_mempool_cache_size="${CONFIGTOML_MEMPOOL_CACHE_SIZE}"
	local configtoml_mempool_keep_invalid_txs_in_cache="${CONFIGTOML_MEMPOOL_KEEP_INVALID_TXS_IN_CACHE}"
	local configtoml_mempool_experimental_max_gossip_connections_to_persistent_peers="${CONFIGTOML_MEMPOOL_EXPERIMENTAL_MAX_GOSSIP_CONNECTIONS_TO_PERSISTENT_PEERS}"
	local configtoml_mempool_experimental_max_gossip_connections_to_non_persistent_peers="${CONFIGTOML_MEMPOOL_EXPERIMENTAL_MAX_GOSSIP_CONNECTIONS_TO_NON_PERSISTENT_PEERS}"

	# Config.toml - State Sync Configuration
	local configtoml_statesync_enable="${CONFIGTOML_STATESYNC_ENABLE}"
	local configtoml_statesync_rpc_servers="${CONFIGTOML_STATESYNC_RPC_SERVERS}"
	local configtoml_statesync_trust_height="${CONFIGTOML_STATESYNC_TRUST_HEIGHT}"
	local configtoml_statesync_trust_hash="${CONFIGTOML_STATESYNC_TRUST_HASH}"
	local configtoml_statesync_trust_period="${CONFIGTOML_STATESYNC_TRUST_PERIOD}"
	local configtoml_statesync_discovery_time="${CONFIGTOML_STATESYNC_DISCOVERY_TIME}"
	local configtoml_statesync_temp_dir="${CONFIGTOML_STATESYNC_TEMP_DIR}"
	local configtoml_statesync_chunk_request_timeout="${CONFIGTOML_STATESYNC_CHUNK_REQUEST_TIMEOUT}"
	local configtoml_statesync_chunk_fetchers="${CONFIGTOML_STATESYNC_CHUNK_FETCHERS}"

	# Config.toml - Block Sync Configuration
	local configtoml_blocksync_version="${CONFIGTOML_BLOCKSYNC_VERSION}"

	# Config.toml - Consensus Configuration
	local configtoml_consensus_wal_file="${CONFIGTOML_CONSENSUS_WAL_FILE}"
	local configtoml_consensus_timeout_propose="${CONFIGTOML_CONSENSUS_TIMEOUT_PROPOSE}"
	local configtoml_consensus_timeout_propose_delta="${CONFIGTOML_CONSENSUS_TIMEOUT_PROPOSE_DELTA}"
	local configtoml_consensus_timeout_prevote="${CONFIGTOML_CONSENSUS_TIMEOUT_PREVOTE}"
	local configtoml_consensus_timeout_prevote_delta="${CONFIGTOML_CONSENSUS_TIMEOUT_PREVOTE_DELTA}"
	local configtoml_consensus_timeout_precommit="${CONFIGTOML_CONSENSUS_TIMEOUT_PRECOMMIT}"
	local configtoml_consensus_timeout_precommit_delta="${CONFIGTOML_CONSENSUS_TIMEOUT_PRECOMMIT_DELTA}"
	local configtoml_consensus_timeout_commit="${CONFIGTOML_CONSENSUS_TIMEOUT_COMMIT}"
	local configtoml_consensus_skip_timeout_commit="${CONFIGTOML_CONSENSUS_SKIP_TIMEOUT_COMMIT}"
	local configtoml_consensus_double_sign_check_height="${CONFIGTOML_CONSENSUS_DOUBLE_SIGN_CHECK_HEIGHT}"
	local configtoml_consensus_create_empty_blocks="${CONFIGTOML_CONSENSUS_CREATE_EMPTY_BLOCKS}"
	local configtoml_consensus_create_empty_blocks_interval="${CONFIGTOML_CONSENSUS_CREATE_EMPTY_BLOCKS_INTERVAL}"
	local configtoml_consensus_peer_gossip_sleep_duration="${CONFIGTOML_CONSENSUS_PEER_GOSSIP_SLEEP_DURATION}"
	local configtoml_consensus_peer_gossip_intraloop_sleep_duration="${CONFIGTOML_CONSENSUS_PEER_GOSSIP_INTRALOOP_SLEEP_DURATION}"
	local configtoml_consensus_peer_query_maj23_sleep_duration="${CONFIGTOML_CONSENSUS_PEER_QUERY_MAJ23_SLEEP_DURATION}"

	# Config.toml - Storage Configuration
	local configtoml_storage_discard_abci_responses="${CONFIGTOML_STORAGE_DISCARD_ABCI_RESPONSES}"
	local configtoml_storage_experimental_db_key_layout="${CONFIGTOML_STORAGE_EXPERIMENTAL_DB_KEY_LAYOUT}"
	local configtoml_storage_compact="${CONFIGTOML_STORAGE_COMPACT}"
	local configtoml_storage_compaction_interval="${CONFIGTOML_STORAGE_COMPACTION_INTERVAL}"
	local configtoml_storage_pruning_interval="${CONFIGTOML_STORAGE_PRUNING_INTERVAL}"
	local configtoml_storage_pruning_data_companion_enabled="${CONFIGTOML_STORAGE_PRUNING_DATA_COMPANION_ENABLED}"
	local configtoml_storage_pruning_data_companion_initial_block_retain_height="${CONFIGTOML_STORAGE_PRUNING_DATA_COMPANION_INITIAL_BLOCK_RETAIN_HEIGHT}"
	local configtoml_storage_pruning_data_companion_initial_block_results_retain_height="${CONFIGTOML_STORAGE_PRUNING_DATA_COMPANION_INITIAL_BLOCK_RESULTS_RETAIN_HEIGHT}"

	# Config.toml - Transaction Indexer Configuration
	local configtoml_tx_index_indexer="${CONFIGTOML_TX_INDEX_INDEXER}"
	local configtoml_tx_index_psql_conn="${CONFIGTOML_TX_INDEX_PSQL_CONN}"

	# Config.toml - Instrumentation Configuration
	local configtoml_instrumentation_prometheus="${CONFIGTOML_INSTRUMENTATION_PROMETHEUS}"
	local configtoml_instrumentation_prometheus_listen_addr="${CONFIGTOML_INSTRUMENTATION_PROMETHEUS_LISTEN_ADDR}"
	local configtoml_instrumentation_max_open_connections="${CONFIGTOML_INSTRUMENTATION_MAX_OPEN_CONNECTIONS}"
	local configtoml_instrumentation_namespace="${CONFIGTOML_INSTRUMENTATION_NAMESPACE}"

	# =========================================================================
	# [3] ARGUMENT PARSING
	# =========================================================================
	# Parse all command-line arguments and override default values

	while [[ $# -gt 0 ]]; do
		case "$1" in
    --beacond-version)
      if [[ -n "$2" ]]; then
        check_beacond_version="$2"
        if [[ ! "$check_beacond_version" =~ ^(latest|v\.?[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+(\.[0-9]+)?)?)$ ]]; then
          log_warn "--beacond-version must match format (latest or v<MAJ>.<MIN>.<PATCH> or v<MAJ>.<MIN>.<PATCH>-rc<N>) (e.g., latest, v0.6.0, v0.6.0-rc2)"
          log_warn "defaulting to ${beacond_version}..."
        else
          beacond_version="$check_beacond_version"
        fi
        log_info "Using beacond version: $beacond_version"
        shift 2
      else
        log_warn "--beacond-version is not set. defaulting to ${beacond_version}"
        shift
      fi
      ;;
    --berareth-version)
      if [[ -n "$2" ]]; then
        check_berareth_version="$2"
        if [[ ! "$check_berareth_version" =~ ^(latest|v\.?[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+(\.[0-9]+)?)?)$ ]]; then
          log_warn "--berareth-version must match format (latest or v<MAJ>.<MIN>.<PATCH> or v<MAJ>.<MIN>.<PATCH>-rc<N>) (e.g., latest, v0.6.0, v0.6.0-rc2)"
          log_warn "defaulting to ${berareth_version}..."
        else
          berareth_version="$check_berareth_version"
        fi
        log_info "Using berareth version: $berareth_version"
        shift 2
      else
        log_warn "--berareth-version is not set. defaulting to ${berareth_version}"
        shift
      fi
      ;;
		--beranodes-dir)
			if [[ -n "$2" ]]; then
				BERANODES_PATH="$2"
				shift 2
			else
				log_warn "--beranodes-dir is not set. defaulting to ${BERANODES_PATH:-$(pwd)/beranodes}"
				shift
			fi
			;;
		--docker)
			docker_mode=true
			mode="docker"
			shift
			;;
		--moniker)
			if [[ -n "$2" ]]; then
				moniker="$2"
				configtoml_moniker="$2"
				shift 2
			else
				log_warn "--moniker is not set. defaulting to a random name"
				moniker="$(generate_random_name)"
				configtoml_moniker="$moniker"
				shift
			fi
			;;
		--network)
			if [[ -n "$2" ]]; then
				network="$2"
				if [[ "$network" == "$CHAIN_NAME_DEVNET" ]]; then
					chain_id=$CHAIN_ID_DEVNET
					shift 2
				elif [[ "$network" == "$CHAIN_NAME_TESTNET" ]]; then
					chain_id=$CHAIN_ID_TESTNET
					shift 2
				elif [[ "$network" == "$CHAIN_NAME_MAINNET" ]]; then
					chain_id=$CHAIN_ID_MAINNET
					shift 2
				else
					log_warn "Unknown network: $network. Defaulting to $CHAIN_NAME_DEVNET"
					network=$CHAIN_NAME_DEVNET
					chain_id=$CHAIN_ID_DEVNET
					shift 2
				fi
			else
				shift
			fi
			;;
		--validators)
			if [[ -n "$2" ]]; then
				validators="$2"
				shift 2
			else
				shift
			fi
			;;
		--full-nodes)
			if [[ -n "$2" ]]; then
				full_nodes="$2"
				shift 2
			else
				log_warn "--full-nodes is not set. defaulting to 0"
				full_nodes=0
			fi
			;;
		--pruned-nodes)
			if [[ -n "$2" ]]; then
				pruned_nodes="$2"
				shift 2
			else
				shift
			fi
			;;
		--wallet-private-key)
			if [[ -n "$2" ]]; then
				wallet_private_key="$2"
				shift 2
			else
				shift
			fi
			;;
		--wallet-address)
			if [[ -n "$2" ]]; then
				wallet_address="$2"
				shift 2
			else
				shift
			fi
			;;
		--wallet-balance)
			if [[ -n "$2" ]]; then
				wallet_balance="$2"
				shift 2
			else
				wallet_balance=${DEFAULT_WALLET_BALANCE}
				shift 2
			fi
			;;
		# client.toml configuration variables
		--clienttoml-chain-id)
			if [[ -n "$2" ]]; then
				clienttoml_chain_id="$2"
				shift 2
			else
				clienttoml_chain_id="${CLIENTTOML_CHAIN_ID}"
				shift
			fi
			;;
		--clienttoml-keyring-backend)
			if [[ -n "$2" ]]; then
				clienttoml_keyring_backend="$2"
				shift 2
			else
				clienttoml_keyring_backend="${CLIENTTOML_KEYRING_BACKEND}"
				shift
			fi
			;;
		--clienttoml-keyring-default-keyname)
			if [[ -n "$2" ]]; then
				clienttoml_keyring_default_keyname="$2"
				shift 2
			else
				clienttoml_keyring_default_keyname="${CLIENTTOML_KEYRING_DEFAULT_KEYNAME}"
				shift
			fi
			;;
		--clienttoml-output)
			if [[ -n "$2" ]]; then
				clienttoml_output="$2"
				shift 2
			else
				clienttoml_output="${CLIENTTOML_OUTPUT}"
				shift
			fi
			;;
		--clienttoml-node)
			if [[ -n "$2" ]]; then
				clienttoml_node="$2"
				shift 2
			else
				clienttoml_node="${CLIENTTOML_NODE}"
				shift
			fi
			;;
		--clienttoml-broadcast-mode)
			if [[ -n "$2" ]]; then
				clienttoml_broadcast_mode="$2"
				shift 2
			else
				clienttoml_broadcast_mode="${CLIENTTOML_BROADCAST_MODE}"
				shift
			fi
			;;
		--clienttoml-grpc-address)
			if [[ -n "$2" ]]; then
				clienttoml_grpc_address="$2"
				shift 2
			else
				clienttoml_grpc_address="${CLIENTTOML_GRPC_ADDRESS}"
				shift
			fi
			;;
		--clienttoml-grpc-insecure)
			if [[ -n "$2" ]]; then
				clienttoml_grpc_insecure="$2"
				shift 2
			else
				clienttoml_grpc_insecure="${CLIENTTOML_GRPC_INSECURE}"
				shift
			fi
			;;
		# app.toml configuration variables
		--apptoml-pruning)
			if [[ -n "$2" ]]; then
				apptoml_pruning="$2"
				shift 2
			else
				apptoml_pruning="${APPTOML_PRUNING}"
				shift
			fi
			;;
		--apptoml-pruning-keep-recent)
			if [[ -n "$2" ]]; then
				apptoml_pruning_keep_recent="$2"
				shift 2
			else
				apptoml_pruning_keep_recent="${APPTOML_PRUNING_KEEP_RECENT}"
				shift
			fi
			;;
		--apptoml-pruning-interval)
			if [[ -n "$2" ]]; then
				apptoml_pruning_interval="$2"
				shift 2
			else
				apptoml_pruning_interval="${APPTOML_PRUNING_INTERVAL}"
				shift
			fi
			;;
		--apptoml-halt-height)
			if [[ -n "$2" ]]; then
				apptoml_halt_height="$2"
				shift 2
			else
				apptoml_halt_height="${APPTOML_HALT_HEIGHT}"
				shift
			fi
			;;
		--apptoml-halt-time)
			if [[ -n "$2" ]]; then
				apptoml_halt_time="$2"
				shift 2
			else
				apptoml_halt_time="${APPTOML_HALT_TIME}"
				shift
			fi
			;;
		--apptoml-min-retain-blocks)
			if [[ -n "$2" ]]; then
				apptoml_min_retain_blocks="$2"
				shift 2
			else
				apptoml_min_retain_blocks="${APPTOML_MIN_RETAIN_BLOCKS}"
				shift
			fi
			;;
		--apptoml-inter-block-cache)
			if [[ -n "$2" ]]; then
				apptoml_inter_block_cache="$2"
				shift 2
			else
				apptoml_inter_block_cache="${APPTOML_INTER_BLOCK_CACHE}"
				shift
			fi
			;;
		--apptoml-iavl-cache-size)
			if [[ -n "$2" ]]; then
				apptoml_iavl_cache_size="$2"
				shift 2
			else
				apptoml_iavl_cache_size="${APPTOML_IAVL_CACHE_SIZE}"
				shift
			fi
			;;
		--apptoml-iavl-disable-fastnode)
			if [[ -n "$2" ]]; then
				apptoml_iavl_disable_fastnode="$2"
				shift 2
			else
				apptoml_iavl_disable_fastnode="${APPTOML_IAVL_DISABLE_FASTNODE}"
				shift
			fi
			;;
		--apptoml-app-db-backend)
			if [[ -n "$2" ]]; then
				apptoml_app_db_backend="$2"
				shift 2
			else
				apptoml_app_db_backend="${APPTOML_APP_DB_BACKEND}"
				shift
			fi
			;;
		# - Telemetry Configuration
		--apptoml-telemetry-service-name)
			if [[ -n "$2" ]]; then
				apptoml_telemetry_service_name="$2"
				shift 2
			else
				apptoml_telemetry_service_name="${APPTOML_TELEMETRY_SERVICE_NAME}"
				shift
			fi
			;;
		--apptoml-telemetry-enabled)
			if [[ -n "$2" ]]; then
				apptoml_telemetry_enabled="$2"
				shift 2
			else
				apptoml_telemetry_enabled="${APPTOML_TELEMETRY_ENABLED}"
				shift
			fi
			;;
		--apptoml-telemetry-enable-hostname)
			if [[ -n "$2" ]]; then
				apptoml_telemetry_enable_hostname="$2"
				shift 2
			else
				apptoml_telemetry_enable_hostname="${APPTOML_TELEMETRY_ENABLE_HOSTNAME}"
				shift
			fi
			;;
		--apptoml-telemetry-enable-hostname-label)
			if [[ -n "$2" ]]; then
				apptoml_telemetry_enable_hostname_label="$2"
				shift 2
			else
				apptoml_telemetry_enable_hostname_label="${APPTOML_TELEMETRY_ENABLE_HOSTNAME_LABEL}"
				shift
			fi
			;;
		--apptoml-telemetry-enable-service-label)
			if [[ -n "$2" ]]; then
				apptoml_telemetry_enable_service_label="$2"
				shift 2
			else
				apptoml_telemetry_enable_service_label="${APPTOML_TELEMETRY_ENABLE_SERVICE_LABEL}"
				shift
			fi
			;;
		--apptoml-telemetry-prometheus-retention-time)
			if [[ -n "$2" ]]; then
				apptoml_telemetry_prometheus_retention_time="$2"
				shift 2
			else
				apptoml_telemetry_prometheus_retention_time="${APPTOML_TELEMETRY_PROMETHEUS_RETENTION_TIME}"
				shift
			fi
			;;
		--apptoml-telemetry-metrics-sink)
			if [[ -n "$2" ]]; then
				apptoml_telemetry_metrics_sink="$2"
				shift 2
			else
				apptoml_telemetry_metrics_sink="${APPTOML_TELEMETRY_METRICS_SINK}"
				shift
			fi
			;;
		--apptoml-telemetry-statsd-addr)
			if [[ -n "$2" ]]; then
				apptoml_telemetry_statsd_addr="$2"
				shift 2
			else
				apptoml_telemetry_statsd_addr="${APPTOML_TELEMETRY_STATSD_ADDR}"
				shift
			fi
			;;
		--apptoml-telemetry-datadog-hostname)
			if [[ -n "$2" ]]; then
				apptoml_telemetry_datadog_hostname="$2"
				shift 2
			else
				apptoml_telemetry_datadog_hostname="${APPTOML_TELEMETRY_DATADOG_HOSTNAME}"
				shift
			fi
			;;
		# - BeacondKit Configuration
		--apptoml-beacon-kit-chain-spec)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_chain_spec="$2"
				shift 2
			else
				apptoml_beacon_kit_chain_spec="${APPTOML_BEACON_KIT_CHAIN_SPEC}"
				shift
			fi
			;;
		--apptoml-beacon-kit-chain-spec-file)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_chain_spec_file="$2"
				shift 2
			else
				apptoml_beacon_kit_chain_spec_file="${APPTOML_BEACON_KIT_CHAIN_SPEC_FILE}"
				shift
			fi
			;;
		--apptoml-beacon-kit-shutdown-timeout)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_shutdown_timeout="$2"
				shift 2
			else
				apptoml_beacon_kit_shutdown_timeout="${APPTOML_BEACON_KIT_SHUTDOWN_TIMEOUT}"
				shift
			fi
			;;
		# - BeaconKit Engine Configuration
		--apptoml-beacon-kit-engine-rpc-dial-url)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_engine_rpc_dial_url="$2"
				shift 2
			else
				apptoml_beacon_kit_engine_rpc_dial_url="${APPTOML_BEACON_KIT_ENGINE_RPC_DIAL_URL}"
				shift
			fi
			;;
		--apptoml-beacon-kit-engine-rpc-timeout)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_engine_rpc_timeout="$2"
				shift 2
			else
				apptoml_beacon_kit_engine_rpc_timeout="${APPTOML_BEACON_KIT_ENGINE_RPC_TIMEOUT}"
				shift
			fi
			;;
		--apptoml-beacon-kit-engine-rpc-retry-interval)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_engine_rpc_retry_interval="$2"
				shift 2
			else
				apptoml_beacon_kit_engine_rpc_retry_interval="${APPTOML_BEACON_KIT_ENGINE_RPC_RETRY_INTERVAL}"
				shift
			fi
			;;
		--apptoml-beacon-kit-engine-rpc-max-retry-interval)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_engine_rpc_max_retry_interval="$2"
				shift 2
			else
				apptoml_beacon_kit_engine_rpc_max_retry_interval="${APPTOML_BEACON_KIT_ENGINE_RPC_MAX_RETRY_INTERVAL}"
				shift
			fi
			;;
		--apptoml-beacon-kit-engine-rpc-startup-check-interval)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_engine_rpc_startup_check_interval="$2"
				shift 2
			else
				apptoml_beacon_kit_engine_rpc_startup_check_interval="${APPTOML_BEACON_KIT_ENGINE_RPC_STARTUP_CHECK_INTERVAL}"
				shift
			fi
			;;
		--apptoml-beacon-kit-engine-rpc-jwt-refresh-interval)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_engine_rpc_jwt_refresh_interval="$2"
				shift 2
			else
				apptoml_beacon_kit_engine_rpc_jwt_refresh_interval="${APPTOML_BEACON_KIT_ENGINE_RPC_JWT_REFRESH_INTERVAL}"
				shift
			fi
			;;
		--apptoml-beacon-kit-engine-jwt-secret-path)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_engine_jwt_secret_path="$2"
				shift 2
			else
				apptoml_beacon_kit_engine_jwt_secret_path="${APPTOML_BEACON_KIT_ENGINE_JWT_SECRET_PATH}"
				shift
			fi
			;;
		# - BeaconKit Logger Configuration
		--apptoml-beacon-kit-logger-time-format)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_logger_time_format="$2"
				shift 2
			else
				apptoml_beacon_kit_logger_time_format="${APPTOML_BEACON_KIT_LOGGER_TIME_FORMAT}"
				shift
			fi
			;;
		--apptoml-beacon-kit-logger-log-level)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_logger_log_level="$2"
				shift 2
			else
				apptoml_beacon_kit_logger_log_level="${APPTOML_BEACON_KIT_LOGGER_LOG_LEVEL}"
				shift
			fi
			;;
		--apptoml-beacon-kit-logger-style)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_logger_style="$2"
				shift 2
			else
				apptoml_beacon_kit_logger_style="${APPTOML_BEACON_KIT_LOGGER_STYLE}"
				shift
			fi
			;;
		# - BeaconKit KZG Configuration
		--apptoml-beacon-kit-kzg-trusted-setup-path)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_kzg_trusted_setup_path="$2"
				shift 2
			else
				apptoml_beacon_kit_kzg_trusted_setup_path="${APPTOML_BEACON_KIT_KZG_TRUSTED_SETUP_PATH}"
				shift
			fi
			;;
		--apptoml-beacon-kit-kzg-implementation)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_kzg_implementation="$2"
				shift 2
			else
				apptoml_beacon_kit_kzg_implementation="${APPTOML_BEACON_KIT_KZG_IMPLEMENTATION}"
				shift
			fi
			;;
		# - BeaconKit Payload Builder Configuration
		--apptoml-beacon-kit-payload-builder-enabled)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_payload_builder_enabled="$2"
				shift 2
			else
				apptoml_beacon_kit_payload_builder_enabled="${APPTOML_BEACON_KIT_PAYLOAD_BUILDER_ENABLED}"
				shift
			fi
			;;
		--apptoml-beacon-kit-payload-builder-suggested-fee-recipient)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_payload_builder_suggested_fee_recipient="$2"
				shift 2
			else
				apptoml_beacon_kit_payload_builder_suggested_fee_recipient="${APPTOML_BEACON_KIT_PAYLOAD_BUILDER_SUGGESTED_FEE_RECIPIENT}"
				shift
			fi
			;;
		--apptoml-beacon-kit-payload-builder-payload-timeout)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_payload_builder_payload_timeout="$2"
				shift 2
			else
				apptoml_beacon_kit_payload_builder_payload_timeout="${APPTOML_BEACON_KIT_PAYLOAD_BUILDER_PAYLOAD_TIMEOUT}"
				shift
			fi
			;;
		--apptoml-beacon-kit-validator-graffiti)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_validator_graffiti="$2"
				shift 2
			else
				apptoml_beacon_kit_validator_graffiti="${APPTOML_BEACON_KIT_VALIDATOR_GRAFFITI}"
				shift
			fi
			;;
		--apptoml-beacon-kit-validator-availability-window)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_validator_availability_window="$2"
				shift 2
			else
				apptoml_beacon_kit_validator_availability_window="${APPTOML_BEACON_KIT_VALIDATOR_AVAILABILITY_WINDOW}"
				shift
			fi
			;;
		# - BeaconKit Validator Configuration
		--apptoml-beacon-kit-node-api-enabled)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_node_api_enabled="$2"
				shift 2
			else
				apptoml_beacon_kit_node_api_enabled="${APPTOML_BEACON_KIT_NODE_API_ENABLED}"
				shift
			fi
			;;
		--apptoml-beacon-kit-node-api-address)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_node_api_address="$2"
				shift 2
			else
				apptoml_beacon_kit_node_api_address="${APPTOML_BEACON_KIT_NODE_API_ADDRESS}"
				shift
			fi
			;;
		--apptoml-beacon-kit-node-api-logging)
			if [[ -n "$2" ]]; then
				apptoml_beacon_kit_node_api_logging="$2"
				shift 2
			else
				apptoml_beacon_kit_node_api_logging="${APPTOML_BEACON_KIT_NODE_API_LOGGING}"
				shift
			fi
			;;
		# config.toml configuration variables
		--configtoml-version)
			if [[ -n "$2" ]]; then
				configtoml_version="$2"
				shift 2
			else
				configtoml_version="${CONFIGTOML_VERSION}"
				shift
			fi
			;;
		--configtoml-proxy-app)
			if [[ -n "$2" ]]; then
				configtoml_proxy_app="$2"
				shift 2
			else
				configtoml_proxy_app="${CONFIGTOML_PROXY_APP}"
				shift
			fi
			;;
		# --configtoml-moniker)
		#     if [[ -n "$2" ]]; then configtoml_moniker="$2"; shift 2; else configtoml_moniker="${CONFIGTOML_MONIKER}"; shift; fi ;;
		--configtoml-db-backend)
			if [[ -n "$2" ]]; then
				configtoml_db_backend="$2"
				shift 2
			else
				configtoml_db_backend="${CONFIGTOML_DB_BACKEND}"
				shift
			fi
			;;
		--configtoml-db-dir)
			if [[ -n "$2" ]]; then
				configtoml_db_dir="$2"
				shift 2
			else
				configtoml_db_dir="${CONFIGTOML_DB_DIR}"
				shift
			fi
			;;
		--configtoml-log-level)
			if [[ -n "$2" ]]; then
				configtoml_log_level="$2"
				shift 2
			else
				configtoml_log_level="${CONFIGTOML_LOG_LEVEL}"
				shift
			fi
			;;
		--configtoml-log-format)
			if [[ -n "$2" ]]; then
				configtoml_log_format="$2"
				shift 2
			else
				configtoml_log_format="${CONFIGTOML_LOG_FORMAT}"
				shift
			fi
			;;
		--configtoml-genesis-file)
			if [[ -n "$2" ]]; then
				configtoml_genesis_file="$2"
				shift 2
			else
				configtoml_genesis_file="${CONFIGTOML_GENESIS_FILE}"
				shift
			fi
			;;
		--configtoml-priv-validator-key-file)
			if [[ -n "$2" ]]; then
				configtoml_priv_validator_key_file="$2"
				shift 2
			else
				configtoml_priv_validator_key_file="${CONFIGTOML_PRIV_VALIDATOR_KEY_FILE}"
				shift
			fi
			;;
		--configtoml-priv-validator-state-file)
			if [[ -n "$2" ]]; then
				configtoml_priv_validator_state_file="$2"
				shift 2
			else
				configtoml_priv_validator_state_file="${CONFIGTOML_PRIV_VALIDATOR_STATE_FILE}"
				shift
			fi
			;;
		--configtoml-priv-validator-laddr)
			if [[ -n "$2" ]]; then
				configtoml_priv_validator_laddr="$2"
				shift 2
			else
				configtoml_priv_validator_laddr="${CONFIGTOML_PRIV_VALIDATOR_LADDR}"
				shift
			fi
			;;
		--configtoml-node-key-file)
			if [[ -n "$2" ]]; then
				configtoml_node_key_file="$2"
				shift 2
			else
				configtoml_node_key_file="${CONFIGTOML_NODE_KEY_FILE}"
				shift
			fi
			;;
		--configtoml-abci)
			if [[ -n "$2" ]]; then
				configtoml_abci="$2"
				shift 2
			else
				configtoml_abci="${CONFIGTOML_ABCI}"
				shift
			fi
			;;
		--configtoml-filter-peers)
			if [[ -n "$2" ]]; then
				configtoml_filter_peers="$2"
				shift 2
			else
				configtoml_filter_peers="${CONFIGTOML_FILTER_PEERS}"
				shift
			fi
			;;
		# - RPC Server Configuration
		--configtoml-rpc-laddr)
			if [[ -n "$2" ]]; then
				configtoml_rpc_laddr="$2"
				shift 2
			else
				configtoml_rpc_laddr="${CONFIGTOML_RPC_LADDR}"
				shift
			fi
			;;
		--configtoml-rpc-unsafe)
			if [[ -n "$2" ]]; then
				configtoml_rpc_unsafe="$2"
				shift 2
			else
				configtoml_rpc_unsafe="${CONFIGTOML_RPC_UNSAFE}"
				shift
			fi
			;;
		--configtoml-rpc-cors-allowed-origins)
			if [[ -n "$2" ]]; then
				configtoml_rpc_cors_allowed_origins="$2"
				shift 2
			else
				configtoml_rpc_cors_allowed_origins="${CONFIGTOML_RPC_CORS_ALLOWED_ORIGINS}"
				shift
			fi
			;;
		--configtoml-rpc-cors-allowed-methods)
			if [[ -n "$2" ]]; then
				configtoml_rpc_cors_allowed_methods="$2"
				shift 2
			else
				configtoml_rpc_cors_allowed_methods="${CONFIGTOML_RPC_CORS_ALLOWED_METHODS}"
				shift
			fi
			;;
		--configtoml-rpc-cors-allowed-methods)
			if [[ -n "$2" ]]; then
				configtoml_rpc_cors_allowed_headers="$2"
				shift 2
			else
				configtoml_rpc_cors_allowed_headers="${CONFIGTOML_RPC_CORS_ALLOWED_HEADERS}"
				shift
			fi
			;;
		--configtoml-rpc-max-open-connections)
			if [[ -n "$2" ]]; then
				configtoml_rpc_max_open_connections="$2"
				shift 2
			else
				configtoml_rpc_max_open_connections="${CONFIGTOML_RPC_MAX_OPEN_CONNECTIONS}"
				shift
			fi
			;;
		--configtoml-rpc-max-subscription-clients)
			if [[ -n "$2" ]]; then
				configtoml_rpc_max_subscription_clients="$2"
				shift 2
			else
				configtoml_rpc_max_subscription_clients="${CONFIGTOML_RPC_MAX_SUBSCRIPTION_CLIENTS}"
				shift
			fi
			;;
		--configtoml-rpc-max-subscriptions-per-client)
			if [[ -n "$2" ]]; then
				configtoml_rpc_max_subscriptions_per_client="$2"
				shift 2
			else
				configtoml_rpc_max_subscriptions_per_client="${CONFIGTOML_RPC_MAX_SUBSCRIPTIONS_PER_CLIENT}"
				shift
			fi
			;;
		--configtoml-rpc-experimental-subscription-buffer-size)
			if [[ -n "$2" ]]; then
				configtoml_rpc_experimental_subscription_buffer_size="$2"
				shift 2
			else
				configtoml_rpc_experimental_subscription_buffer_size="${CONFIGTOML_RPC_EXPERIMENTAL_SUBSCRIPTION_BUFFER_SIZE}"
				shift
			fi
			;;
		--configtoml-rpc-experimental-websocket-write-buffer-size)
			if [[ -n "$2" ]]; then
				configtoml_rpc_experimental_websocket_write_buffer_size="$2"
				shift 2
			else
				configtoml_rpc_experimental_websocket_write_buffer_size="${CONFIGTOML_RPC_EXPERIMENTAL_WEBSOCKET_WRITE_BUFFER_SIZE}"
				shift
			fi
			;;
		--configtoml-rpc-experimental-close-on-slow-client)
			if [[ -n "$2" ]]; then
				configtoml_rpc_experimental_close_on_slow_client="$2"
				shift 2
			else
				configtoml_rpc_experimental_close_on_slow_client="${CONFIGTOML_RPC_EXPERIMENTAL_CLOSE_ON_SLOW_CLIENT}"
				shift
			fi
			;;
		--configtoml-rpc-timeout-broadcast-tx-commit)
			if [[ -n "$2" ]]; then
				configtoml_rpc_timeout_broadcast_tx_commit="$2"
				shift 2
			else
				configtoml_rpc_timeout_broadcast_tx_commit="${CONFIGTOML_RPC_TIMEOUT_BROADCAST_TX_COMMIT}"
				shift
			fi
			;;
		--configtoml-rpc-max-request-batch-size)
			if [[ -n "$2" ]]; then
				configtoml_rpc_max_request_batch_size="$2"
				shift 2
			else
				configtoml_rpc_max_request_batch_size="${CONFIGTOML_RPC_MAX_REQUEST_BATCH_SIZE}"
				shift
			fi
			;;
		--configtoml-rpc-max-body-bytes)
			if [[ -n "$2" ]]; then
				configtoml_rpc_max_body_bytes="$2"
				shift 2
			else
				configtoml_rpc_max_body_bytes="${CONFIGTOML_RPC_MAX_BODY_BYTES}"
				shift
			fi
			;;
		--configtoml-rpc-max-header-bytes)
			if [[ -n "$2" ]]; then
				configtoml_rpc_max_header_bytes="$2"
				shift 2
			else
				configtoml_rpc_max_header_bytes="${CONFIGTOML_RPC_MAX_HEADER_BYTES}"
				shift
			fi
			;;
		--configtoml-rpc-tls-cert-file)
			if [[ -n "$2" ]]; then
				configtoml_rpc_tls_cert_file="$2"
				shift 2
			else
				configtoml_rpc_tls_cert_file="${CONFIGTOML_RPC_TLS_CERT_FILE}"
				shift
			fi
			;;
		--configtoml-rpc-tls-key-file)
			if [[ -n "$2" ]]; then
				configtoml_rpc_tls_key_file="$2"
				shift 2
			else
				configtoml_rpc_tls_key_file="${CONFIGTOML_RPC_TLS_KEY_FILE}"
				shift
			fi
			;;
		--configtoml-rpc-pprof-laddr)
			if [[ -n "$2" ]]; then
				configtoml_rpc_pprof_laddr="$2"
				shift 2
			else
				configtoml_rpc_pprof_laddr="${CONFIGTOML_RPC_PPROF_LADDR}"
				shift
			fi
			;;
		# - gRPC Server Configuration
		--configtoml-grpc-laddr)
			if [[ -n "$2" ]]; then
				configtoml_grpc_laddr="$2"
				shift 2
			else
				configtoml_grpc_laddr="${CONFIGTOML_GRPC_LADDR}"
				shift
			fi
			;;
		--configtoml-grpc-version-service-enabled)
			if [[ -n "$2" ]]; then
				configtoml_grpc_version_service_enabled="$2"
				shift 2
			else
				configtoml_grpc_version_service_enabled="${CONFIGTOML_GRPC_VERSION_SERVICE_ENABLED}"
				shift
			fi
			;;
		--configtoml-grpc-block-service-enabled)
			if [[ -n "$2" ]]; then
				configtoml_grpc_block_service_enabled="$2"
				shift 2
			else
				configtoml_grpc_block_service_enabled="${CONFIGTOML_GRPC_BLOCK_SERVICE_ENABLED}"
				shift
			fi
			;;
		--configtoml-grpc-block-results-service-enabled)
			if [[ -n "$2" ]]; then
				configtoml_grpc_block_results_service_enabled="$2"
				shift 2
			else
				configtoml_grpc_block_results_service_enabled="${CONFIGTOML_GRPC_BLOCK_RESULTS_SERVICE_ENABLED}"
				shift
			fi
			;;
		--configtoml-grpc-privileged-laddr)
			if [[ -n "$2" ]]; then
				configtoml_grpc_privileged_laddr="$2"
				shift 2
			else
				configtoml_grpc_privileged_laddr="${CONFIGTOML_GRPC_PRIVILEGED_LADDR}"
				shift
			fi
			;;
		--configtoml-grpc-privileged-pruning-service-enabled)
			if [[ -n "$2" ]]; then
				configtoml_grpc_privileged_pruning_service_enabled="$2"
				shift 2
			else
				configtoml_grpc_privileged_pruning_service_enabled="${CONFIGTOML_GRPC_PRIVILEGED_PRUNING_SERVICE_ENABLED}"
				shift
			fi
			;;
		# - P2P Configuration
		--configtoml-p2p-laddr)
			if [[ -n "$2" ]]; then
				configtoml_p2p_laddr="$2"
				shift 2
			else
				configtoml_p2p_laddr="${CONFIGTOML_P2P_LADDR}"
				shift
			fi
			;;
		--configtoml-p2p-external-address)
			if [[ -n "$2" ]]; then
				configtoml_p2p_external_address="$2"
				shift 2
			else
				configtoml_p2p_external_address="${CONFIGTOML_P2P_EXTERNAL_ADDRESS}"
				shift
			fi
			;;
		--configtoml-p2p-seeds)
			if [[ -n "$2" ]]; then
				configtoml_p2p_seeds="$2"
				shift 2
			else
				configtoml_p2p_seeds="${CONFIGTOML_P2P_SEEDS}"
				shift
			fi
			;;
		--configtoml-p2p-persistent-peers)
			if [[ -n "$2" ]]; then
				configtoml_p2p_persistent_peers="$2"
				shift 2
			else
				configtoml_p2p_persistent_peers="${CONFIGTOML_P2P_PERSISTENT_PEERS}"
				shift
			fi
			;;
		--configtoml-p2p-addr-book-file)
			if [[ -n "$2" ]]; then
				configtoml_p2p_addr_book_file="$2"
				shift 2
			else
				configtoml_p2p_addr_book_file="${CONFIGTOML_P2P_ADDR_BOOK_FILE}"
				shift
			fi
			;;
		--configtoml-p2p-addr-book-strict)
			if [[ -n "$2" ]]; then
				configtoml_p2p_addr_book_strict="$2"
				shift 2
			else
				configtoml_p2p_addr_book_strict="${CONFIGTOML_P2P_ADDR_BOOK_STRICT}"
				shift
			fi
			;;
		--configtoml-p2p-max-num-inbound-peers)
			if [[ -n "$2" ]]; then
				configtoml_p2p_max_num_inbound_peers="$2"
				shift 2
			else
				configtoml_p2p_max_num_inbound_peers="${CONFIGTOML_P2P_MAX_NUM_INBOUND_PEERS}"
				shift
			fi
			;;
		--configtoml-p2p-max-num-outbound-peers)
			if [[ -n "$2" ]]; then
				configtoml_p2p_max_num_outbound_peers="$2"
				shift 2
			else
				configtoml_p2p_max_num_outbound_peers="${CONFIGTOML_P2P_MAX_NUM_OUTBOUND_PEERS}"
				shift
			fi
			;;
		--configtoml-p2p-unconditional-peer-ids)
			if [[ -n "$2" ]]; then
				configtoml_p2p_unconditional_peer_ids="$2"
				shift 2
			else
				configtoml_p2p_unconditional_peer_ids="${CONFIGTOML_P2P_UNCONDITIONAL_PEER_IDS}"
				shift
			fi
			;;
		--configtoml-p2p-persistent-peers-max-dial-period)
			if [[ -n "$2" ]]; then
				configtoml_p2p_persistent_peers_max_dial_period="$2"
				shift 2
			else
				configtoml_p2p_persistent_peers_max_dial_period="${CONFIGTOML_P2P_PERSISTENT_PEERS_MAX_DIAL_PERIOD}"
				shift
			fi
			;;
		--configtoml-p2p-flush-throttle-timeout)
			if [[ -n "$2" ]]; then
				configtoml_p2p_flush_throttle_timeout="$2"
				shift 2
			else
				configtoml_p2p_flush_throttle_timeout="${CONFIGTOML_P2P_FLUSH_THROTTLE_TIMEOUT}"
				shift
			fi
			;;
		--configtoml-p2p-max-packet-msg-payload-size)
			if [[ -n "$2" ]]; then
				configtoml_p2p_max_packet_msg_payload_size="$2"
				shift 2
			else
				configtoml_p2p_max_packet_msg_payload_size="${CONFIGTOML_P2P_MAX_PACKET_MSG_PAYLOAD_SIZE}"
				shift
			fi
			;;
		--configtoml-p2p-send-rate)
			if [[ -n "$2" ]]; then
				configtoml_p2p_send_rate="$2"
				shift 2
			else
				configtoml_p2p_send_rate="${CONFIGTOML_P2P_SEND_RATE}"
				shift
			fi
			;;
		--configtoml-p2p-recv-rate)
			if [[ -n "$2" ]]; then
				configtoml_p2p_recv_rate="$2"
				shift 2
			else
				configtoml_p2p_recv_rate="${CONFIGTOML_P2P_RECV_RATE}"
				shift
			fi
			;;
		--configtoml-p2p-pex)
			if [[ -n "$2" ]]; then
				configtoml_p2p_pex="$2"
				shift 2
			else
				configtoml_p2p_pex="${CONFIGTOML_P2P_PEX}"
				shift
			fi
			;;
		--configtoml-p2p-seed-mode)
			if [[ -n "$2" ]]; then
				configtoml_p2p_seed_mode="$2"
				shift 2
			else
				configtoml_p2p_seed_mode="${CONFIGTOML_P2P_SEED_MODE}"
				shift
			fi
			;;
		--configtoml-p2p-private-peer-ids)
			if [[ -n "$2" ]]; then
				configtoml_p2p_private_peer_ids="$2"
				shift 2
			else
				configtoml_p2p_private_peer_ids="${CONFIGTOML_P2P_PRIVATE_PEER_IDS}"
				shift
			fi
			;;
		--configtoml-p2p-allow-duplicate-ip)
			if [[ -n "$2" ]]; then
				configtoml_p2p_allow_duplicate_ip="$2"
				shift 2
			else
				configtoml_p2p_allow_duplicate_ip="${CONFIGTOML_P2P_ALLOW_DUPLICATE_IP}"
				shift
			fi
			;;
		--configtoml-p2p-handshake-timeout)
			if [[ -n "$2" ]]; then
				configtoml_p2p_handshake_timeout="$2"
				shift 2
			else
				configtoml_p2p_handshake_timeout="${CONFIGTOML_P2P_HANDSHAKE_TIMEOUT}"
				shift
			fi
			;;
		--configtoml-p2p-dial-timeout)
			if [[ -n "$2" ]]; then
				configtoml_p2p_dial_timeout="$2"
				shift 2
			else
				configtoml_p2p_dial_timeout="${CONFIGTOML_P2P_DIAL_TIMEOUT}"
				shift
			fi
			;;
		# - Mempool Configuration
		--configtoml-mempool-type)
			if [[ -n "$2" ]]; then
				configtoml_mempool_type="$2"
				shift 2
			else
				configtoml_mempool_type="${CONFIGTOML_MEMPOOL_TYPE}"
				shift
			fi
			;;
		--configtoml-mempool-recheck)
			if [[ -n "$2" ]]; then
				configtoml_mempool_recheck="$2"
				shift 2
			else
				configtoml_mempool_recheck="${CONFIGTOML_MEMPOOL_RECHECK}"
				shift
			fi
			;;
		--configtoml-mempool-recheck-timeout)
			if [[ -n "$2" ]]; then
				configtoml_mempool_recheck_timeout="$2"
				shift 2
			else
				configtoml_mempool_recheck_timeout="${CONFIGTOML_MEMPOOL_RECHECK_TIMEOUT}"
				shift
			fi
			;;
		--configtoml-mempool-broadcast)
			if [[ -n "$2" ]]; then
				configtoml_mempool_broadcast="$2"
				shift 2
			else
				configtoml_mempool_broadcast="${CONFIGTOML_MEMPOOL_BROADCAST}"
				shift
			fi
			;;
		--configtoml-mempool-wal-dir)
			if [[ -n "$2" ]]; then
				configtoml_mempool_wal_dir="$2"
				shift 2
			else
				configtoml_mempool_wal_dir="${CONFIGTOML_MEMPOOL_WAL_DIR}"
				shift
			fi
			;;
		--configtoml-mempool-size)
			if [[ -n "$2" ]]; then
				configtoml_mempool_size="$2"
				shift 2
			else
				configtoml_mempool_size="${CONFIGTOML_MEMPOOL_SIZE}"
				shift
			fi
			;;
		--configtoml-mempool-max-tx-bytes)
			if [[ -n "$2" ]]; then
				configtoml_mempool_max_tx_bytes="$2"
				shift 2
			else
				configtoml_mempool_max_tx_bytes="${CONFIGTOML_MEMPOOL_MAX_TX_BYTES}"
				shift
			fi
			;;
		--configtoml-mempool-max-txs-bytes)
			if [[ -n "$2" ]]; then
				configtoml_mempool_max_txs_bytes="$2"
				shift 2
			else
				configtoml_mempool_max_txs_bytes="${CONFIGTOML_MEMPOOL_MAX_TXS_BYTES}"
				shift
			fi
			;;
		--configtoml-mempool-cache-size)
			if [[ -n "$2" ]]; then
				configtoml_mempool_cache_size="$2"
				shift 2
			else
				configtoml_mempool_cache_size="${CONFIGTOML_MEMPOOL_CACHE_SIZE}"
				shift
			fi
			;;
		--configtoml-mempool-keep-invalid-txs-in-cache)
			if [[ -n "$2" ]]; then
				configtoml_mempool_keep_invalid_txs_in_cache="$2"
				shift 2
			else
				configtoml_mempool_keep_invalid_txs_in_cache="${CONFIGTOML_MEMPOOL_KEEP_INVALID_TXS_IN_CACHE}"
				shift
			fi
			;;
		--configtoml-mempool-experimental-max-gossip-connections-to-persistent-peers)
			if [[ -n "$2" ]]; then
				configtoml_mempool_experimental_max_gossip_connections_to_persistent_peers="$2"
				shift 2
			else
				configtoml_mempool_experimental_max_gossip_connections_to_persistent_peers="${CONFIGTOML_MEMPOOL_EXPERIMENTAL_MAX_GOSSIP_CONNECTIONS_TO_PERSISTENT_PEERS}"
				shift
			fi
			;;
		--configtoml-mempool-experimental-max-gossip-connections-to-non-persistent-peers)
			if [[ -n "$2" ]]; then
				configtoml_mempool_experimental_max_gossip_connections_to_non_persistent_peers="$2"
				shift 2
			else
				configtoml_mempool_experimental_max_gossip_connections_to_non_persistent_peers="${CONFIGTOML_MEMPOOL_EXPERIMENTAL_MAX_GOSSIP_CONNECTIONS_TO_NON_PERSISTENT_PEERS}"
				shift
			fi
			;;
		# - State Sync Configuration
		--configtoml-statesync-enable)
			if [[ -n "$2" ]]; then
				configtoml_statesync_enable="$2"
				shift 2
			else
				configtoml_statesync_enable="${CONFIGTOML_STATESYNC_ENABLE}"
				shift
			fi
			;;
		--configtoml-statesync-rpc-servers)
			if [[ -n "$2" ]]; then
				configtoml_statesync_rpc_servers="$2"
				shift 2
			else
				configtoml_statesync_rpc_servers="${CONFIGTOML_STATESYNC_RPC_SERVERS}"
				shift
			fi
			;;
		--configtoml-statesync-trust-height)
			if [[ -n "$2" ]]; then
				configtoml_statesync_trust_height="$2"
				shift 2
			else
				configtoml_statesync_trust_height="${CONFIGTOML_STATESYNC_TRUST_HEIGHT}"
				shift
			fi
			;;
		--configtoml-statesync-trust-hash)
			if [[ -n "$2" ]]; then
				configtoml_statesync_trust_hash="$2"
				shift 2
			else
				configtoml_statesync_trust_hash="${CONFIGTOML_STATESYNC_TRUST_HASH}"
				shift
			fi
			;;
		--configtoml-statesync-trust-period)
			if [[ -n "$2" ]]; then
				configtoml_statesync_trust_period="$2"
				shift 2
			else
				configtoml_statesync_trust_period="${CONFIGTOML_STATESYNC_TRUST_PERIOD}"
				shift
			fi
			;;
		--configtoml-statesync-discovery-time)
			if [[ -n "$2" ]]; then
				configtoml_statesync_discovery_time="$2"
				shift 2
			else
				configtoml_statesync_discovery_time="${CONFIGTOML_STATESYNC_DISCOVERY_TIME}"
				shift
			fi
			;;
		--configtoml-statesync-temp-dir)
			if [[ -n "$2" ]]; then
				configtoml_statesync_temp_dir="$2"
				shift 2
			else
				configtoml_statesync_temp_dir="${CONFIGTOML_STATESYNC_TEMP_DIR}"
				shift
			fi
			;;
		--configtoml-statesync-chunk-request-timeout)
			if [[ -n "$2" ]]; then
				configtoml_statesync_chunk_request_timeout="$2"
				shift 2
			else
				configtoml_statesync_chunk_request_timeout="${CONFIGTOML_STATESYNC_CHUNK_REQUEST_TIMEOUT}"
				shift
			fi
			;;
		--configtoml-statesync-chunk-fetchers)
			if [[ -n "$2" ]]; then
				configtoml_statesync_chunk_fetchers="$2"
				shift 2
			else
				configtoml_statesync_chunk_fetchers="${CONFIGTOML_STATESYNC_CHUNK_FETCHERS}"
				shift
			fi
			;;
		# - Block Sync Configuration
		--configtoml-blocksync-version)
			if [[ -n "$2" ]]; then
				configtoml_blocksync_version="$2"
				shift 2
			else
				configtoml_blocksync_version="${CONFIGTOML_BLOCKSYNC_VERSION}"
				shift
			fi
			;;
		# - Consensus Configuration
		--configtoml-consensus-wal-file)
			if [[ -n "$2" ]]; then
				configtoml_consensus_wal_file="$2"
				shift 2
			else
				configtoml_consensus_wal_file="${CONFIGTOML_CONSENSUS_WAL_FILE}"
				shift
			fi
			;;
		--configtoml-consensus-timeout-propose)
			if [[ -n "$2" ]]; then
				configtoml_consensus_timeout_propose="$2"
				shift 2
			else
				configtoml_consensus_timeout_propose="${CONFIGTOML_CONSENSUS_TIMEOUT_PROPOSE}"
				shift
			fi
			;;
		--configtoml-consensus-timeout-propose-delta)
			if [[ -n "$2" ]]; then
				configtoml_consensus_timeout_propose_delta="$2"
				shift 2
			else
				configtoml_consensus_timeout_propose_delta="${CONFIGTOML_CONSENSUS_TIMEOUT_PROPOSE_DELTA}"
				shift
			fi
			;;
		--configtoml-consensus-timeout-prevote)
			if [[ -n "$2" ]]; then
				configtoml_consensus_timeout_prevote="$2"
				shift 2
			else
				configtoml_consensus_timeout_prevote="${CONFIGTOML_CONSENSUS_TIMEOUT_PREVOTE}"
				shift
			fi
			;;
		--configtoml-consensus-timeout-prevote-delta)
			if [[ -n "$2" ]]; then
				configtoml_consensus_timeout_prevote_delta="$2"
				shift 2
			else
				configtoml_consensus_timeout_prevote_delta="${CONFIGTOML_CONSENSUS_TIMEOUT_PREVOTE_DELTA}"
				shift
			fi
			;;
		--configtoml-consensus-timeout-precommit)
			if [[ -n "$2" ]]; then
				configtoml_consensus_timeout_precommit="$2"
				shift 2
			else
				configtoml_consensus_timeout_precommit="${CONFIGTOML_CONSENSUS_TIMEOUT_PRECOMMIT}"
				shift
			fi
			;;
		--configtoml-consensus-timeout-precommit-delta)
			if [[ -n "$2" ]]; then
				configtoml_consensus_timeout_precommit_delta="$2"
				shift 2
			else
				configtoml_consensus_timeout_precommit_delta="${CONFIGTOML_CONSENSUS_TIMEOUT_PRECOMMIT_DELTA}"
				shift
			fi
			;;
		--configtoml-consensus-timeout-commit)
			if [[ -n "$2" ]]; then
				configtoml_consensus_timeout_commit="$2"
				shift 2
			else
				configtoml_consensus_timeout_commit="${CONFIGTOML_CONSENSUS_TIMEOUT_COMMIT}"
				shift
			fi
			;;
		--configtoml-consensus-skip-timeout-commit)
			if [[ -n "$2" ]]; then
				configtoml_consensus_skip_timeout_commit="$2"
				shift 2
			else
				configtoml_consensus_skip_timeout_commit="${CONFIGTOML_CONSENSUS_SKIP_TIMEOUT_COMMIT}"
				shift
			fi
			;;
		--configtoml-consensus-double-sign-check-height)
			if [[ -n "$2" ]]; then
				configtoml_consensus_double_sign_check_height="$2"
				shift 2
			else
				configtoml_consensus_double_sign_check_height="${CONFIGTOML_CONSENSUS_DOUBLE_SIGN_CHECK_HEIGHT}"
				shift
			fi
			;;
		--configtoml-consensus-create-empty-blocks)
			if [[ -n "$2" ]]; then
				configtoml_consensus_create_empty_blocks="$2"
				shift 2
			else
				configtoml_consensus_create_empty_blocks="${CONFIGTOML_CONSENSUS_CREATE_EMPTY_BLOCKS}"
				shift
			fi
			;;
		--configtoml-consensus-create-empty-blocks-interval)
			if [[ -n "$2" ]]; then
				configtoml_consensus_create_empty_blocks_interval="$2"
				shift 2
			else
				configtoml_consensus_create_empty_blocks_interval="${CONFIGTOML_CONSENSUS_CREATE_EMPTY_BLOCKS_INTERVAL}"
				shift
			fi
			;;
		--configtoml-consensus-peer-gossip-sleep-duration)
			if [[ -n "$2" ]]; then
				configtoml_consensus_peer_gossip_sleep_duration="$2"
				shift 2
			else
				configtoml_consensus_peer_gossip_sleep_duration="${CONFIGTOML_CONSENSUS_PEER_GOSSIP_SLEEP_DURATION}"
				shift
			fi
			;;
		--configtoml-consensus-peer-gossip-intraloop-sleep-duration)
			if [[ -n "$2" ]]; then
				configtoml_consensus_peer_gossip_intraloop_sleep_duration="$2"
				shift 2
			else
				configtoml_consensus_peer_gossip_intraloop_sleep_duration="${CONFIGTOML_CONSENSUS_PEER_GOSSIP_INTRALOOP_SLEEP_DURATION}"
				shift
			fi
			;;
		--configtoml-consensus-peer-query-maj23-sleep-duration)
			if [[ -n "$2" ]]; then
				configtoml_consensus_peer_query_maj23_sleep_duration="$2"
				shift 2
			else
				configtoml_consensus_peer_query_maj23_sleep_duration="${CONFIGTOML_CONSENSUS_PEER_QUERY_MAJ23_SLEEP_DURATION}"
				shift
			fi
			;;
		# - Storage Configuration
		--configtoml-storage-discard-abci-responses)
			if [[ -n "$2" ]]; then
				configtoml_storage_discard_abci_responses="$2"
				shift 2
			else
				configtoml_storage_discard_abci_responses="${CONFIGTOML_STORAGE_DISCARD_ABCI_RESPONSES}"
				shift
			fi
			;;
		--configtoml-storage-experimental-db-key-layout)
			if [[ -n "$2" ]]; then
				configtoml_storage_experimental_db_key_layout="$2"
				shift 2
			else
				configtoml_storage_experimental_db_key_layout="${CONFIGTOML_STORAGE_EXPERIMENTAL_DB_KEY_LAYOUT}"
				shift
			fi
			;;
		--configtoml-storage-compact)
			if [[ -n "$2" ]]; then
				configtoml_storage_compact="$2"
				shift 2
			else
				configtoml_storage_compact="${CONFIGTOML_STORAGE_COMPACT}"
				shift
			fi
			;;
		--configtoml-storage-compaction-interval)
			if [[ -n "$2" ]]; then
				configtoml_storage_compaction_interval="$2"
				shift 2
			else
				configtoml_storage_compaction_interval="${CONFIGTOML_STORAGE_COMPACTION_INTERVAL}"
				shift
			fi
			;;
		--configtoml-storage-pruning-interval)
			if [[ -n "$2" ]]; then
				configtoml_storage_pruning_interval="$2"
				shift 2
			else
				configtoml_storage_pruning_interval="${CONFIGTOML_STORAGE_PRUNING_INTERVAL}"
				shift
			fi
			;;
		--configtoml-storage-pruning-data-companion-enabled)
			if [[ -n "$2" ]]; then
				configtoml_storage_pruning_data_companion_enabled="$2"
				shift 2
			else
				configtoml_storage_pruning_data_companion_enabled="${CONFIGTOML_STORAGE_PRUNING_DATA_COMPANION_ENABLED}"
				shift
			fi
			;;
		--configtoml-storage-pruning-data-companion-initial-block-retain-height)
			if [[ -n "$2" ]]; then
				configtoml_storage_pruning_data_companion_initial_block_retain_height="$2"
				shift 2
			else
				configtoml_storage_pruning_data_companion_initial_block_retain_height="${CONFIGTOML_STORAGE_PRUNING_DATA_COMPANION_INITIAL_BLOCK_RETAIN_HEIGHT}"
				shift
			fi
			;;
		--configtoml-storage-pruning-data-companion-initial-block-results-retain-height)
			if [[ -n "$2" ]]; then
				configtoml_storage_pruning_data_companion_initial_block_results_retain_height="$2"
				shift 2
			else
				configtoml_storage_pruning_data_companion_initial_block_results_retain_height="${CONFIGTOML_STORAGE_PRUNING_DATA_COMPANION_INITIAL_BLOCK_RESULTS_RETAIN_HEIGHT}"
				shift
			fi
			;;
		# - Transaction Indexer Configuration
		--configtoml-tx-index-indexer)
			if [[ -n "$2" ]]; then
				configtoml_tx_index_indexer="$2"
				shift 2
			else
				configtoml_tx_index_indexer="${CONFIGTOML_TX_INDEX_INDEXER}"
				shift
			fi
			;;
		--configtoml-tx-index-psql-conn)
			if [[ -n "$2" ]]; then
				configtoml_tx_index_psql_conn="$2"
				shift 2
			else
				configtoml_tx_index_psql_conn="${CONFIGTOML_TX_INDEX_PSQL_CONN}"
				shift
			fi
			;;
		# - Instrumentation Configuration
		--configtoml-instrumentation-prometheus)
			if [[ -n "$2" ]]; then
				configtoml_instrumentation_prometheus="$2"
				shift 2
			else
				configtoml_instrumentation_prometheus="${CONFIGTOML_INSTRUMENTATION_PROMETHEUS}"
				shift
			fi
			;;
		--configtoml-instrumentation-prometheus-listen-addr)
			if [[ -n "$2" ]]; then
				configtoml_instrumentation_prometheus_listen_addr="$2"
				shift 2
			else
				configtoml_instrumentation_prometheus_listen_addr="${CONFIGTOML_INSTRUMENTATION_PROMETHEUS_LISTEN_ADDR}"
				shift
			fi
			;;
		--configtoml-instrumentation-max-open-connections)
			if [[ -n "$2" ]]; then
				configtoml_instrumentation_max_open_connections="$2"
				shift 2
			else
				configtoml_instrumentation_max_open_connections="${CONFIGTOML_INSTRUMENTATION_MAX_OPEN_CONNECTIONS}"
				shift
			fi
			;;
		--configtoml-instrumentation-namespace)
			if [[ -n "$2" ]]; then
				configtoml_instrumentation_namespace="$2"
				shift 2
			else
				configtoml_instrumentation_namespace="${CONFIGTOML_INSTRUMENTATION_NAMESPACE}"
				shift
			fi
			;;
		*)
			log_error "Unknown option: $1"
			show_init_help
			return 1
			;;
		esac
	done

	# =========================================================================
	# [4] CONFIGURATION VALIDATION
	# =========================================================================
	# Validate node counts and apply network-specific defaults

	# Port overrides - placeholder to be replaced per-node during config generation
	PORT_DEFINED_BY_NODE="<PORT_DEFINED_BY_NODE>"
	clienttoml_chain_id="${network}-beacon-${chain_id}"
	clienttoml_node="tcp://localhost:$PORT_DEFINED_BY_NODE"
	apptoml_beacon_kit_engine_rpc_dial_url="http://localhost:$PORT_DEFINED_BY_NODE"
	apptoml_beacon_kit_node_api_address="0.0.0.0:$PORT_DEFINED_BY_NODE"
	configtoml_proxy_app="tcp://127.0.0.1:$PORT_DEFINED_BY_NODE"
	configtoml_rpc_laddr="tcp://127.0.0.1:$PORT_DEFINED_BY_NODE"
	configtoml_p2p_laddr="tcp://0.0.0.0:$PORT_DEFINED_BY_NODE"
	configtoml_instrumentation_prometheus_listen_addr="$PORT_DEFINED_BY_NODE"
	configtoml_moniker="$moniker"

	# Validate validator count - must be a positive integer
	if ! [[ "$validators" =~ ^[0-9]+$ ]] || [[ "$validators" -le 0 ]]; then
		log_warn "validators is not a valid positive integer. defaulting to 1"
		validators=1
	fi

	total_nodes=$(((${validators:-1} + ${full_nodes:-0} + ${pruned_nodes:-0})))
	# devnet defaults
	if [[ "${network}" == "${CHAIN_NAME_DEVNET}" ]]; then
		if [[ ${total_nodes} -eq 0 ]]; then
			total_nodes=$(((${validators} + ${full_nodes} + ${pruned_nodes})))
			log_warn "total nodes is 0. defaulting to ${validators} validator, ${full_nodes} rpc full node, and ${pruned_nodes} rpc pruned node"
		fi
	fi
	# testnet defaults
	# TODO
	# mainnet defaults
	# TODO

	# Output configuration settings
	echo "========= Configuration Settings ========="
	echo "Moniker:         ${moniker:-<unset>}"
	echo "Network:         ${network:-<unset>}"
	echo "Validators:      ${validators}"
	echo "Full Nodes:      ${full_nodes}"
	echo "Pruned Nodes:    ${pruned_nodes}"
	echo "Total Nodes:     $total_nodes"
	echo "Beranode Dir:    ${BERANODES_PATH:-<unset>}"
	echo "Skip Genesis:    ${skip_genesis:-false}"
	echo "Force:           ${force:-false}"
	echo "Mode:            ${mode}"
	echo "=========================================="
	echo ""

	# =========================================================================
	# [5] DIRECTORY STRUCTURE SETUP
	# =========================================================================
	# Create all required beranodes directory structure

	ensure_dir_exists "${BERANODES_PATH}" "beranode directory" || return 1
	ensure_dir_exists "${BERANODES_PATH}${BERANODES_PATH_BIN}" "beranode binary directory" || return 1
	ensure_dir_exists "${BERANODES_PATH}${BERANODES_PATH_TMP}" "beranode temporary directory" || return 1
	ensure_dir_exists "${BERANODES_PATH}${BERANODES_PATH_LOGS}" "beranode log directory" || return 1
	ensure_dir_exists "${BERANODES_PATH}${BERANODES_PATH_NODES}" "beranode nodes directory" || return 1
	ensure_dir_exists "${BERANODES_PATH}${BERANODES_PATH_RUNS}" "beranode runs directory" || return 1

	# =========================================================================
	# [6] BINARY VERIFICATION
	# =========================================================================
	# Verify beacond and bera-reth binaries exist and are executable

	missing_binaries=0
	# - beacond
  is_beacond_installed=false
	if [[ ! -x "${BERANODES_PATH}${BERANODES_PATH_BIN}/${BIN_BEACONKIT}" ]]; then
		log_warn "Binary '${BIN_BEACONKIT}' not found or not executable: ${BERANODES_PATH}${BERANODES_PATH_BIN}/${BIN_BEACONKIT}"
	else
		# Check if 'beacond version' command executes successfully
		beacon_version="$("${BERANODES_PATH}${BERANODES_PATH_BIN}/${BIN_BEACONKIT}" version 2>/dev/null)"
		if [[ $? -eq 0 ]]; then
			log_success "'${BIN_BEACONKIT} version' works as expected."
			log_info "${BIN_BEACONKIT} version:\n${beacon_version}\n"
      is_beacond_installed=true
		else
			log_error "'${BIN_BEACONKIT} version' did not work as expected."
		fi
	fi

  if [[ "$is_beacond_installed" == false ]]; then
    log_info "Installing beacond binary..."
    download_beranodes_binary \
      --config-dir "${BERANODES_PATH}" \
      --binary-to-download "${BIN_BEACONKIT}" \
      --version-tag "latest"
  fi

	# - berareth
  is_berareth_installed=false
	if [[ ! -x "${BERANODES_PATH}${BERANODES_PATH_BIN}/${BIN_BERARETH}" ]]; then
		log_warn "Binary '${BIN_BERARETH}' not found or not executable: ${BERANODES_PATH}${BERANODES_PATH_BIN}/${BIN_BERARETH}"
		missing_binaries=1
	else
		# Check if 'berareth version' command executes successfully
		bera_reth_version="$("${BERANODES_PATH}${BERANODES_PATH_BIN}/${BIN_BERARETH}" --version 2>/dev/null)"
		if [[ $? -eq 0 ]]; then
			log_success "'${BIN_BERARETH} --version' works as expected."
			log_info "${BIN_BERARETH} version:\n${bera_reth_version}\n"
      is_berareth_installed=true
		else
			log_error "'${BIN_BERARETH} --version' did not work as expected."
		fi
	fi

  if [[ "$is_berareth_installed" == false ]]; then
    log_info "Installing bera-reth binary..."
    download_beranodes_binary \
      --config-dir "${BERANODES_PATH}" \
      --binary-to-download "${BIN_BERARETH}" \
      --version-tag "latest"
  fi

	# =========================================================================
	# [7] WALLET GENERATION
	# =========================================================================
	# Generate EVM private key and derive wallet address
	# TODO: refactor this so that if an existing wallet is provided, exclude this
	wallet_private_key=$(generate_evm_private_key)
	if [[ $? -eq 0 ]]; then
		log_success "Wallet private key generated:\n${wallet_private_key}"
	else
		log_error "Failed to generate wallet private key."
		return 1
	fi
	wallet_address=$(get_evm_address_from_private_key "${wallet_private_key}")
	if [[ $? -eq 0 ]]; then
		log_success "Wallet address generated:\n${wallet_address}"
	else
		log_error "Failed to generate wallet address."
		return 1
	fi

	# =========================================================================
	# [8] CONFIGURATION FILE GENERATION
	# =========================================================================
	# Create beranodes.config.json with all node configurations

	print_header "Creating base beranodes.config.json file..."

	# Create beranodes.config.json with settings as JSON
	config_json_path="${BERANODES_PATH}/beranodes.config.json"
	# Check if the configuration file already exists, and don't overwrite it
	local_config_exists=false
	if [[ -f "${config_json_path}" ]]; then
		log_warn "Configuration already exists at ${config_json_path}. Will not overwrite."
		local_config_exists=true
		# Prompt the user to overwrite or use the existing config
		while true; do
			echo -e "${YELLOW}A configuration file already exists at ${config_json_path}.${RESET}"
			read -p "Do you want to overwrite it? [y/n]: " yn
			case "$yn" in
			[Yy]*)
				log_warn "Overwriting existing configuration file at ${config_json_path}."
				rm -f "${config_json_path}"
				log_info "Previous configuration file removed."
				local_config_exists=false
				break
				;;
			[Nn]* | "")
				log_success "Using existing configuration file at ${config_json_path}."
				break
				;;
			*)
				echo "Please answer yes (y) or no (n)."
				;;
			esac
		done
	fi

	# Create all new setup
	if [[ "${local_config_exists}" = false ]]; then
		log_info "Creating new configuration file: ${config_json_path}"

		nodes_validators=""
		node_ethrpc_port=${DEFAULT_CL_ETHRPC_PORT}
		node_ethp2p_port=${DEFAULT_CL_ETHP2P_PORT}
		node_ethproxy_port=${DEFAULT_CL_ETHPROXY_PORT}
		node_el_ethrpc_port=${DEFAULT_EL_ETHRPC_PORT}
		node_el_ws_port=${DEFAULT_EL_WS_PORT}
		node_el_authrpc_port=${DEFAULT_EL_AUTHRPC_PORT}
		node_el_eth_port=${DEFAULT_DEFAULT_EL_ETH_PORT}
		node_el_prometheus_port=${DEFAULT_EL_PROMETHEUS_PORT}
		node_cl_prometheus_port=${DEFAULT_CL_PROMETHEUS_PORT}
		node_beacond_node_port=${DEFAULT_BEACON_NODE_API_PORT}
		node_port_increment=${DEFAULT_PORT_INCREMENT}
		#
		node_configtoml_grpc_laddr="${DEFAULT_GRPC_LADDR_PORT}"
		node_configtoml_grpc_privileged_laddr="${DEFAULT_GRPC_PRIVILEGED_LADDR_PORT}"

		current_node_ethrpc_port=${node_ethrpc_port}
		current_node_ethp2p_port=${node_ethp2p_port}
		current_node_ethproxy_port=${node_ethproxy_port}
		current_node_el_ethrpc_port=${node_el_ethrpc_port}
		current_node_el_ws_port=${node_el_ws_port}
		current_node_el_authrpc_port=${node_el_authrpc_port}
		current_node_el_eth_port=${node_el_eth_port}
		current_node_el_prometheus_port=${node_el_prometheus_port}
		current_node_cl_prometheus_port=${node_cl_prometheus_port}
		current_node_beacond_node_port=${node_beacond_node_port}
		current_node_configtoml_grpc_laddr=${node_configtoml_grpc_laddr}
		current_node_configtoml_grpc_privileged_laddr=${node_configtoml_grpc_privileged_laddr}

		if [[ ${validators} -gt 0 ]]; then
			for i in $(seq 1 ${validators}); do
				if [[ $i -eq ${validators} ]]; then
					nodes_validators="${nodes_validators}{
						\"role\": \"validator\",
						\"moniker\": \"${moniker}-val-$(($i - 1))\",
						\"network\": \"${network}\",
						\"wallet_address\": \"${wallet_address}\",
						\"ethrpc_port\": ${current_node_ethrpc_port},
						\"ethp2p_port\": ${current_node_ethp2p_port},
						\"ethproxy_port\": ${current_node_ethproxy_port},
						\"el_ethrpc_port\": ${current_node_el_ethrpc_port},
            \"el_ws_port\": ${current_node_el_ws_port},
						\"el_authrpc_port\": ${current_node_el_authrpc_port},
						\"el_eth_port\": ${current_node_el_eth_port},
						\"el_prometheus_port\": ${current_node_el_prometheus_port},
						\"cl_prometheus_port\": ${current_node_cl_prometheus_port},
            \"beacond_node_port\": ${current_node_beacond_node_port},
            \"configtoml_grpc_laddr\": ${current_node_configtoml_grpc_laddr},
            \"configtoml_grpc_privileged_laddr\": ${current_node_configtoml_grpc_privileged_laddr}
					}"
				else
					nodes_validators="${nodes_validators}{
						\"role\": \"validator\",
						\"moniker\": \"${moniker}-val-$(($i - 1))\",
						\"network\": \"${network}\",
						\"wallet_address\": \"${wallet_address}\",
						\"ethrpc_port\": ${current_node_ethrpc_port},
						\"ethp2p_port\": ${current_node_ethp2p_port},
						\"ethproxy_port\": ${current_node_ethproxy_port},
						\"el_ethrpc_port\": ${current_node_el_ethrpc_port},
            \"el_ws_port\": ${current_node_el_ws_port},
						\"el_authrpc_port\": ${current_node_el_authrpc_port},
						\"el_eth_port\": ${current_node_el_eth_port},
						\"el_prometheus_port\": ${current_node_el_prometheus_port},
						\"cl_prometheus_port\": ${current_node_cl_prometheus_port},
            \"beacond_node_port\": ${current_node_beacond_node_port},
            \"configtoml_grpc_laddr\": ${current_node_configtoml_grpc_laddr},
            \"configtoml_grpc_privileged_laddr\": ${current_node_configtoml_grpc_privileged_laddr}
					},"
				fi

				if [[ "${docker_mode}" = false ]]; then
					current_node_ethrpc_port=$((current_node_ethrpc_port + 10000))
					current_node_ethp2p_port=$((current_node_ethp2p_port + 10000))
					current_node_ethproxy_port=$((current_node_ethproxy_port + 10000))
					current_node_el_ethrpc_port=$((current_node_el_ethrpc_port + node_port_increment))
					current_node_el_ws_port=$((current_node_el_ws_port + node_port_increment))
					current_node_el_authrpc_port=$((current_node_el_authrpc_port + 100))
					current_node_el_eth_port=$((current_node_el_eth_port + node_port_increment))
					current_node_el_prometheus_port=$((current_node_el_prometheus_port + node_port_increment))
					current_node_cl_prometheus_port=$((current_node_cl_prometheus_port + 10000))
					current_node_beacond_node_port=$((current_node_beacond_node_port + 100))
					current_node_configtoml_grpc_laddr=$((current_node_configtoml_grpc_laddr + 100))
					current_node_configtoml_grpc_privileged_laddr=$((current_node_configtoml_grpc_privileged_laddr + 100))
				fi
			done
		fi

		nodes_full_nodes=""
		if [[ ${full_nodes} -gt 0 ]]; then
			for i in $(seq 1 ${full_nodes}); do
				if [[ $i -eq ${full_nodes} ]]; then
					nodes_full_nodes="${nodes_full_nodes}{
						\"role\": \"rpc_full\",
						\"moniker\": \"${moniker}-rpc-full-$(($i - 1))\",
						\"network\": \"${network}\",
						\"wallet_address\": \"${wallet_address}\",
						\"ethrpc_port\": ${current_node_ethrpc_port},
						\"ethp2p_port\": ${current_node_ethp2p_port},
						\"ethproxy_port\": ${current_node_ethproxy_port},
						\"el_ethrpc_port\": ${current_node_el_ethrpc_port},
            \"el_ws_port\": ${current_node_el_ws_port},
						\"el_authrpc_port\": ${current_node_el_authrpc_port},
						\"el_eth_port\": ${current_node_el_eth_port},
						\"el_prometheus_port\": ${current_node_el_prometheus_port},
						\"cl_prometheus_port\": ${current_node_cl_prometheus_port},
            \"beacond_node_port\": ${current_node_beacond_node_port},
            \"configtoml_grpc_laddr\": ${current_node_configtoml_grpc_laddr},
            \"configtoml_grpc_privileged_laddr\": ${current_node_configtoml_grpc_privileged_laddr}
					}"
				else
					nodes_full_nodes="${nodes_full_nodes}{
						\"role\": \"rpc_full\",
						\"moniker\": \"${moniker}-rpc-full-$(($i - 1))\",
						\"network\": \"${network}\",
						\"wallet_address\": \"${wallet_address}\",
						\"ethrpc_port\": ${current_node_ethrpc_port},
						\"ethp2p_port\": ${current_node_ethp2p_port},
						\"ethproxy_port\": ${current_node_ethproxy_port},
						\"el_ethrpc_port\": ${current_node_el_ethrpc_port},
            \"el_ws_port\": ${current_node_el_ws_port},
						\"el_authrpc_port\": ${current_node_el_authrpc_port},
						\"el_eth_port\": ${current_node_el_eth_port},
						\"el_prometheus_port\": ${current_node_el_prometheus_port},
						\"cl_prometheus_port\": ${current_node_cl_prometheus_port},
            \"beacond_node_port\": ${current_node_beacond_node_port},
            \"configtoml_grpc_laddr\": ${current_node_configtoml_grpc_laddr},
            \"configtoml_grpc_privileged_laddr\": ${current_node_configtoml_grpc_privileged_laddr}
					},"
				fi

				if [[ "${docker_mode}" = false ]]; then
					current_node_ethrpc_port=$((current_node_ethrpc_port + 10000))
					current_node_ethp2p_port=$((current_node_ethp2p_port + 10000))
					current_node_ethproxy_port=$((current_node_ethproxy_port + 10000))
					current_node_el_ethrpc_port=$((current_node_el_ethrpc_port + node_port_increment))
					current_node_el_ws_port=$((current_node_el_ws_port + node_port_increment))
					current_node_el_authrpc_port=$((current_node_el_authrpc_port + 100))
					current_node_el_eth_port=$((current_node_el_eth_port + node_port_increment))
					current_node_el_prometheus_port=$((current_node_el_prometheus_port + node_port_increment))
					current_node_cl_prometheus_port=$((current_node_cl_prometheus_port + 10000))
					current_node_beacond_node_port=$((current_node_beacond_node_port + 100))
					current_node_configtoml_grpc_laddr=$((current_node_configtoml_grpc_laddr + 100))
					current_node_configtoml_grpc_privileged_laddr=$((current_node_configtoml_grpc_privileged_laddr + 100))
				fi
			done
		fi

		nodes_pruned_nodes=""
		if [[ ${pruned_nodes} -gt 0 ]]; then
			for i in $(seq 1 ${pruned_nodes}); do
				if [[ $i -eq ${pruned_nodes} ]]; then
					nodes_pruned_nodes="${nodes_pruned_nodes}{
						\"role\": \"rpc-pruned\",
						\"moniker\": \"${moniker}-rpc-pruned-$(($i - 1))\",
						\"network\": \"${network}\",
						\"wallet_address\": \"${wallet_address}\",
						\"ethrpc_port\": ${current_node_ethrpc_port},
						\"ethp2p_port\": ${current_node_ethp2p_port},
						\"ethproxy_port\": ${current_node_ethproxy_port},
						\"el_ethrpc_port\": ${current_node_el_ethrpc_port},
						\"el_authrpc_port\": ${current_node_el_authrpc_port},
						\"el_eth_port\": ${current_node_el_eth_port},
						\"el_prometheus_port\": ${current_node_el_prometheus_port},
						\"cl_prometheus_port\": ${current_node_cl_prometheus_port},
            \"beacond_node_port\": ${current_node_beacond_node_port},
            \"configtoml_grpc_laddr\": ${current_node_configtoml_grpc_laddr},
            \"configtoml_grpc_privileged_laddr\": ${current_node_configtoml_grpc_privileged_laddr}
					}"
				else
					nodes_pruned_nodes="${nodes_pruned_nodes}{
						\"role\": \"rpc-pruned\",
						\"moniker\": \"${moniker}-rpc-pruned-$(($i - 1))\",
						\"network\": \"${network}\",
						\"wallet_address\": \"${wallet_address}\",
						\"ethrpc_port\": ${current_node_ethrpc_port},
						\"ethp2p_port\": ${current_node_ethp2p_port},
						\"ethproxy_port\": ${current_node_ethproxy_port},
						\"el_ethrpc_port\": ${current_node_el_ethrpc_port},
						\"el_authrpc_port\": ${current_node_el_authrpc_port},
						\"el_eth_port\": ${current_node_el_eth_port},
						\"el_prometheus_port\": ${current_node_el_prometheus_port},
						\"cl_prometheus_port\": ${current_node_cl_prometheus_port},
            \"beacond_node_port\": ${current_node_beacond_node_port},
            \"configtoml_grpc_laddr\": ${current_node_configtoml_grpc_laddr},
            \"configtoml_grpc_privileged_laddr\": ${current_node_configtoml_grpc_privileged_laddr}
					},"
				fi

				if [[ "${docker_mode}" = false ]]; then
					current_node_ethrpc_port=$((current_node_ethrpc_port + 10000))
					current_node_ethp2p_port=$((current_node_ethp2p_port + 10000))
					current_node_ethproxy_port=$((current_node_ethproxy_port + 10000))
					current_node_el_ethrpc_port=$((current_node_el_ethrpc_port + node_port_increment))
					current_node_el_ws_port=$((current_node_el_ws_port + node_port_increment))
					current_node_el_authrpc_port=$((current_node_el_authrpc_port + 100))
					current_node_el_eth_port=$((current_node_el_eth_port + node_port_increment))
					current_node_el_prometheus_port=$((current_node_el_prometheus_port + node_port_increment))
					current_node_cl_prometheus_port=$((current_node_cl_prometheus_port + 10000))
					current_node_beacond_node_port=$((current_node_beacond_node_port + 100))
					current_node_configtoml_grpc_laddr=$((current_node_configtoml_grpc_laddr + 100))
					current_node_configtoml_grpc_privileged_laddr=$((current_node_configtoml_grpc_privileged_laddr + 100))
				fi
			done
		fi

		# Combine all defined node groups into a properly formatted JSON nodes array.
		nodes_combined=""

		# Prepare a list of all potential node groups. Add new ones here if needed.
		all_groups=("$nodes_validators" "$nodes_full_nodes" "$nodes_pruned_nodes")
		for group in "${all_groups[@]}"; do
			if [[ -n "$group" ]]; then
				if [[ -z "$nodes_combined" ]]; then
					nodes_combined="$group"
				else
					nodes_combined="${nodes_combined},${group}"
				fi
			fi
		done

		clienttoml="{
      \"chain_id\": \"${clienttoml_chain_id}\",
      \"keyring_backend\": \"${clienttoml_keyring_backend}\",
      \"keyring_default_keyname\": \"${clienttoml_keyring_default_keyname}\",
      \"output\": \"${clienttoml_output}\",
      \"node\": \"${clienttoml_node}\",
      \"broadcast_mode\": \"${clienttoml_broadcast_mode}\",
      \"grpc_address\": \"${clienttoml_grpc_address}\",
      \"grpc_insecure\": \"${clienttoml_grpc_insecure}\"
    }"
		apptoml="{
      \"pruning\": \"${apptoml_pruning}\",
      \"pruning_keep_recent\": \"${apptoml_pruning_keep_recent}\",
      \"pruning_interval\": \"${apptoml_pruning_interval}\",
      \"halt_height\": \"${apptoml_halt_height}\",
      \"halt_time\": \"${apptoml_halt_time}\",
      \"min_retain_blocks\": \"${apptoml_min_retain_blocks}\",
      \"inter_block_cache\": \"${apptoml_inter_block_cache}\",
      \"iavl_cache_size\": \"${apptoml_iavl_cache_size}\",
      \"iavl_disable_fastnode\": \"${apptoml_iavl_disable_fastnode}\",
      \"app_db_backend\": \"${apptoml_app_db_backend}\",
      \"telemetry_service_name\": \"${apptoml_telemetry_service_name}\",
      \"telemetry_enabled\": \"${apptoml_telemetry_enabled}\",
      \"telemetry_enable_hostname\": \"${apptoml_telemetry_enable_hostname}\",
      \"telemetry_enable_hostname_label\": \"${apptoml_telemetry_enable_hostname_label}\",
      \"telemetry_enable_service_label\": \"${apptoml_telemetry_enable_service_label}\",
      \"telemetry_prometheus_retention_time\": \"${apptoml_telemetry_prometheus_retention_time}\",
      \"telemetry_global_labels\": \"${apptoml_telemetry_global_labels}\",
      \"telemetry_metrics_sink\": \"${apptoml_telemetry_metrics_sink}\",
      \"telemetry_statsd_addr\": \"${apptoml_telemetry_statsd_addr}\",
      \"telemetry_datadog_hostname\": \"${apptoml_telemetry_datadog_hostname}\",
      \"beacon_kit_chain_spec\": \"${apptoml_beacon_kit_chain_spec}\",
      \"beacon_kit_chain_spec_file\": \"${apptoml_beacon_kit_chain_spec_file}\",
      \"beacon_kit_shutdown_timeout\": \"${apptoml_beacon_kit_shutdown_timeout}\",
      \"beacon_kit_engine_rpc_dial_url\": \"${apptoml_beacon_kit_engine_rpc_dial_url}\",
      \"beacon_kit_engine_rpc_timeout\": \"${apptoml_beacon_kit_engine_rpc_timeout}\",
      \"beacon_kit_engine_rpc_retry_interval\": \"${apptoml_beacon_kit_engine_rpc_retry_interval}\",
      \"beacon_kit_engine_rpc_max_retry_interval\": \"${apptoml_beacon_kit_engine_rpc_max_retry_interval}\",
      \"beacon_kit_engine_rpc_startup_check_interval\": \"${apptoml_beacon_kit_engine_rpc_startup_check_interval}\",
      \"beacon_kit_engine_rpc_jwt_refresh_interval\": \"${apptoml_beacon_kit_engine_rpc_jwt_refresh_interval}\",
      \"beacon_kit_engine_jwt_secret_path\": \"${apptoml_beacon_kit_engine_jwt_secret_path}\",
      \"beacon_kit_logger_time_format\": \"${apptoml_beacon_kit_logger_time_format}\",
      \"beacon_kit_logger_log_level\": \"${apptoml_beacon_kit_logger_log_level}\",
      \"beacon_kit_logger_style\": \"${apptoml_beacon_kit_logger_style}\",
      \"beacon_kit_kzg_trusted_setup_path\": \"${apptoml_beacon_kit_kzg_trusted_setup_path}\",
      \"beacon_kit_kzg_implementation\": \"${apptoml_beacon_kit_kzg_implementation}\",
      \"beacon_kit_payload_builder_enabled\": \"${apptoml_beacon_kit_payload_builder_enabled}\",
      \"beacon_kit_payload_builder_suggested_fee_recipient\": \"${apptoml_beacon_kit_payload_builder_suggested_fee_recipient}\",
      \"beacon_kit_payload_builder_payload_timeout\": \"${apptoml_beacon_kit_payload_builder_payload_timeout}\",
      \"beacon_kit_validator_graffiti\": \"${apptoml_beacon_kit_validator_graffiti}\",
      \"beacon_kit_validator_availability_window\": \"${apptoml_beacon_kit_validator_availability_window}\",
      \"beacon_kit_node_api_enabled\": \"${apptoml_beacon_kit_node_api_enabled}\",
      \"beacon_kit_node_api_address\": \"${apptoml_beacon_kit_node_api_address}\",
      \"beacon_kit_node_api_logging\": \"${apptoml_beacon_kit_node_api_logging}\"
    }"
		configtoml="{
      \"version\": \"${configtoml_version}\",
      \"proxy_app\": \"${configtoml_proxy_app}\",
      \"moniker\": \"${configtoml_moniker}\",
      \"db_backend\": \"${configtoml_db_backend}\",
      \"db_dir\": \"${configtoml_db_dir}\",
      \"log_level\": \"${configtoml_log_level}\",
      \"log_format\": \"${configtoml_log_format}\",
      \"genesis_file\": \"${configtoml_genesis_file}\",
      \"priv_validator_key_file\": \"${configtoml_priv_validator_key_file}\",
      \"priv_validator_state_file\": \"${configtoml_priv_validator_state_file}\",
      \"priv_validator_laddr\": \"${configtoml_priv_validator_laddr}\",
      \"node_key_file\": \"${configtoml_node_key_file}\",
      \"abci\": \"${configtoml_abci}\",
      \"filter_peers\": \"${configtoml_filter_peers}\",
      \"rpc_laddr\": \"${configtoml_rpc_laddr}\",
      \"rpc_unsafe\": \"${configtoml_rpc_unsafe}\",
      \"rpc_cors_allowed_origins\": \"${configtoml_rpc_cors_allowed_origins}\",
      \"rpc_cors_allowed_methods\": \"${configtoml_rpc_cors_allowed_methods}\",
      \"rpc_cors_allowed_headers\": \"${configtoml_rpc_cors_allowed_headers}\",
      \"rpc_max_open_connections\": \"${configtoml_rpc_max_open_connections}\",
      \"rpc_max_subscription_clients\": \"${configtoml_rpc_max_subscription_clients}\",
      \"rpc_max_subscriptions_per_client\": \"${configtoml_rpc_max_subscriptions_per_client}\",
      \"rpc_experimental_subscription_buffer_size\": \"${configtoml_rpc_experimental_subscription_buffer_size}\",
      \"rpc_experimental_websocket_write_buffer_size\": \"${configtoml_rpc_experimental_websocket_write_buffer_size}\",
      \"rpc_experimental_close_on_slow_client\": \"${configtoml_rpc_experimental_close_on_slow_client}\",
      \"rpc_timeout_broadcast_tx_commit\": \"${configtoml_rpc_timeout_broadcast_tx_commit}\",
      \"rpc_max_request_batch_size\": \"${configtoml_rpc_max_request_batch_size}\",
      \"rpc_max_body_bytes\": \"${configtoml_rpc_max_body_bytes}\",
      \"rpc_max_header_bytes\": \"${configtoml_rpc_max_header_bytes}\",
      \"rpc_tls_cert_file\": \"${configtoml_rpc_tls_cert_file}\",
      \"rpc_tls_key_file\": \"${configtoml_rpc_tls_key_file}\",
      \"rpc_pprof_laddr\": \"${configtoml_rpc_pprof_laddr}\",
      \"grpc_laddr\": \"${configtoml_grpc_laddr}\",
      \"grpc_version_service_enabled\": \"${configtoml_grpc_version_service_enabled}\",
      \"grpc_block_service_enabled\": \"${configtoml_grpc_block_service_enabled}\",
      \"grpc_block_results_service_enabled\": \"${configtoml_grpc_block_results_service_enabled}\",
      \"grpc_privileged_laddr\": \"${configtoml_grpc_privileged_laddr}\",
      \"grpc_privileged_pruning_service_enabled\": \"${configtoml_grpc_privileged_pruning_service_enabled}\",
      \"p2p_laddr\": \"${configtoml_p2p_laddr}\",
      \"p2p_external_address\": \"${configtoml_p2p_external_address}\",
      \"p2p_seeds\": \"${configtoml_p2p_seeds}\",
      \"p2p_persistent_peers\": \"${configtoml_p2p_persistent_peers}\",
      \"p2p_addr_book_file\": \"${configtoml_p2p_addr_book_file}\",
      \"p2p_addr_book_strict\": \"${configtoml_p2p_addr_book_strict}\",
      \"p2p_max_num_inbound_peers\": \"${configtoml_p2p_max_num_inbound_peers}\",
      \"p2p_max_num_outbound_peers\": \"${configtoml_p2p_max_num_outbound_peers}\",
      \"p2p_unconditional_peer_ids\": \"${configtoml_p2p_unconditional_peer_ids}\",
      \"p2p_persistent_peers_max_dial_period\": \"${configtoml_p2p_persistent_peers_max_dial_period}\",
      \"p2p_flush_throttle_timeout\": \"${configtoml_p2p_flush_throttle_timeout}\",
      \"p2p_max_packet_msg_payload_size\": \"${configtoml_p2p_max_packet_msg_payload_size}\",
      \"p2p_send_rate\": \"${configtoml_p2p_send_rate}\",
      \"p2p_recv_rate\": \"${configtoml_p2p_recv_rate}\",
      \"p2p_pex\": \"${configtoml_p2p_pex}\",
      \"p2p_seed_mode\": \"${configtoml_p2p_seed_mode}\",
      \"p2p_private_peer_ids\": \"${configtoml_p2p_private_peer_ids}\",
      \"p2p_allow_duplicate_ip\": \"${configtoml_p2p_allow_duplicate_ip}\",
      \"p2p_handshake_timeout\": \"${configtoml_p2p_handshake_timeout}\",
      \"p2p_dial_timeout\": \"${configtoml_p2p_dial_timeout}\",
      \"mempool_type\": \"${configtoml_mempool_type}\",
      \"mempool_recheck\": \"${configtoml_mempool_recheck}\",
      \"mempool_recheck_timeout\": \"${configtoml_mempool_recheck_timeout}\",
      \"mempool_broadcast\": \"${configtoml_mempool_broadcast}\",
      \"mempool_wal_dir\": \"${configtoml_mempool_wal_dir}\",
      \"mempool_size\": \"${configtoml_mempool_size}\",
      \"mempool_max_tx_bytes\": \"${configtoml_mempool_max_tx_bytes}\",
      \"mempool_max_txs_bytes\": \"${configtoml_mempool_max_txs_bytes}\",
      \"mempool_cache_size\": \"${configtoml_mempool_cache_size}\",
      \"mempool_keep_invalid_txs_in_cache\": \"${configtoml_mempool_keep_invalid_txs_in_cache}\",
      \"mempool_experimental_max_gossip_connections_to_persistent_peers\": \"${configtoml_mempool_experimental_max_gossip_connections_to_persistent_peers}\",
      \"mempool_experimental_max_gossip_connections_to_non_persistent_peers\": \"${configtoml_mempool_experimental_max_gossip_connections_to_non_persistent_peers}\",
      \"statesync_enable\": \"${configtoml_statesync_enable}\",
      \"statesync_rpc_servers\": \"${configtoml_statesync_rpc_servers}\",
      \"statesync_trust_height\": \"${configtoml_statesync_trust_height}\",
      \"statesync_trust_hash\": \"${configtoml_statesync_trust_hash}\",
      \"statesync_trust_period\": \"${configtoml_statesync_trust_period}\",
      \"statesync_discovery_time\": \"${configtoml_statesync_discovery_time}\",
      \"statesync_temp_dir\": \"${configtoml_statesync_temp_dir}\",
      \"statesync_chunk_request_timeout\": \"${configtoml_statesync_chunk_request_timeout}\",
      \"statesync_chunk_fetchers\": \"${configtoml_statesync_chunk_fetchers}\",
      \"blocksync_version\": \"${configtoml_blocksync_version}\",
      \"consensus_wal_file\": \"${configtoml_consensus_wal_file}\",
      \"consensus_timeout_propose\": \"${configtoml_consensus_timeout_propose}\",
      \"consensus_timeout_propose_delta\": \"${configtoml_consensus_timeout_propose_delta}\",
      \"consensus_timeout_prevote\": \"${configtoml_consensus_timeout_prevote}\",
      \"consensus_timeout_prevote_delta\": \"${configtoml_consensus_timeout_prevote_delta}\",
      \"consensus_timeout_precommit\": \"${configtoml_consensus_timeout_precommit}\",
      \"consensus_timeout_precommit_delta\": \"${configtoml_consensus_timeout_precommit_delta}\",
      \"consensus_timeout_commit\": \"${configtoml_consensus_timeout_commit}\",
      \"consensus_skip_timeout_commit\": \"${configtoml_consensus_skip_timeout_commit}\",
      \"consensus_double_sign_check_height\": \"${configtoml_consensus_double_sign_check_height}\",
      \"consensus_create_empty_blocks\": \"${configtoml_consensus_create_empty_blocks}\",
      \"consensus_create_empty_blocks_interval\": \"${configtoml_consensus_create_empty_blocks_interval}\",
      \"consensus_peer_gossip_sleep_duration\": \"${configtoml_consensus_peer_gossip_sleep_duration}\",
      \"consensus_peer_gossip_intraloop_sleep_duration\": \"${configtoml_consensus_peer_gossip_intraloop_sleep_duration}\",
      \"consensus_peer_query_maj23_sleep_duration\": \"${configtoml_consensus_peer_query_maj23_sleep_duration}\",
      \"storage_discard_abci_responses\": \"${configtoml_storage_discard_abci_responses}\",
	    \"storage_experimental_db_key_layout\": \"${configtoml_storage_experimental_db_key_layout}\",
      \"storage_compact\": \"${configtoml_storage_compact}\",
      \"storage_compaction_interval\": \"${configtoml_storage_compaction_interval}\",
      \"storage_pruning_interval\": \"${configtoml_storage_pruning_interval}\",
      \"storage_pruning_data_companion_enabled\": \"${configtoml_storage_pruning_data_companion_enabled}\",
      \"storage_pruning_data_companion_initial_block_retain_height\": \"${configtoml_storage_pruning_data_companion_initial_block_retain_height}\",
      \"storage_pruning_data_companion_initial_block_results_retain_height\": \"${configtoml_storage_pruning_data_companion_initial_block_results_retain_height}\",
      \"tx_index_indexer\": \"${configtoml_tx_index_indexer}\",
      \"tx_index_psql_conn\": \"${configtoml_tx_index_psql_conn}\",
      \"instrumentation_prometheus\": \"${configtoml_instrumentation_prometheus}\",
      \"instrumentation_prometheus_listen_addr\": \"${configtoml_instrumentation_prometheus_listen_addr}\",
      \"instrumentation_max_open_connections\": \"${configtoml_instrumentation_max_open_connections}\",
      \"instrumentation_namespace\": \"${configtoml_instrumentation_namespace}\"
    }"

		jq -n \
			--arg chain_id "$chain_id" \
			--arg moniker "$moniker" \
			--arg network "$network" \
			--argjson validators "$validators" \
			--argjson full_nodes "$full_nodes" \
			--argjson pruned_nodes "$pruned_nodes" \
			--argjson total_nodes "$total_nodes" \
			--arg beranode_dir "$BERANODES_PATH" \
			--argjson skip_genesis "$skip_genesis" \
			--argjson force "$force" \
			--arg mode "$mode" \
			--arg wallet_private_key "$wallet_private_key" \
			--arg wallet_address "$wallet_address" \
			--arg wallet_balance "$wallet_balance" \
			--argjson nodes "$(echo "[${nodes_combined}]" | jq .)" \
			--argjson clienttoml "$clienttoml" \
			--argjson apptoml "$apptoml" \
			--argjson configtoml "$configtoml" \
			'{
            chain_id: $chain_id,
            moniker: $moniker,
            network: $network,
            validators: $validators,
            full_nodes: $full_nodes,
            pruned_nodes: $pruned_nodes,
            total_nodes: $total_nodes,
            beranode_dir: $beranode_dir,
            skip_genesis: $skip_genesis,
            force: $force,
            mode: $mode,
            wallet_private_key: $wallet_private_key,
            wallet_address: $wallet_address,
            wallet_balance: $wallet_balance,
            nodes: $nodes,
            clienttoml: $clienttoml,
            apptoml: $apptoml,
            configtoml: $configtoml
          }' >"${config_json_path}"

		if [[ $? -eq 0 ]]; then
			log_success "Beranode configuration written to ${config_json_path}"
		else
			log_error "Could not write configuration to ${config_json_path}"
			return 1
		fi

		# =========================================================================
		# [9] KZG TRUSTED SETUP FILE SETUP
		# =========================================================================
		# Download kzg-trusted-setup.json and generate eth-genesis.json

		# Check if kzg-trusted-setup.json exists, otherwise download it
		if [[ ! -f "${BERANODES_PATH}/tmp/kzg-trusted-setup.json" ]]; then
			log_info "Downloading kzg-trusted-setup.json to ${BERANODES_PATH}/tmp"
			echo "$REPO_BEACONKIT/kzg-trusted-setup.json"
			curl -s -o "${BERANODES_PATH}/tmp/kzg-trusted-setup.json" "$REPO_BEACONKIT/kzg-trusted-setup.json"
			if [[ $? -eq 0 ]]; then
				log_success "Downloaded kzg-trusted-setup.json successfully."
			else
				log_error "Failed to download kzg-trusted-setup.json."
				return 1
			fi
		else
			log_info "kzg-trusted-setup.json already exists in ${BERANODES_PATH}/tmp"
		fi

		# =========================================================================
		# [10] GENESIS FILE SETUP
		# =========================================================================
		# Step 1: Generate base beranodes.config.json file
		generate_base_beacond_config \
			--config-dir "${BERANODES_PATH}" \
			--chain-spec "${network}"

		# Step 2: Generates a eth-genesis.json file that is shared with all nodes
		generate_eth_genesis_file \
			--config-dir "${BERANODES_PATH}" \
			--chain-id "${CHAIN_ID_DEVNET}" \
			--prague1-time ${ETH_GENESIS_PRAGUE1_TIME} \
			--prague1-base-fee-change-denominator ${ETH_GENESIS_PRAGUE1_BASE_FEE_CHANGE_DENOMINATOR} \
			--prague1-min-base-fee ${ETH_GENESIS_PRAGUE1_MIN_BASE_FEE} \
			--prague1-pol-distributor ${ETH_GENESIS_PRAGUE1_POL_DISTRIBUTOR} \
			--prague2-time ${ETH_GENESIS_PRAGUE2_TIME} \
			--prague2-min-base-fee ${ETH_GENESIS_PRAGUE2_MIN_BASE_FEE} \
			--prague3-time ${ETH_GENESIS_PRAGUE3_TIME} \
			--prague3-bex-vault ${ETH_GENESIS_PRAGUE3_BEX_VAULT} \
			--prague3-rescue-address ${ETH_GENESIS_PRAGUE3_RESCUE_ADDRESS} \
			--prague3-blocked-addresses ${ETH_GENESIS_PRAGUE3_BLOCKED_ADDRESSES} \
			--prague4-time ${ETH_GENESIS_PRAGUE4_TIME} \
			--eth-genesis-custom0-contract-address ${wallet_address} \
			--eth-genesis-custom0-contract-balance ${wallet_balance}

		# Step X: Generate beacon-kit genesis.json, configured premined deposits and deposit storage in eth-genesis.json
		generate_beacond_genesis_file_and_premined_deposits_storage \
			--config-dir "${BERANODES_PATH}" \
			--chain-spec "${network}"
	fi
}


# =============================================================================
# start
# Source: commands/start.sh
# =============================================================================

show_start_help() {
	cat <<EOF
Usage: beranode start [OPTIONS]

Start Berachain nodes based on the configuration file.

Options:
  --beranodes-dir <path>    Specify the beranodes directory path
                            (default: \$PWD/beranodes)
  --help|-h                 Display this help message

Examples:
  beranode start
  beranode start --beranodes-dir /custom/path
  beranode start --help

EOF
}

# =============================================================================
# [SECTION 2] Main Start Command Function
# =============================================================================
# Primary entry point for the start command. Orchestrates the entire node
# startup process from configuration parsing to node initialization.
# =============================================================================

cmd_start() {
	# Enable debug output if DEBUG_MODE is set
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: cmd_start" >&2

	# -------------------------------------------------------------------------
	# [STEP 1] Command-Line Argument Parsing
	# -------------------------------------------------------------------------
	# Parse and validate command-line options. Supports:
	# - --beranodes-dir: Custom directory for node data
	# - --help/-h: Display help information
	# -------------------------------------------------------------------------

	local beranodes_dir="${BERANODES_PATH_DEFAULT}"

	while [[ $# -gt 0 ]]; do
		case $1 in
		--beranodes-dir)
			if [[ -z "$2" ]] || [[ "$2" == --* ]]; then
				log_warn "--beranodes-dir not provided or missing argument. Defaulting to: $beranodes_dir"
				shift
			else
				beranodes_dir="$2"
				shift 2
			fi
			;;
		--help | -h)
			show_start_help
			return 0
			;;
		*)
			log_error "Unknown option: $1"
			show_start_help
			return 1
			;;
		esac
	done

	# -------------------------------------------------------------------------
	# [STEP 2] Configuration File Validation
	# -------------------------------------------------------------------------
	# Verify the existence of beranodes.config.json in the specified directory.
	# This file contains all node configuration parameters including:
	# - Network type (devnet/testnet/mainnet)
	# - Node counts (validators, full nodes, pruned nodes)
	# - Port configurations
	# - Wallet addresses and keys
	# -------------------------------------------------------------------------

	log_info "Starting Beranode in ${beranodes_dir} directory"

	print_header "Starting Beranode"
	local beranodes_config_path="${beranodes_dir}/beranodes.config.json"

	if ! [[ -f "${beranodes_config_path}" ]]; then
		log_error "Beranode configuration file does not exist: ${beranodes_dir}/beranodes.config.json"
		return 1
	else
		log_success "Beranode configuration file exists: ${beranodes_config_path}"
	fi

	# This will ensure all required fields are present and properly formatted
	# Validate the beranodes configuration JSON file before proceeding
	if ! validate_beranodes_config "${beranodes_config_path}"; then
		log_error "Configuration validation failed. Please review errors above and fix your beranodes.config.json file."
		return 1
	else
		log_success "beranodes.config.json passed validation."
	fi

	# -------------------------------------------------------------------------
	# [STEP 3] Configuration Parsing
	# -------------------------------------------------------------------------
	# Extract all configuration values from beranodes.config.json using jq.
	# These values control node behavior, network settings, and resource
	# allocation throughout the startup process.
	# -------------------------------------------------------------------------

	print_header "Beranode Configuration"
	log_info "Configuration file: ${beranodes_config_path}"

	local config_json_path="${beranodes_dir}/beranodes.config.json"

	# Binary paths
	local beranodes_dir=$(jq -r '.beranode_dir' "${config_json_path}")
	local bin_beacond="$beranodes_dir${BERANODES_PATH_BIN}/${BIN_BEACONKIT}"
	local bin_bera_reth="$beranodes_dir${BERANODES_PATH_BIN}/${BIN_BERARETH}"

	# Node identity and network configuration
	local moniker=$(jq -r '.moniker' "${config_json_path}")
	local network=$(jq -r '.network' "${config_json_path}")

	# Node count configuration
	local validators=$(jq -r '.validators' "${config_json_path}")
	local full_nodes=$(jq -r '.full_nodes' "${config_json_path}")
	local pruned_nodes=$(jq -r '.pruned_nodes' "${config_json_path}")
	local total_nodes=$(jq -r '.total_nodes' "${config_json_path}")

	# Directory and operational settings
	local beranode_dir=$(jq -r '.beranode_dir' "${config_json_path}")
	local skip_genesis=$(jq -r '.skip_genesis' "${config_json_path}")
	local force=$(jq -r '.force' "${config_json_path}")
	local mode=$(jq -r '.mode' "${config_json_path}")

	# Wallet configuration
	local wallet_private_key=$(jq -r '.wallet_private_key' "${config_json_path}")
	local wallet_address=$(jq -r '.wallet_address' "${config_json_path}")

	# Node-specific configurations (array of node objects)
	local nodes=$(jq -r '.nodes' "${config_json_path}")
	local nodes_count=$(echo "${nodes}" | jq -r '. | length')

	# Get all ports and check if they are currently in use
	local ports=()
	for ((node_index = 0; node_index < ${nodes_count}; node_index++)); do
		local json=$(echo "${nodes}" | jq -r ".[$node_index]")
		local ethrpc_port=$(echo "${json}" | jq -r '.ethrpc_port')
		local ethp2p_port=$(echo "${json}" | jq -r '.ethp2p_port')
		local ethproxy_port=$(echo "${json}" | jq -r '.ethproxy_port')
		local el_ethrpc_port=$(echo "${json}" | jq -r '.el_ethrpc_port')
		local el_authrpc_port=$(echo "${json}" | jq -r '.el_authrpc_port')
		local el_eth_port=$(echo "${json}" | jq -r '.el_eth_port')
		local el_prometheus_port=$(echo "${json}" | jq -r '.el_prometheus_port')
		local cl_prometheus_port=$(echo "${json}" | jq -r '.cl_prometheus_port')
		local beacond_node_port=$(echo "${json}" | jq -r '.beacond_node_port')
		local configtoml_grpc_laddr=$(echo "${json}" | jq -r '.configtoml_grpc_laddr')
		local configtoml_grpc_privileged_laddr=$(echo "${json}" | jq -r '.configtoml_grpc_privileged_laddr')
		ports[${node_index}]="${ethrpc_port} ${ethp2p_port} ${ethproxy_port} ${el_ethrpc_port} ${el_authrpc_port} ${el_eth_port} ${el_prometheus_port} ${cl_prometheus_port} ${beacond_node_port} ${configtoml_grpc_laddr} ${configtoml_grpc_privileged_laddr}"
	done
	log_info "Checking if ports are in use:\n${ports[*]}\n"
	for port in "${ports[@]}"; do
		# Only check ports that are numbers, skip empty/invalid ones to avoid "No such file or directory"
		if [[ "$port" =~ ^[0-9]+$ ]]; then
			if lsof -iTCP:"${port}" -sTCP:LISTEN >/dev/null 2>&1; then
				log_error "Port ${port} is already in use"
				return 1
			fi
		fi
	done
	log_success "All ports are available"

	# -------------------------------------------------------------------------
	# [DEBUG] Node Configuration Inspection (Currently Disabled)
	# -------------------------------------------------------------------------
	# Uncomment this section to debug individual node configurations.
	# Useful for troubleshooting port conflicts or misconfigurations.
	# -------------------------------------------------------------------------

	# -------------------------------------------------------------------------
	# [STEP 5] Network-Specific Initialization
	# -------------------------------------------------------------------------
	# Route to the appropriate network handler based on the configuration.
	# Currently supports: devnet (local development)
	# Planned: bepolia (testnet), mainnet (production)
	# -------------------------------------------------------------------------

	if [[ "${network}" == "${CHAIN_NAME_DEVNET}" ]]; then
		log_info "Starting Beranode in ${CHAIN_NAME_DEVNET} network"

		# ---------------------------------------------------------------------
		# [STEP 5.1] Mode Selection: Local Development
		# ---------------------------------------------------------------------
		# Local mode: Single-machine deployment for development/testing
		# - Runs all nodes on localhost with incremental ports
		# - Suitable for rapid iteration and testing
		# ---------------------------------------------------------------------

		if [[ "${mode}" == "local" ]]; then
			log_info "Starting Beranode in local mode"

			# Do a a check if `beranode_dir/nodes` has any directories, if so, ask if the user wants to delete them
			if [ -d "${beranode_dir}/nodes" ] && [ "$(ls -A "${beranode_dir}/nodes")" ]; then
				log_warn "Node directories already exist in ${beranode_dir}/nodes"
				read -p "Do you want to delete them? (y/n) " delete_nodes
				if [ "${delete_nodes}" == "y" ]; then
					rm -rf "${beranode_dir}/nodes"
					log_info "Node directories deleted"
				else
					log_error "Node directories not deleted. stopping..."
					return 1
				fi
			fi
			mkdir -p "${beranode_dir}/nodes"
			log_info "Node directories created in ${beranode_dir}/nodes"

			local network=$(jq -r '.network' "${config_json_path}")
			local chain_id="${CHAIN_ID_DEVNET}"
			local chain_spec="${CHAIN_NAME_DEVNET}"
			local chain_id_beacond=$(jq -r '.clienttoml.chain_id' "${config_json_path}")

			local wallet_address=$(jq -r '.wallet_address' "${config_json_path}")
			local wallet_private_key=$(jq -r '.wallet_private_key' "${config_json_path}")
			local wallet_balance=$(jq -r '.wallet_balance' "${config_json_path}")

			# get all seeds and peers
			local seeds=()
			local peers=()
			local p2p_ports=()
			local berareth_bootnodes=()
			local berareth_trusted_peers=()
			local berareth_el_eth_port=()
			for ((node_index = 0; node_index < ${nodes_count}; node_index++)); do
				local json=$(echo "${nodes}" | jq -r ".[$node_index]")
				local id=$(echo "${json}" | jq -r '.beacond_config.node_id')
				seeds[${node_index}]="${id}"
				peers[${node_index}]="${id}"
				p2p_ports[${node_index}]=$(echo "${json}" | jq -r '.ethp2p_port')
				berareth_bootnodes[${node_index}]=$(echo "${json}" | jq -r '.berareth_config.public_key')
				berareth_trusted_peers[${node_index}]=$(echo "${json}" | jq -r '.berareth_config.public_key')
				berareth_el_eth_port[${node_index}]=$(echo "${json}" | jq -r '.el_eth_port')
			done

			for ((node_index = 0; node_index < ${nodes_count}; node_index++)); do
				echo "--------------------------------"
				echo "Configuring node $node_index"
				echo "--------------------------------"

				local node_json=$(echo "${nodes}" | jq -r ".[$node_index]")
				local role=$(echo "${node_json}" | jq -r '.role')
				local moniker=$(echo "${node_json}" | jq -r '.moniker')
				local node_key_type=$(echo "${node_json}" | jq -r '.beacond_config.node_key.priv_key.type')
				local node_key_value=$(echo "${node_json}" | jq -r '.beacond_config.node_key.priv_key.value')
				local node_id=$(echo "${node_json}" | jq -r '.node_id')
				local priv_validator_key_address=$(echo "${node_json}" | jq -r '.beacond_config.priv_validator_key.address')
				local priv_validator_key_pubkey_type=$(echo "${node_json}" | jq -r '.beacond_config.priv_validator_key.pub_key.type')
				local priv_validator_key_pubkey_value=$(echo "${node_json}" | jq -r '.beacond_config.priv_validator_key.pub_key.value')
				local priv_validator_key_privkey_type=$(echo "${node_json}" | jq -r '.beacond_config.priv_validator_key.priv_key.type')
				local priv_validator_key_privkey_value=$(echo "${node_json}" | jq -r '.beacond_config.priv_validator_key.priv_key.value')
				local premined_deposit=$(echo "${node_json}" | jq -r '.premined_deposit')
				local deposit_amount=$(echo "${node_json}" | jq -r '.deposit_amount')
				local jwt=$(echo "${node_json}" | jq -r '.beacond_config.jwt')
				local comet_address=$(echo "${node_json}" | jq -r '.beacond_config.comet_address')
				local comet_pubkey=$(echo "${node_json}" | jq -r '.beacond_config.comet_pubkey')
				local eth_beacon_pubkey=$(echo "${node_json}" | jq -r '.beacond_config.eth_beacon_pubkey')

				# ports
				local ethrpc_port=$(echo "${node_json}" | jq -r '.ethrpc_port')
				local ethp2p_port=$(echo "${node_json}" | jq -r '.ethp2p_port')
				local ethproxy_port=$(echo "${node_json}" | jq -r '.ethproxy_port')
				local el_ethrpc_port=$(echo "${node_json}" | jq -r '.el_ethrpc_port')
				local el_authrpc_port=$(echo "${node_json}" | jq -r '.el_authrpc_port')
				local el_eth_port=$(echo "${node_json}" | jq -r '.el_eth_port')
				local el_prometheus_port=$(echo "${node_json}" | jq -r '.el_prometheus_port')
				local cl_prometheus_port=$(echo "${node_json}" | jq -r '.cl_prometheus_port')
				local beacond_node_port=$(echo "${node_json}" | jq -r '.beacond_node_port')

				# client.toml variables
				local clienttoml_chain_id=$(jq -r '.clienttoml.chain_id' "${config_json_path}")
				local clienttoml_keyring_backend=$(jq -r '.clienttoml.keyring_backend' "${config_json_path}")
				local clienttoml_keyring_default_keyname=$(jq -r '.clienttoml.keyring_default_keyname' "${config_json_path}")
				local clienttoml_output=$(jq -r '.clienttoml.output' "${config_json_path}")
				local clienttoml_node=$(jq -r '.clienttoml.node' "${config_json_path}")
				local clienttoml_broadcast_mode=$(jq -r '.clienttoml.broadcast_mode' "${config_json_path}")
				local clienttoml_grpc_address=$(jq -r '.clienttoml.grpc_address' "${config_json_path}")
				local clienttoml_grpc_insecure=$(jq -r '.clienttoml.grpc_insecure' "${config_json_path}")

				# app.toml variables
				local apptoml_pruning=$(jq -r '.apptoml.pruning' "${config_json_path}")
				local apptoml_pruning_keep_recent=$(jq -r '.apptoml.pruning_keep_recent' "${config_json_path}")
				local apptoml_pruning_interval=$(jq -r '.apptoml.pruning_interval' "${config_json_path}")
				local apptoml_halt_height=$(jq -r '.apptoml.halt_height' "${config_json_path}")
				local apptoml_halt_time=$(jq -r '.apptoml.halt_time' "${config_json_path}")
				local apptoml_min_retain_blocks=$(jq -r '.apptoml.min_retain_blocks' "${config_json_path}")
				local apptoml_inter_block_cache=$(jq -r '.apptoml.inter_block_cache' "${config_json_path}")
				local apptoml_iavl_cache_size=$(jq -r '.apptoml.iavl_cache_size' "${config_json_path}")
				local apptoml_iavl_disable_fastnode=$(jq -r '.apptoml.iavl_disable_fastnode' "${config_json_path}")
				local apptoml_telemetry_service_name=$(jq -r '.apptoml.telemetry_service_name' "${config_json_path}")
				local apptoml_telemetry_enabled=$(jq -r '.apptoml.telemetry_enabled' "${config_json_path}")
				local apptoml_telemetry_enable_hostname=$(jq -r '.apptoml.telemetry_enable_hostname' "${config_json_path}")
				local apptoml_telemetry_enable_hostname_label=$(jq -r '.apptoml.telemetry_enable_hostname_label' "${config_json_path}")
				local apptoml_telemetry_enable_service_label=$(jq -r '.apptoml.telemetry_enable_service_label' "${config_json_path}")
				local apptoml_telemetry_prometheus_retention_time=$(jq -r '.apptoml.telemetry_prometheus_retention_time' "${config_json_path}")
				local apptoml_telemetry_global_labels=$(jq -r '.apptoml.telemetry_global_labels' "${config_json_path}")
				local apptoml_telemetry_metrics_sink=$(jq -r '.apptoml.telemetry_metrics_sink' "${config_json_path}")
				local apptoml_telemetry_statsd_addr=$(jq -r '.apptoml.telemetry_statsd_addr' "${config_json_path}")
				local apptoml_telemetry_datadog_hostname=$(jq -r '.apptoml.telemetry_datadog_hostname' "${config_json_path}")
				local apptoml_beacon_kit_chain_spec=$(jq -r '.apptoml.beacon_kit_chain_spec' "${config_json_path}")
				local apptoml_beacon_kit_chain_spec_file=$(jq -r '.apptoml.beacon_kit_chain_spec_file' "${config_json_path}")
				local apptoml_beacon_kit_shutdown_timeout=$(jq -r '.apptoml.beacon_kit_shutdown_timeout' "${config_json_path}")
				local apptoml_beacon_kit_engine_rpc_dial_url=$(jq -r '.apptoml.beacon_kit_engine_rpc_dial_url' "${config_json_path}")
				local apptoml_beacon_kit_engine_rpc_timeout=$(jq -r '.apptoml.beacon_kit_engine_rpc_timeout' "${config_json_path}")
				local apptoml_beacon_kit_engine_rpc_startup_check_interval=$(jq -r '.apptoml.beacon_kit_engine_rpc_startup_check_interval' "${config_json_path}")
				local apptoml_beacon_kit_engine_rpc_jwt_refresh_interval=$(jq -r '.apptoml.beacon_kit_engine_rpc_jwt_refresh_interval' "${config_json_path}")
				local apptoml_beacon_kit_engine_jwt_secret_path=$(jq -r '.apptoml.beacon_kit_engine_jwt_secret_path' "${config_json_path}")
				local apptoml_beacon_kit_logger_time_format=$(jq -r '.apptoml.beacon_kit_logger_time_format' "${config_json_path}")
				local apptoml_beacon_kit_logger_log_level=$(jq -r '.apptoml.beacon_kit_logger_log_level' "${config_json_path}")
				local apptoml_beacon_kit_logger_style=$(jq -r '.apptoml.beacon_kit_logger_style' "${config_json_path}")
				local apptoml_beacon_kit_kzg_trusted_setup_path=$(jq -r '.apptoml.beacon_kit_kzg_trusted_setup_path' "${config_json_path}")
				local apptoml_beacon_kit_kzg_implementation=$(jq -r '.apptoml.beacon_kit_kzg_implementation' "${config_json_path}")
				local apptoml_beacon_kit_payload_builder_enabled=$(jq -r '.apptoml.beacon_kit_payload_builder_enabled' "${config_json_path}")
				local apptoml_beacon_kit_payload_builder_suggested_fee_recipient=$(jq -r '.apptoml.beacon_kit_payload_builder_suggested_fee_recipient' "${config_json_path}")
				local apptoml_beacon_kit_payload_builder_payload_timeout=$(jq -r '.apptoml.beacon_kit_payload_builder_payload_timeout' "${config_json_path}")
				local apptoml_beacon_kit_validator_graffiti=$(jq -r '.apptoml.beacon_kit_validator_graffiti' "${config_json_path}")
				local apptoml_beacon_kit_validator_availability_window=$(jq -r '.apptoml.beacon_kit_validator_availability_window' "${config_json_path}")
				local apptoml_beacon_kit_node_api_enabled=$(jq -r '.apptoml.beacon_kit_node_api_enabled' "${config_json_path}")
				local apptoml_beacon_kit_node_api_address=$(jq -r '.apptoml.beacon_kit_node_api_address' "${config_json_path}")
				local apptoml_beacon_kit_node_api_logging=$(jq -r '.apptoml.beacon_kit_node_api_logging' "${config_json_path}")

				# config.toml variables
				local configtoml_version=$(jq -r '.configtoml.version' "${config_json_path}")
				local configtoml_proxy_app=$(jq -r '.configtoml.proxy_app' "${config_json_path}")
				local configtoml_moniker=$(jq -r '.configtoml.moniker' "${config_json_path}")
				local configtoml_db_backend=$(jq -r '.configtoml.db_backend' "${config_json_path}")
				local configtoml_db_dir=$(jq -r '.configtoml.db_dir' "${config_json_path}")
				local configtoml_log_level=$(jq -r '.configtoml.log_level' "${config_json_path}")
				local configtoml_log_format=$(jq -r '.configtoml.log_format' "${config_json_path}")
				local configtoml_genesis_file=$(jq -r '.configtoml.genesis_file' "${config_json_path}")
				local configtoml_priv_validator_key_file=$(jq -r '.configtoml.priv_validator_key_file' "${config_json_path}")
				local configtoml_priv_validator_state_file=$(jq -r '.configtoml.priv_validator_state_file' "${config_json_path}")
				local configtoml_priv_validator_laddr=$(jq -r '.configtoml.priv_validator_laddr' "${config_json_path}")
				local configtoml_node_key_file=$(jq -r '.configtoml.node_key_file' "${config_json_path}")
				local configtoml_abci=$(jq -r '.configtoml.abci' "${config_json_path}")
				local configtoml_filter_peers=$(jq -r '.configtoml.filter_peers' "${config_json_path}")
				local configtoml_rpc_laddr=$(jq -r '.configtoml.rpc_laddr' "${config_json_path}")
				local configtoml_rpc_cors_allowed_origins=$(jq -r '.configtoml.rpc_cors_allowed_origins' "${config_json_path}")
				local configtoml_rpc_cors_allowed_methods=$(jq -r '.configtoml.rpc_cors_allowed_methods' "${config_json_path}")
				local configtoml_rpc_cors_allowed_headers=$(jq -r '.configtoml.rpc_cors_allowed_headers' "${config_json_path}")
				local configtoml_rpc_unsafe=$(jq -r '.configtoml.rpc_unsafe' "${config_json_path}")
				local configtoml_rpc_max_open_connections=$(jq -r '.configtoml.rpc_max_open_connections' "${config_json_path}")
				local configtoml_rpc_max_subscription_clients=$(jq -r '.configtoml.rpc_max_subscription_clients' "${config_json_path}")
				local configtoml_rpc_max_subscriptions_per_client=$(jq -r '.configtoml.rpc_max_subscriptions_per_client' "${config_json_path}")
				local configtoml_rpc_experimental_subscription_buffer_size=$(jq -r '.configtoml.rpc_experimental_subscription_buffer_size' "${config_json_path}")
				local configtoml_rpc_experimental_websocket_write_buffer_size=$(jq -r '.configtoml.rpc_experimental_websocket_write_buffer_size' "${config_json_path}")
				local configtoml_rpc_experimental_close_on_slow_client=$(jq -r '.configtoml.rpc_experimental_close_on_slow_client' "${config_json_path}")
				local configtoml_rpc_timeout_broadcast_tx_commit=$(jq -r '.configtoml.rpc_timeout_broadcast_tx_commit' "${config_json_path}")
				local configtoml_rpc_max_request_batch_size=$(jq -r '.configtoml.rpc_max_request_batch_size' "${config_json_path}")
				local configtoml_rpc_max_body_bytes=$(jq -r '.configtoml.rpc_max_body_bytes' "${config_json_path}")
				local configtoml_rpc_max_header_bytes=$(jq -r '.configtoml.rpc_max_header_bytes' "${config_json_path}")
				local configtoml_rpc_tls_cert_file=$(jq -r '.configtoml.rpc_tls_cert_file' "${config_json_path}")
				local configtoml_rpc_tls_key_file=$(jq -r '.configtoml.rpc_tls_key_file' "${config_json_path}")
				local configtoml_rpc_pprof_laddr=$(jq -r '.configtoml.rpc_pprof_laddr' "${config_json_path}")
				local configtoml_grpc_laddr=$(jq -r '.configtoml.grpc_laddr' "${config_json_path}")
				local configtoml_grpc_version_service_enabled=$(jq -r '.configtoml.grpc_version_service_enabled' "${config_json_path}")
				local configtoml_grpc_block_service_enabled=$(jq -r '.configtoml.grpc_block_service_enabled' "${config_json_path}")
				local configtoml_grpc_block_results_service_enabled=$(jq -r '.configtoml.grpc_block_results_service_enabled' "${config_json_path}")
				local configtoml_grpc_privileged_laddr=$(jq -r '.configtoml.grpc_privileged_laddr' "${config_json_path}")
				local configtoml_grpc_privileged_pruning_service_enabled=$(jq -r '.configtoml.grpc_privileged_pruning_service_enabled' "${config_json_path}")
				local configtoml_p2p_laddr=$(jq -r '.configtoml.p2p_laddr' "${config_json_path}")
				local configtoml_p2p_external_address=$(jq -r '.configtoml.p2p_external_address' "${config_json_path}")
				local configtoml_p2p_seeds=$(jq -r '.configtoml.p2p_seeds' "${config_json_path}")
				local configtoml_p2p_persistent_peers=$(jq -r '.configtoml.p2p_persistent_peers' "${config_json_path}")
				local configtoml_p2p_addr_book_file=$(jq -r '.configtoml.p2p_addr_book_file' "${config_json_path}")
				local configtoml_p2p_addr_book_strict=$(jq -r '.configtoml.p2p_addr_book_strict' "${config_json_path}")
				local configtoml_p2p_max_num_inbound_peers=$(jq -r '.configtoml.p2p_max_num_inbound_peers' "${config_json_path}")
				local configtoml_p2p_max_num_outbound_peers=$(jq -r '.configtoml.p2p_max_num_outbound_peers' "${config_json_path}")
				local configtoml_p2p_unconditional_peer_ids=$(jq -r '.configtoml.p2p_unconditional_peer_ids' "${config_json_path}")
				local configtoml_p2p_persistent_peers_max_dial_period=$(jq -r '.configtoml.p2p_persistent_peers_max_dial_period' "${config_json_path}")
				local configtoml_p2p_flush_throttle_timeout=$(jq -r '.configtoml.p2p_flush_throttle_timeout' "${config_json_path}")
				local configtoml_p2p_max_packet_msg_payload_size=$(jq -r '.configtoml.p2p_max_packet_msg_payload_size' "${config_json_path}")
				local configtoml_p2p_send_rate=$(jq -r '.configtoml.p2p_send_rate' "${config_json_path}")
				local configtoml_p2p_recv_rate=$(jq -r '.configtoml.p2p_recv_rate' "${config_json_path}")
				local configtoml_p2p_pex=$(jq -r '.configtoml.p2p_pex' "${config_json_path}")
				local configtoml_p2p_seed_mode=$(jq -r '.configtoml.p2p_seed_mode' "${config_json_path}")
				local configtoml_p2p_private_peer_ids=$(jq -r '.configtoml.p2p_private_peer_ids' "${config_json_path}")
				local configtoml_p2p_allow_duplicate_ip=$(jq -r '.configtoml.p2p_allow_duplicate_ip' "${config_json_path}")
				local configtoml_p2p_handshake_timeout=$(jq -r '.configtoml.p2p_handshake_timeout' "${config_json_path}")
				local configtoml_p2p_dial_timeout=$(jq -r '.configtoml.p2p_dial_timeout' "${config_json_path}")
				local configtoml_mempool_type=$(jq -r '.configtoml.mempool_type' "${config_json_path}")
				local configtoml_mempool_recheck=$(jq -r '.configtoml.mempool_recheck' "${config_json_path}")
				local configtoml_mempool_recheck_timeout=$(jq -r '.configtoml.mempool_recheck_timeout' "${config_json_path}")
				local configtoml_mempool_broadcast=$(jq -r '.configtoml.mempool_broadcast' "${config_json_path}")
				local configtoml_mempool_wal_dir=$(jq -r '.configtoml.mempool_wal_dir' "${config_json_path}")
				local configtoml_mempool_size=$(jq -r '.configtoml.mempool_size' "${config_json_path}")
				local configtoml_mempool_max_tx_bytes=$(jq -r '.configtoml.mempool_max_tx_bytes' "${config_json_path}")
				local configtoml_mempool_max_txs_bytes=$(jq -r '.configtoml.mempool_max_txs_bytes' "${config_json_path}")
				local configtoml_mempool_cache_size=$(jq -r '.configtoml.mempool_cache_size' "${config_json_path}")
				local configtoml_mempool_keep_invalid_txs_in_cache=$(jq -r '.configtoml.mempool_keep_invalid_txs_in_cache' "${config_json_path}")
				local configtoml_statesync_enable=$(jq -r '.configtoml.statesync_enable' "${config_json_path}")
				local configtoml_statesync_rpc_servers=$(jq -r '.configtoml.statesync_rpc_servers' "${config_json_path}")
				local configtoml_statesync_trust_height=$(jq -r '.configtoml.statesync_trust_height' "${config_json_path}")
				local configtoml_statesync_trust_hash=$(jq -r '.configtoml.statesync_trust_hash' "${config_json_path}")
				local configtoml_statesync_trust_period=$(jq -r '.configtoml.statesync_trust_period' "${config_json_path}")
				local configtoml_statesync_discovery_time=$(jq -r '.configtoml.statesync_discovery_time' "${config_json_path}")
				local configtoml_statesync_temp_dir=$(jq -r '.configtoml.statesync_temp_dir' "${config_json_path}")
				local configtoml_statesync_chunk_request_timeout=$(jq -r '.configtoml.statesync_chunk_request_timeout' "${config_json_path}")
				local configtoml_statesync_chunk_fetchers=$(jq -r '.configtoml.statesync_chunk_fetchers' "${config_json_path}")
				local configtoml_blocksync_version=$(jq -r '.configtoml.blocksync_version' "${config_json_path}")
				local configtoml_consensus_wal_file=$(jq -r '.configtoml.consensus_wal_file' "${config_json_path}")
				local configtoml_consensus_timeout_propose=$(jq -r '.configtoml.consensus_timeout_propose' "${config_json_path}")
				local configtoml_consensus_timeout_propose_delta=$(jq -r '.configtoml.consensus_timeout_propose_delta' "${config_json_path}")
				local configtoml_consensus_timeout_prevote=$(jq -r '.configtoml.consensus_timeout_prevote' "${config_json_path}")
				local configtoml_consensus_timeout_prevote_delta=$(jq -r '.configtoml.consensus_timeout_prevote_delta' "${config_json_path}")
				local configtoml_consensus_timeout_precommit=$(jq -r '.configtoml.consensus_timeout_precommit' "${config_json_path}")
				local configtoml_consensus_timeout_precommit_delta=$(jq -r '.configtoml.consensus_timeout_precommit_delta' "${config_json_path}")
				local configtoml_consensus_timeout_commit=$(jq -r '.configtoml.consensus_timeout_commit' "${config_json_path}")
				local configtoml_consensus_skip_timeout_commit=$(jq -r '.configtoml.consensus_skip_timeout_commit' "${config_json_path}")
				local configtoml_consensus_double_sign_check_height=$(jq -r '.configtoml.consensus_double_sign_check_height' "${config_json_path}")
				local configtoml_consensus_create_empty_blocks=$(jq -r '.configtoml.consensus_create_empty_blocks' "${config_json_path}")
				local configtoml_consensus_create_empty_blocks_interval=$(jq -r '.configtoml.consensus_create_empty_blocks_interval' "${config_json_path}")
				local configtoml_consensus_peer_gossip_sleep_duration=$(jq -r '.configtoml.consensus_peer_gossip_sleep_duration' "${config_json_path}")
				local configtoml_consensus_peer_gossip_intraloop_sleep_duration=$(jq -r '.configtoml.consensus_peer_gossip_intraloop_sleep_duration' "${config_json_path}")
				local configtoml_consensus_peer_query_maj23_sleep_duration=$(jq -r '.configtoml.consensus_peer_query_maj23_sleep_duration' "${config_json_path}")
				local configtoml_storage_discard_abci_responses=$(jq -r '.configtoml.storage_discard_abci_responses' "${config_json_path}")
				local configtoml_storage_experimental_db_key_layout=$(jq -r '.configtoml.storage_experimental_db_key_layout' "${config_json_path}")
				local configtoml_storage_compact=$(jq -r '.configtoml.storage_compact' "${config_json_path}")
				local configtoml_storage_compaction_interval=$(jq -r '.configtoml.storage_compaction_interval' "${config_json_path}")
				local configtoml_storage_pruning_interval=$(jq -r '.configtoml.storage_pruning_interval' "${config_json_path}")
				local configtoml_storage_pruning_data_companion_enabled=$(jq -r '.configtoml.storage_pruning_data_companion_enabled' "${config_json_path}")
				local configtoml_storage_pruning_data_companion_initial_block_retain_height=$(jq -r '.configtoml.storage_pruning_data_companion_initial_block_retain_height' "${config_json_path}")
				local configtoml_storage_pruning_data_companion_initial_block_results_retain_height=$(jq -r '.configtoml.storage_pruning_data_companion_initial_block_results_retain_height' "${config_json_path}")
				local configtoml_tx_index_indexer=$(jq -r '.configtoml.tx_index_indexer' "${config_json_path}")
				local configtoml_tx_index_psql_conn=$(jq -r '.configtoml.tx_index_psql_conn' "${config_json_path}")
				local configtoml_instrumentation_prometheus=$(jq -r '.configtoml.instrumentation_prometheus' "${config_json_path}")
				local configtoml_instrumentation_prometheus_listen_addr=$(jq -r '.configtoml.instrumentation_prometheus_listen_addr' "${config_json_path}")
				local configtoml_instrumentation_max_open_connections=$(jq -r '.configtoml.instrumentation_max_open_connections' "${config_json_path}")
				local configtoml_instrumentation_namespace=$(jq -r '.configtoml.instrumentation_namespace' "${config_json_path}")

				# Make node directories
				local node_dir="${beranodes_dir}${BERANODES_PATH_NODES}/${role}-${node_index}"
				local beacond_dir="${node_dir}/beacond"
				local bera_reth_dir="${node_dir}/bera-reth"
				mkdir -p "${node_dir}"
				mkdir -p "${beacond_dir}"
				mkdir -p "${bera_reth_dir}"
				log_success " Directories made"

				# Init beacond node
				${bin_beacond} init "${moniker}" --chain-id "${chain_id_beacond}" --beacon-kit.chain-spec "${chain_spec}" --home "${beacond_dir}" 2>/dev/null
				log_success " Beacond node initialized"

				# - replace priv_validator_key.json
				cat >"${beacond_dir}/config/priv_validator_key.json" <<EOF
{
  "address": "${priv_validator_key_address}",
  "pub_key": {
    "type": "${priv_validator_key_pubkey_type}",
    "value": "${priv_validator_key_pubkey_value}"
  },
  "priv_key": {
    "type": "${priv_validator_key_privkey_type}",
    "value": "${priv_validator_key_privkey_value}"
  }
}
EOF
				log_success " priv_validator_key.json replaced"

				# - replace node_key.json
				cat >"${beacond_dir}/config/node_key.json" <<EOF
{
  "priv_key": {
    "type": "${node_key_type}",
    "value": "${node_key_value}"
    }
  }
EOF
				log_success " node_key.json replaced"

				# - update genesis.json
				cp -f "${beranodes_dir}/tmp/genesis.json" "${node_dir}/beacond/config/genesis.json"
				log_success " genesis.json copied"

				# - add jwt.hex
				echo -n "${jwt}" >"${node_dir}/beacond/config/jwt.hex"
				log_success " jwt.hex added"

				# - update client.toml
				# chain-id
				sed "${SED_OPT[@]}" "s|^chain_id = \".*\"|chain_id = \"${chain_id_beacond}\"|" "${node_dir}/beacond/config/client.toml"
				# keyring-backend
				sed "${SED_OPT[@]}" "s|^keyring_backend = \".*\"|keyring_backend = \"${clienttoml_keyring_backend}\"|" "${node_dir}/beacond/config/client.toml"
				# keyring-default-keyname
				sed "${SED_OPT[@]}" "s|^keyring_default_keyname = \".*\"|keyring_default_keyname = \"${clienttoml_keyring_default_keyname}\"|" "${node_dir}/beacond/config/client.toml"
				# output
				sed "${SED_OPT[@]}" "s|^output = \".*\"|output = \"${clienttoml_output}\"|" "${node_dir}/beacond/config/client.toml"
				# node
				sed "${SED_OPT[@]}" "s|^node = \".*\"|node = \"tcp://localhost:${ethrpc_port}\"|" "${node_dir}/beacond/config/client.toml"
				# broadcast-mode
				sed "${SED_OPT[@]}" "s|^broadcast_mode = \".*\"|broadcast_mode = \"${clienttoml_broadcast_mode}\"|" "${node_dir}/beacond/config/client.toml"
				# grpc-address
				sed "${SED_OPT[@]}" "s|^grpc_address = \".*\"|grpc_address = \"${clienttoml_grpc_address}\"|" "${node_dir}/beacond/config/client.toml"
				# grpc-insecure
				sed "${SED_OPT[@]}" "s|^grpc_insecure = \".*\"|grpc_insecure = \"${clienttoml_grpc_insecure}\"|" "${node_dir}/beacond/config/client.toml"
				log_success " client.toml updated"

				# - update app.toml
				echo "--------------------------------"
				echo "app.toml"
				echo "--------------------------------"
				# [base]
				# pruning - TODO - revamp if pruned node
				sed "${SED_OPT[@]}" "s|^pruning = \".*\"|pruning = \"${apptoml_pruning}\"|" "${node_dir}/beacond/config/app.toml"
				# pruning-keep-recent
				sed "${SED_OPT[@]}" "s|^pruning-keep-recent = \".*\"|pruning-keep-recent = \"${apptoml_pruning_keep_recent}\"|" "${node_dir}/beacond/config/app.toml"
				# pruning-interval
				sed "${SED_OPT[@]}" "s|^pruning-interval = \".*\"|pruning-interval = \"${apptoml_pruning_interval}\"|" "${node_dir}/beacond/config/app.toml"
				# halt-height
				sed "${SED_OPT[@]}" "s|^halt-height = \".*\"|halt-height = \"${apptoml_halt_height}\"|" "${node_dir}/beacond/config/app.toml"
				# halt-time
				sed "${SED_OPT[@]}" "s|^halt-time = \".*\"|halt-time = \"${apptoml_halt_time}\"|" "${node_dir}/beacond/config/app.toml"
				# min-retain-blocks
				sed "${SED_OPT[@]}" "s|^min-retain-blocks = \".*\"|min-retain-blocks = \"${apptoml_min_retain_blocks}\"|" "${node_dir}/beacond/config/app.toml"
				# inter-block-cache
				sed "${SED_OPT[@]}" "s|^inter-block-cache = \".*\"|inter-block-cache = \"${apptoml_inter_block_cache}\"|" "${node_dir}/beacond/config/app.toml"
				# iavl-cache-size
				sed "${SED_OPT[@]}" "s|^iavl-cache-size = \".*\"|iavl-cache-size = \"${apptoml_iavl_cache_size}\"|" "${node_dir}/beacond/config/app.toml"
				# iavl-disable-fastnode
				sed "${SED_OPT[@]}" "s|^iiavl-disable-fastnode = \".*\"|iiavl-disable-fastnode = \"${apptoml_iavl_disable_fastnode}\"|" "${node_dir}/beacond/config/app.toml"
				# [telemetry]
				# service-name
				sed "${SED_OPT[@]}" "s|^service-name = \".*\"|service-name = \"${apptoml_telemetry_service_name}\"|" "${node_dir}/beacond/config/app.toml"
				# enabled
				sed "${SED_OPT[@]}" "70s|^enabled = .*|enabled = ${apptoml_telemetry_enabled}|" "${node_dir}/beacond/config/app.toml"
				# enable-hostname
				sed "${SED_OPT[@]}" "s|^enable-hostname = \".*\"|enable-hostname = \"${apptoml_telemetry_enable_hostname}\"|" "${node_dir}/beacond/config/app.toml"
				# enable-hostname-label
				sed "${SED_OPT[@]}" "s|^enable-hostname-label = \".*\"|enable-hostname-label = \"${apptoml_telemetry_enable_hostname_label}\"|" "${node_dir}/beacond/config/app.toml"
				# enable-service-label
				sed "${SED_OPT[@]}" "s|^enable-service-label = \".*\"|enable-service-label = \"${apptoml_telemetry_enable_service_label}\"|" "${node_dir}/beacond/config/app.toml"
				# prometheus-retention-time
				sed "${SED_OPT[@]}" "s|^prometheus-retention-time = \".*\"|prometheus-retention-time = \"${apptoml_telemetry_prometheus_retention_time}\"|" "${node_dir}/beacond/config/app.toml"
				# global-labels
				sed "${SED_OPT[@]}" "s|^global-labels = \[.*\]|global-labels = [\n${apptoml_telemetry_global_labels}\n]|" "${node_dir}/beacond/config/app.toml"
				# metrics-sink
				sed "${SED_OPT[@]}" "s|^metrics-sink = \".*\"|metrics-sink = \"${apptoml_telemetry_metrics_sink}\"|" "${node_dir}/beacond/config/app.toml"
				# statsd-addr
				sed "${SED_OPT[@]}" "s|^statsd-addr = \".*\"|statsd-addr = \"${apptoml_telemetry_statsd_addr}\"|" "${node_dir}/beacond/config/app.toml"
				# datadog-hostname
				sed "${SED_OPT[@]}" "s|^datadog-hostname = \".*\"|datadog-hostname = \"${moniker}\"|" "${node_dir}/beacond/config/app.toml"
				# [beacon-kit]
				# chain-spec
				sed "${SED_OPT[@]}" "s|^chain-spec = \".*\"|chain-spec = \"${apptoml_beacon_kit_chain_spec}\"|" "${node_dir}/beacond/config/app.toml"
				# chain-spec-file
				sed "${SED_OPT[@]}" "s|^chain-spec-file = \".*\"|chain-spec-file = \"${apptoml_beacon_kit_chain_spec_file}\"|" "${node_dir}/beacond/config/app.toml"
				# shutdown-timeout
				sed "${SED_OPT[@]}" "s|^shutdown-timeout = \".*\"|shutdown-timeout = \"${apptoml_beacon_kit_shutdown_timeout}\"|" "${node_dir}/beacond/config/app.toml"
				# rpc-dial-url
				sed "${SED_OPT[@]}" "s|^rpc-dial-url = \".*\"|rpc-dial-url = \"http://localhost:${el_authrpc_port}\"|" "${node_dir}/beacond/config/app.toml"
				# rpc-timeout
				sed "${SED_OPT[@]}" "s|^rpc-timeout = \".*\"|rpc-timeout = \"${apptoml_beacon_kit_engine_rpc_timeout}\"|" "${node_dir}/beacond/config/app.toml"
				# rpc-startup-check-interval
				sed "${SED_OPT[@]}" "s|^rpc-startup-check-interval = \".*\"|rpc-startup-check-interval = \"${apptoml_beacon_kit_engine_rpc_startup_check_interval}\"|" "${node_dir}/beacond/config/app.toml"
				# rpc-jwt-refresh-interval
				sed "${SED_OPT[@]}" "s|^rpc-jwt-refresh-interval = \".*\"|rpc-jwt-refresh-interval = \"${apptoml_beacon_kit_engine_rpc_jwt_refresh_interval}\"|" "${node_dir}/beacond/config/app.toml"
				# jwt-secret-path
				sed "${SED_OPT[@]}" "s|^jwt-secret-path = \".*\"|jwt-secret-path = \"${node_dir}/beacond/config/jwt.hex\"|" "${node_dir}/beacond/config/app.toml"
				# [beacon-kit-logger]
				# time-format
				sed "${SED_OPT[@]}" "s|^time-format = \".*\"|time-format = \"${apptoml_beacon_kit_logger_time_format}\"|" "${node_dir}/beacond/config/app.toml"
				# log-level
				sed "${SED_OPT[@]}" "s|^log-level = \".*\"|log-level = \"${apptoml_beacon_kit_logger_log_level}\"|" "${node_dir}/beacond/config/app.toml"
				# log-style
				sed "${SED_OPT[@]}" "s|^log-style = \".*\"|log-style = \"${apptoml_beacon_kit_logger_style}\"|" "${node_dir}/beacond/config/app.toml"
				# [beacon-kit-kzg]
				# trusted-setup-path
				sed "${SED_OPT[@]}" "s|^trusted-setup-path = \".*\"|trusted-setup-path = \"${beranodes_dir}/tmp/kzg-trusted-setup.json\"|" "${node_dir}/beacond/config/app.toml"
				# kzg-implementation
				sed "${SED_OPT[@]}" "s|^implementation = \".*\"|implementation = \"${apptoml_beacon_kit_kzg_implementation}\"|" "${node_dir}/beacond/config/app.toml"
				# [beacon-kit-payload-builder]
				# enabled
				sed "${SED_OPT[@]}" "157s|^enabled = .*|enabled = ${apptoml_beacon_kit_payload_builder_enabled}|" "${node_dir}/beacond/config/app.toml"
				# suggested-fee-recipient
				sed "${SED_OPT[@]}" "s|^suggested-fee-recipient = \".*\"|suggested-fee-recipient = \"${wallet_address}\"|" "${node_dir}/beacond/config/app.toml"
				# payload-timeout
				sed "${SED_OPT[@]}" "s|^payload-timeout = \".*\"|payload-timeout = \"${apptoml_beacon_kit_payload_builder_payload_timeout}\"|" "${node_dir}/beacond/config/app.toml"
				# [beacon-kit.validator]
				# graffiti
				sed "${SED_OPT[@]}" "s|^graffiti = \".*\"|graffiti = \"${moniker}\"|" "${node_dir}/beacond/config/app.toml"
				# availability-window
				sed "${SED_OPT[@]}" "s|^availability-window = \".*\"|availability-window = \"${apptoml_beacon_kit_validator_availability_window}\"|" "${node_dir}/beacond/config/app.toml"
				# [beacon-kit.node-api]
				# enabled
				sed "${SED_OPT[@]}" "180s|^enabled = .*|enabled = \"${apptoml_beacon_kit_node_api_enabled}\"|" "${node_dir}/beacond/config/app.toml"
				# address
				sed "${SED_OPT[@]}" "183s|^address = \".*\"|address = \"127.0.0.1:${beacond_node_port}\"|" "${node_dir}/beacond/config/app.toml"
				# logging
				sed "${SED_OPT[@]}" "s|^logging = \".*\"|logging = \"${apptoml_beacon_kit_node_api_logging}\"|" "${node_dir}/beacond/config/app.toml"
				log_success " app.toml updated"

				# - update config.toml
				echo "--------------------------------"
				echo "config.toml"
				echo "--------------------------------"
				# version
				sed "${SED_OPT[@]}" "11s|^version = \".*\"|version = \"${configtoml_version}\"|" "${node_dir}/beacond/config/config.toml"
				# [base]
				# proxy_app
				sed "${SED_OPT[@]}" "s|^proxy_app = \".*\"|proxy_app = \"tcp://127.0.0.1:${ethproxy_port}\"|" "${node_dir}/beacond/config/config.toml"
				# moniker
				sed "${SED_OPT[@]}" "s|^moniker = \".*\"|moniker = \"${moniker}\"|" "${node_dir}/beacond/config/config.toml"
				# db_backend
				sed "${SED_OPT[@]}" "s|^db_backend = \".*\"|db_backend = \"${configtoml_db_backend}\"|" "${node_dir}/beacond/config/config.toml"
				# db_dir
				sed "${SED_OPT[@]}" "s|^db_dir = \".*\"|db_dir = \"${node_dir}/beacond/data\"|" "${node_dir}/beacond/config/config.toml"
				# log_level
				sed "${SED_OPT[@]}" "s|^log_level = \".*\"|log_level = \"${configtoml_log_level}\"|" "${node_dir}/beacond/config/config.toml"
				# log_format
				sed "${SED_OPT[@]}" "s|^log_format = \".*\"|log_format = \"${configtoml_log_format}\"|" "${node_dir}/beacond/config/config.toml"
				# genesis_file
				sed "${SED_OPT[@]}" "s|^genesis_file = \".*\"|genesis_file = \"${node_dir}/beacond/config/genesis.json\"|" "${node_dir}/beacond/config/config.toml"
				# priv_validator_key_file
				sed "${SED_OPT[@]}" "s|^priv_validator_key_file = \".*\"|priv_validator_key_file = \"${node_dir}/beacond/config/priv_validator_key.json\"|" "${node_dir}/beacond/config/config.toml"
				# priv_validator_state_file
				sed "${SED_OPT[@]}" "s|^priv_validator_state_file = \".*\"|priv_validator_state_file = \"${node_dir}/beacond/data/priv_validator_state.json\"|" "${node_dir}/beacond/config/config.toml"
				# priv_validator_laddr
				sed "${SED_OPT[@]}" "s|^priv_validator_laddr = \".*\"|priv_validator_laddr = \"${configtoml_priv_validator_laddr}\"|" "${node_dir}/beacond/config/config.toml"
				# node_key_file
				sed "${SED_OPT[@]}" "s|^node_key_file = \".*\"|node_key_file = \"${node_dir}/beacond/config/node_key.json\"|" "${node_dir}/beacond/config/config.toml"
				# abci
				sed "${SED_OPT[@]}" "s|^abci = \".*\"|abci = \"${configtoml_abci}\"|" "${node_dir}/beacond/config/config.toml"
				# filter_peers
				sed "${SED_OPT[@]}" "s|^filter_peers = .*|filter_peers = \"${configtoml_filter_peers}\"|" "${node_dir}/beacond/config/config.toml"
				# [rpc]
				# laddr
				sed "${SED_OPT[@]}" "94s|^laddr = \".*\"|laddr = \"tcp://127.0.0.1:${ethrpc_port}\"|" "${node_dir}/beacond/config/config.toml"
				# cors_allowed_origins
				if [ -z "${configtoml_rpc_cors_allowed_origins}" ]; then
					sed "${SED_OPT[@]}" "s|^cors_allowed_origins = \[.*\]|cors_allowed-origins = []|" "${node_dir}/beacond/config/config.toml"
				else
					formatted_cors_allowed_origins="$(format_csv_as_string "${configtoml_rpc_cors_allowed_origins}")"
					sed "${SED_OPT[@]}" "s|^cors_allowed_origins = \[.*\]|cors_allowed-origins = [${formatted_cors_allowed_origins}]|" "${node_dir}/beacond/config/config.toml"
				fi
				# cors_allowed_methods
				if [ -z "${configtoml_rpc_cors_allowed_methods}" ]; then
					sed "${SED_OPT[@]}" "s|^cors_allowed_methods = \[.*\]|cors_allowed_methods = []|" "${node_dir}/beacond/config/config.toml"
				else
					formatted_cors_allowed_methods="$(format_csv_as_string "${configtoml_rpc_cors_allowed_methods}")"
					sed "${SED_OPT[@]}" "s|^cors_allowed_methods = \[.*\]|cors_allowed_methods = [${formatted_cors_allowed_methods}]|" "${node_dir}/beacond/config/config.toml"
				fi
				# cors_allowed_headers
				if [ -z "${configtoml_rpc_cors_allowed_headers}" ]; then
					sed "${SED_OPT[@]}" "s|^cors_allowed_headers = \[.*\]|cors_allowed_headers = []|" "${node_dir}/beacond/config/config.toml"
				else
					formatted_cors_allowed_headers="$(format_csv_as_string "${configtoml_rpc_cors_allowed_headers}")"
					sed "${SED_OPT[@]}" "s|^cors_allowed_headers = \[.*\]|cors_allowed_headers = [${formatted_cors_allowed_headers}]|" "${node_dir}/beacond/config/config.toml"
				fi
				# unsafe
				sed "${SED_OPT[@]}" "s|^unsafe = .*|unsafe = \"${configtoml_rpc_unsafe}\"|" "${node_dir}/beacond/config/config.toml"
				# max_open_connections
				sed "${SED_OPT[@]}" "s|^max_open_connections = .*|max_open_connections = \"${configtoml_rpc_max_open_connections}\"|" "${node_dir}/beacond/config/config.toml"
				# max_subscription_clients
				sed "${SED_OPT[@]}" "s|^max_subscription_clients = .*|max_subscription_clients = \"${configtoml_rpc_max_subscription_clients}\"|" "${node_dir}/beacond/config/config.toml"
				# max_subscriptions_per_client
				sed "${SED_OPT[@]}" "s|^max_subscriptions_per_client = .*|max_subscriptions_per_client = \"${configtoml_rpc_max_subscriptions_per_client}\"|" "${node_dir}/beacond/config/config.toml"
				# experimental-subscription-buffer-size
				sed "${SED_OPT[@]}" "s|^experimental_subscription_buffer_size = .*|experimental_subscription_buffer_size = \"${configtoml_rpc_experimental_subscription_buffer_size}\"|" "${node_dir}/beacond/config/config.toml"
				# experimental_websocket_write_buffer_size
				sed "${SED_OPT[@]}" "s|^experimental_websocket_write_buffer_size = .*|experimental_websocket_write_buffer_size = \"${configtoml_rpc_experimental_websocket_write_buffer_size}\"|" "${node_dir}/beacond/config/config.toml"
				# experimental_close_on_slow_client
				sed "${SED_OPT[@]}" "s|^experimental_close_on_slow_client = .*|experimental_close_on_slow_client = \"${configtoml_rpc_experimental_close_on_slow_client}\"|" "${node_dir}/beacond/config/config.toml"
				# timeout_broadcast_tx_commit
				sed "${SED_OPT[@]}" "s|^timeout_broadcast_tx_commit = \".*\"|timeout_broadcast_tx_commit = \"${configtoml_rpc_timeout_broadcast_tx_commit}\"|" "${node_dir}/beacond/config/config.toml"
				# max_request_batch_size
				sed "${SED_OPT[@]}" "s|^max_request_batch_size = .*|max_request_batch_size = \"${configtoml_rpc_max_request_batch_size}\"|" "${node_dir}/beacond/config/config.toml"
				# max_body_bytes
				sed "${SED_OPT[@]}" "s|^max_body_bytes = .*|max_body_bytes = \"${configtoml_rpc_max_body_bytes}\"|" "${node_dir}/beacond/config/config.toml"
				# max_header_bytes
				sed "${SED_OPT[@]}" "s|^max_header_bytes = .*|max_header_bytes = \"${configtoml_rpc_max_header_bytes}\"|" "${node_dir}/beacond/config/config.toml"
				# tls_cert_file
				sed "${SED_OPT[@]}" "s|^tls_cert_file = \".*\"|tls_cert_file = \"${configtoml_rpc_tls_cert_file}\"|" "${node_dir}/beacond/config/config.toml"
				# tls_key_file
				sed "${SED_OPT[@]}" "s|^tls_key_file = \".*\"|tls_key_file = \"${configtoml_rpc_tls_key_file}\"|" "${node_dir}/beacond/config/config.toml"
				# pprof_laddr
				sed "${SED_OPT[@]}" "s|^pprof_laddr = \".*\"|pprof_laddr = \"${configtoml_rpc_pprof_laddr}\"|" "${node_dir}/beacond/config/config.toml"
				# [grpc]
				# laddr
				sed "${SED_OPT[@]}" "137s|^laddr = \".*\"|laddr = \"${configtoml_grpc_laddr}\"|" "${node_dir}/beacond/config/config.toml"
				# [grpc.version_service]
				# enabled
				sed "${SED_OPT[@]}" "218s|^enabled = .*|enabled = \"${configtoml_grpc_version_service_enabled}\"|" "${node_dir}/beacond/config/config.toml"
				# [grpc.block_service]
				# enabled
				sed "${SED_OPT[@]}" "222s|^enabled = .*|enabled = \"${configtoml_grpc_block_service_enabled}\"|" "${node_dir}/beacond/config/config.toml"
				# [grpc.block_results_service]
				# enabled
				sed "${SED_OPT[@]}" "227s|^enabled = .*|enabled = \"${configtoml_grpc_block_results_service_enabled}\"|" "${node_dir}/beacond/config/config.toml"
				# [grpc.privileged]
				# laddr
				sed "${SED_OPT[@]}" "235s|^laddr = \".*\"|laddr = \"${configtoml_grpc_privileged_laddr}\"|" "${node_dir}/beacond/config/config.toml"
				# [grpc.privileged.pruning_service]
				# enabled
				sed "${SED_OPT[@]}" "248s|^enabled = .*|enabled = \"${configtoml_grpc_privileged_pruning_service_enabled}\"|" "${node_dir}/beacond/config/config.toml"
				# [p2p]
				# laddr
				sed "${SED_OPT[@]}" "256s|^laddr = \".*\"|laddr = \"tcp://0.0.0.0:${ethp2p_port}\"|" "${node_dir}/beacond/config/config.toml"
				# external_address
				sed "${SED_OPT[@]}" "s|^external_address = \".*\"|external_address = \"${configtoml_p2p_external_address}\"|" "${node_dir}/beacond/config/config.toml"

				# Adjust seeds and peers to exclude the current node for connections
				read -a node_seeds < <(array_exclude_element seeds[@] "${seeds[$node_index]}")
				read -a node_p2p_ports < <(array_exclude_element p2p_ports[@] "${p2p_ports[$node_index]}")
				configtoml_p2p_seeds="$(
					out=()
					for i in "${!node_seeds[@]}"; do
						out+=("${node_seeds[$i]}@localhost:${node_p2p_ports[$i]}")
					done
					(
						IFS=,
						echo "${out[*]}"
					)
				)"

				read -a node_peers < <(array_exclude_element peers[@] "${peers[$node_index]}")
				configtoml_p2p_persistent_peers="$(
					out=()
					for i in "${!node_seeds[@]}"; do
						out+=("${node_seeds[$i]}@localhost:${node_p2p_ports[$i]}")
					done
					(
						IFS=,
						echo "${out[*]}"
					)
				)"
				# seeds
				sed "${SED_OPT[@]}" "s|^seeds = \".*\"|seeds = \"${configtoml_p2p_seeds}\"|" "${node_dir}/beacond/config/config.toml"
				# persistent_peers
				sed "${SED_OPT[@]}" "s|^persistent_peers = \".*\"|persistent_peers = \"${configtoml_p2p_persistent_peers}\"|" "${node_dir}/beacond/config/config.toml"
				# addr_book_file
				sed "${SED_OPT[@]}" "s|^addr_book_file = \".*\"|addr_book_file = \"${node_dir}/beacond/config/addrbook.json\"|" "${node_dir}/beacond/config/config.toml"
				# addr_book_strict
				sed "${SED_OPT[@]}" "s|^addr_book_strict = .*|addr_book_strict = \"${configtoml_p2p_addr_book_strict}\"|" "${node_dir}/beacond/config/config.toml"
				# max_num_inbound_peers
				sed "${SED_OPT[@]}" "s|^max_num_inbound_peers = .*|max_num_inbound_peers = \"${configtoml_p2p_max_num_inbound_peers}\"|" "${node_dir}/beacond/config/config.toml"
				# max_num_outbound_peers
				sed "${SED_OPT[@]}" "s|^max_num_outbound_peers = .*|max_num_outbound_peers = \"${configtoml_p2p_max_num_outbound_peers}\"|" "${node_dir}/beacond/config/config.toml"
				# unconditional_peer_ids
				sed "${SED_OPT[@]}" "s|^unconditional_peer_ids = \".*\"|unconditional_peer_ids = \"${configtoml_p2p_unconditional_peer_ids}\"|" "${node_dir}/beacond/config/config.toml"
				# persistent_peers_max_dial_period
				sed "${SED_OPT[@]}" "s|^persistent_peers_max_dial_period = \".*\"|persistent_peers_max_dial_period = \"${configtoml_p2p_persistent_peers_max_dial_period}\"|" "${node_dir}/beacond/config/config.toml"
				# flush_throttle_timeout
				sed "${SED_OPT[@]}" "s|^flush_throttle_timeout = \".*\"|flush_throttle_timeout = \"${configtoml_p2p_flush_throttle_timeout}\"|" "${node_dir}/beacond/config/config.toml"
				# max_packet_msg_payload_size
				sed "${SED_OPT[@]}" "s|^max_packet_msg_payload_size = \".*\"|max_packet_msg_payload_size = \"${configtoml_p2p_max_packet_msg_payload_size}\"|" "${node_dir}/beacond/config/config.toml"
				# send_rate
				sed "${SED_OPT[@]}" "s|^send_rate = .*|send_rate = \"${configtoml_p2p_send_rate}\"|" "${node_dir}/beacond/config/config.toml"
				# recv_rate
				sed "${SED_OPT[@]}" "s|^recv_rate = .*|recv_rate = \"${configtoml_p2p_recv_rate}\"|" "${node_dir}/beacond/config/config.toml"
				# pex
				sed "${SED_OPT[@]}" "s|^pex = .*|pex = \"${configtoml_p2p_pex}\"|" "${node_dir}/beacond/config/config.toml"
				# seed_mode
				sed "${SED_OPT[@]}" "s|^seed_mode = \".*\"|seed_mode = \"${configtoml_p2p_seed_mode}\"|" "${node_dir}/beacond/config/config.toml"
				# private_peer_ids
				sed "${SED_OPT[@]}" "s|^private_peer_ids = \".*\"|private_peer_ids = \"${configtoml_p2p_private_peer_ids}\"|" "${node_dir}/beacond/config/config.toml"
				# allow_duplicate_ip
				sed "${SED_OPT[@]}" "s|^allow_duplicate_ip = .*|allow_duplicate_ip = ${configtoml_p2p_allow_duplicate_ip}|" "${node_dir}/beacond/config/config.toml"
				# handshake_timeout
				sed "${SED_OPT[@]}" "s|^handshake_timeout = \".*\"|handshake_timeout = \"${configtoml_p2p_handshake_timeout}\"|" "${node_dir}/beacond/config/config.toml"
				# dial_timeout
				sed "${SED_OPT[@]}" "s|^dial_timeout = \".*\"|dial_timeout = \"${configtoml_p2p_dial_timeout}\"|" "${node_dir}/beacond/config/config.toml"
				# [mempool]
				# type
				sed "${SED_OPT[@]}" "s|^type = \".*\"|type = \"${configtoml_mempool_type}\"|" "${node_dir}/beacond/config/config.toml"
				# recheck
				sed "${SED_OPT[@]}" "s|^recheck = \".*\"|recheck = \"${configtoml_mempool_recheck}\"|" "${node_dir}/beacond/config/config.toml"
				# recheck_timeout
				sed "${SED_OPT[@]}" "s|^recheck_timeout = \".*\"|recheck_timeout = \"${configtoml_mempool_recheck_timeout}\"|" "${node_dir}/beacond/config/config.toml"
				# broadcast
				sed "${SED_OPT[@]}" "s|^broadcast = \".*\"|broadcast = \"${configtoml_mempool_broadcast}\"|" "${node_dir}/beacond/config/config.toml"
				# wal_dir
				sed "${SED_OPT[@]}" "s|^wal_dir = \".*\"|wal_dir = \"${configtoml_mempool_wal_dir}\"|" "${node_dir}/beacond/config/config.toml"
				# size
				sed "${SED_OPT[@]}" "s|^size = \".*\"|size = \"${configtoml_mempool_size}\"|" "${node_dir}/beacond/config/config.toml"
				# max_tx_bytes
				sed "${SED_OPT[@]}" "s|^max_tx_bytes = \".*\"|max_tx_bytes = \"${configtoml_mempool_max_tx_bytes}\"|" "${node_dir}/beacond/config/config.toml"
				# max_txs_bytes
				sed "${SED_OPT[@]}" "s|^max_txs_bytes = \".*\"|max_txs_bytes = \"${configtoml_mempool_max_txs_bytes}\"|" "${node_dir}/beacond/config/config.toml"
				# cache_size
				sed "${SED_OPT[@]}" "s|^cache_size = \".*\"|cache_size = \"${configtoml_mempool_cache_size}\"|" "${node_dir}/beacond/config/config.toml"
				# keep-invalid-txs-in-cache
				sed "${SED_OPT[@]}" "s|^keep_invalid_txs_in_cache = \".*\"|keep_invalid_txs_in_cache = \"${configtoml_mempool_keep_invalid_txs_in_cache}\"|" "${node_dir}/beacond/config/config.toml"
				# [statesync]
				# enable
				sed "${SED_OPT[@]}" "404s|^enable = .*|enable = ${configtoml_statesync_enable}|" "${node_dir}/beacond/config/config.toml"
				# rpc_servers
				sed "${SED_OPT[@]}" "s|^rpc_servers = \".*\"|rpc_servers = \"${configtoml_statesync_rpc_servers}\"|" "${node_dir}/beacond/config/config.toml"
				# trust_height
				sed "${SED_OPT[@]}" "s|^trust_height = \".*\"|trust_height = \"${configtoml_statesync_trust_height}\"|" "${node_dir}/beacond/config/config.toml"
				# trust_hash
				sed "${SED_OPT[@]}" "s|^trust_hash = \".*\"|trust_hash = \"${configtoml_statesync_trust_hash}\"|" "${node_dir}/beacond/config/config.toml"
				# trust_period
				sed "${SED_OPT[@]}" "s|^trust_period = \".*\"|trust_period = \"${configtoml_statesync_trust_period}\"|" "${node_dir}/beacond/config/config.toml"
				# discovery_time
				sed "${SED_OPT[@]}" "s|^discovery_time = \".*\"|discovery_time = \"${configtoml_statesync_discovery_time}\"|" "${node_dir}/beacond/config/config.toml"
				# temp_dir
				sed "${SED_OPT[@]}" "s|^temp_dir = \".*\"|temp_dir = \"${configtoml_statesync_temp_dir}\"|" "${node_dir}/beacond/config/config.toml"
				# chunk_request_timeout
				sed "${SED_OPT[@]}" "s|^chunk_request_timeout = \".*\"|chunk_request_timeout = \"${configtoml_statesync_chunk_request_timeout}\"|" "${node_dir}/beacond/config/config.toml"
				# chunk_fetchers
				sed "${SED_OPT[@]}" "s|^chunk_fetchers = \".*\"|chunk_fetchers = \"${configtoml_statesync_chunk_fetchers}\"|" "${node_dir}/beacond/config/config.toml"
				# [blocksync]
				# version
				sed "${SED_OPT[@]}" "442s|^version = .*|version = \"${configtoml_blocksync_version}\"|" "${node_dir}/beacond/config/config.toml"
				# [consensus]
				# wal_file
				sed "${SED_OPT[@]}" "s|^wal_file = \".*\"|wal_file = \"${configtoml_consensus_wal_file}\"|" "${node_dir}/beacond/config/config.toml"
				# timeout_propose
				sed "${SED_OPT[@]}" "s|^timeout_propose = \".*\"|timeout_propose = \"${configtoml_consensus_timeout_propose}\"|" "${node_dir}/beacond/config/config.toml"
				# timeout_propose_delta
				sed "${SED_OPT[@]}" "s|^timeout_propose_delta = \".*\"|timeout_propose_delta = \"${configtoml_consensus_timeout_propose_delta}\"|" "${node_dir}/beacond/config/config.toml"
				# timeout_prevote
				sed "${SED_OPT[@]}" "s|^timeout_prevote = \".*\"|timeout_prevote = \"${configtoml_consensus_timeout_prevote}\"|" "${node_dir}/beacond/config/config.toml"
				# timeout_prevote_delta
				sed "${SED_OPT[@]}" "s|^timeout_prevote_delta = \".*\"|timeout_prevote_delta = \"${configtoml_consensus_timeout_prevote_delta}\"|" "${node_dir}/beacond/config/config.toml"
				# timeout_precommit
				sed "${SED_OPT[@]}" "s|^timeout_precommit = \".*\"|timeout_precommit = \"${configtoml_consensus_timeout_precommit}\"|" "${node_dir}/beacond/config/config.toml"
				# timeout_precommit_delta
				sed "${SED_OPT[@]}" "s|^timeout_precommit_delta = \".*\"|timeout_precommit_delta = \"${configtoml_consensus_timeout_precommit_delta}\"|" "${node_dir}/beacond/config/config.toml"
				# timeout_commit
				sed "${SED_OPT[@]}" "s|^timeout_commit = \".*\"|timeout_commit = \"${configtoml_consensus_timeout_commit}\"|" "${node_dir}/beacond/config/config.toml"
				# skip_timeout_commit
				sed "${SED_OPT[@]}" "s|^skip_timeout_commit = \".*\"|skip_timeout_commit = \"${configtoml_consensus_skip_timeout_commit}\"|" "${node_dir}/beacond/config/config.toml"
				# double_sign_check_height
				sed "${SED_OPT[@]}" "s|^double_sign_check_height = \".*\"|double_sign_check_height = \"${configtoml_consensus_double_sign_check_height}\"|" "${node_dir}/beacond/config/config.toml"
				# create_empty_blocks
				sed "${SED_OPT[@]}" "s|^create_empty_blocks = \".*\"|create_empty_blocks = \"${configtoml_consensus_create_empty_blocks}\"|" "${node_dir}/beacond/config/config.toml"
				# create_empty_blocks_interval
				sed "${SED_OPT[@]}" "s|^create_empty_blocks_interval = \".*\"|create_empty_blocks_interval = \"${configtoml_consensus_create_empty_blocks_interval}\"|" "${node_dir}/beacond/config/config.toml"
				# peer_gossip_sleep_duration
				sed "${SED_OPT[@]}" "s|^peer_gossip_sleep_duration = \".*\"|peer_gossip_sleep_duration = \"${configtoml_consensus_peer_gossip_sleep_duration}\"|" "${node_dir}/beacond/config/config.toml"
				# peer_gossip_intraloop_sleep_duration
				sed "${SED_OPT[@]}" "s|^peer_gossip_intraloop_sleep_duration = \".*\"|peer_gossip_intraloop_sleep_duration = \"${configtoml_consensus_peer_gossip_intraloop_sleep_duration}\"|" "${node_dir}/beacond/config/config.toml"
				# peer_query_maj23_sleep_duration
				sed "${SED_OPT[@]}" "s|^peer_query_maj23_sleep_duration = \".*\"|peer_query_maj23_sleep_duration = \"${configtoml_consensus_peer_query_maj23_sleep_duration}\"|" "${node_dir}/beacond/config/config.toml"
				# [storage]
				# discard_abci_responses
				sed "${SED_OPT[@]}" "s|^discard_abci_responses = \".*\"|discard_abci_responses = \"${configtoml_storage_discard_abci_responses}\"|" "${node_dir}/beacond/config/config.toml"
				# experimental_db_key_layout
				sed "${SED_OPT[@]}" "s|^experimental_db_key_layout = \".*\"|experimental_db_key_layout = \"${configtoml_storage_experimental_db_key_layout}\"|" "${node_dir}/beacond/config/config.toml"
				# compact
				sed "${SED_OPT[@]}" "s|^compact = \".*\"|compact = \"${configtoml_storage_compact}\"|" "${node_dir}/beacond/config/config.toml"
				# compaction_interval
				sed "${SED_OPT[@]}" "s|^compaction_interval = \".*\"|compaction_interval = \"${configtoml_storage_compaction_interval}\"|" "${node_dir}/beacond/config/config.toml"
				# [storage.pruning]
				# interval
				sed "${SED_OPT[@]}" "s|^interval = \".*\"|interval = \"${configtoml_storage_pruning_interval}\"|" "${node_dir}/beacond/config/config.toml"
				# [storage.pruning.data_companion]
				# enabled
				sed "${SED_OPT[@]}" '537s|^enabled = .*$|enabled = '"${configtoml_storage_pruning_data_companion_enabled}"'|' "${node_dir}/beacond/config/config.toml"
				# initial_block_retain_height
				sed "${SED_OPT[@]}" "s|^initial_block_retain_height = \".*\"|initial_block_retain_height = \"${configtoml_storage_pruning_data_companion_initial_block_retain_height}\"|" "${node_dir}/beacond/config/config.toml"
				# initial_block_results_retain_height
				sed "${SED_OPT[@]}" "s|^initial_block_results_retain_height = \".*\"|initial_block_results_retain_height = \"${configtoml_storage_pruning_data_companion_initial_block_results_retain_height}\"|" "${node_dir}/beacond/config/config.toml"
				# [tx_index]
				# indexer
				sed "${SED_OPT[@]}" "s|^indexer = \".*\"|indexer = \"${configtoml_tx_index_indexer}\"|" "${node_dir}/beacond/config/config.toml"
				# psql_conn
				sed "${SED_OPT[@]}" "s|^psql_conn = \".*\"|psql_conn = \"${configtoml_tx_index_psql_conn}\"|" "${node_dir}/beacond/config/config.toml"
				# [instrumentation]
				# prometheus
				sed "${SED_OPT[@]}" "s|^prometheus = \".*\"|prometheus = \"${cl_prometheus_port}\"|" "${node_dir}/beacond/config/config.toml"
				# prometheus_listen_addr
				sed "${SED_OPT[@]}" "s|^prometheus_listen_addr = \".*\"|prometheus_listen_addr = \":${cl_prometheus_port}\"|" "${node_dir}/beacond/config/config.toml"
				# max_open_connections
				sed "${SED_OPT[@]}" '588s|^max_open_connections = .*$|max_open_connections = '"${configtoml_instrumentation_max_open_connections}"'|' "${node_dir}/beacond/config/config.toml"
				# namespace
				sed "${SED_OPT[@]}" "s|^namespace = \".*\"|namespace = \"${configtoml_instrumentation_namespace}\"|" "${node_dir}/beacond/config/config.toml"
				log_success " config.toml updated"

				# Init bera-reth node
				cp "${beranodes_dir}${BERANODES_PATH_TMP}/${GENESIS_ETH_NAME_DEFAULT}" "${bera_reth_dir}/${GENESIS_ETH_NAME_DEFAULT}"
				${bin_bera_reth} init \
					--chain="${bera_reth_dir}/${GENESIS_ETH_NAME_DEFAULT}" \
					--datadir="${bera_reth_dir}" >/dev/null 2>&1
				# remove existing discovery-secret
				if [ -f "${bera_reth_dir}/discovery-secret" ]; then
					rm -f "${bera_reth_dir}/discovery-secret"
				fi
				log_success " bera-reth node initialized"
			done

			# Start the nodes and record their pids
			print_header "Starting nodes"
			for ((node_index = 0; node_index < ${nodes_count}; node_index++)); do
				# beacond
				local node_json=$(echo "${nodes}" | jq -r ".[$node_index]")
				local moniker=$(echo "${node_json}" | jq -r '.moniker')
				local node_dir="${beranode_dir}${BERANODES_PATH_NODES}/${role}-${node_index}"
				local beacond_dir="${node_dir}/beacond"
				local bera_reth_dir="${node_dir}/bera-reth"
				local jwt=$(echo "${node_json}" | jq -r '.beacond_config.jwt')
				${bin_beacond} start --home "${beacond_dir}" &>"${beranode_dir}${BERANODES_PATH_LOGS}/${moniker}-beacond.log" &
				echo "$!" >"${beranode_dir}${BERANODES_PATH_RUNS}/${moniker}-beacond.pid"
				log_success " Beacond node started"

				# bera-reth
				local el_authrpc_port=$(echo "${node_json}" | jq -r '.el_authrpc_port')
				local el_ws_port=$(echo "${node_json}" | jq -r '.el_ws_port')
				local el_eth_port=$(echo "${node_json}" | jq -r '.el_eth_port')
				local el_ethrpc_port=$(echo "${node_json}" | jq -r '.el_ethrpc_port')
				local el_prometheus_port=$(echo "${node_json}" | jq -r '.el_prometheus_port')
				local cl_prometheus_port=$(echo "${node_json}" | jq -r '.cl_prometheus_port')
				local beacond_node_port=$(echo "${node_json}" | jq -r '.beacond_node_port')
				local configtoml_grpc_laddr=$(echo "${node_json}" | jq -r '.configtoml_grpc_laddr')
				local configtoml_grpc_privileged_laddr=$(echo "${node_json}" | jq -r '.configtoml_grpc_privileged_laddr')

				read -a bootnodes < <(array_exclude_element berareth_bootnodes[@] "${berareth_bootnodes[$node_index]}")
				read -a trusted_peers < <(array_exclude_element berareth_trusted_peers[@] "${berareth_trusted_peers[$node_index]}")
				read -a el_eth_ports < <(array_exclude_element berareth_el_eth_port[@] "${berareth_el_eth_port[$node_index]}")

				configtoml_berareth_bootnodes="$(
					out=()
					for i in "${!bootnodes[@]}"; do
						out+=("enode://${bootnodes[$i]}@localhost:${el_eth_ports[$i]}")
					done
					(
						IFS=,
						echo "${out[*]}"
					)
				)"
				configtoml_berareth_trusted_peers="$(
					out=()
					for i in "${!trusted_peers[@]}"; do
						out+=("enode://${trusted_peers[$i]}@localhost:${el_eth_ports[$i]}")
					done
					(
						IFS=,
						echo "${out[*]}"
					)
				)"

				private_key=$(echo "${node_json}" | jq -r '.berareth_config.private_key')
				public_key=$(echo "${node_json}" | jq -r '.berareth_config.public_key')

				# Add discovery secret - enode bera-reth id
				echo -n "${private_key}" >"${bera_reth_dir}/discovery-secret"
				${bin_bera_reth} node \
					$( [[ -z "${configtoml_berareth_bootnodes}" ]] || echo --bootnodes="${configtoml_berareth_bootnodes}" ) \
					$( [[ -z "${configtoml_berareth_trusted_peers}" ]] || echo --trusted-peers="${configtoml_berareth_trusted_peers}" ) \
					--authrpc.addr="127.0.0.1" \
					--authrpc.port="${el_authrpc_port}" \
					--authrpc.jwtsecret="${beacond_dir}/config/jwt.hex" \
					--chain="${bera_reth_dir}/eth-genesis.json" \
					--datadir="${bera_reth_dir}" \
					--discovery.port="${el_eth_port}" \
					--engine.persistence-threshold=0 \
					--engine.memory-block-buffer-target=0 \
					--http \
					--nat="extip:127.0.0.1" \
					--http.api="admin,debug,eth,net,trace,txpool,web3,rpc,reth,ots,flashbots,miner,mev" \
					--http.addr=0.0.0.0 \
					--http.port="${el_ethrpc_port}" \
					--http.corsdomain="*" \
					--port="${el_eth_port}" \
					--ws \
					--ws.addr=0.0.0.0 \
					--ws.port="${el_ws_port}" \
					--ws.origins="*" \
					&>"${beranode_dir}${BERANODES_PATH_LOGS}/${moniker}-bera-reth.log" &
				local pid=$!
				echo "${pid}" >"${beranode_dir}${BERANODES_PATH_RUNS}/${moniker}-bera-reth.pid"
				log_success " Bera-reth node started"
			done
		else
			# Unsupported mode (e.g., "distributed", "cloud")
			log_error "Unsupported mode: ${mode}"
			return 1
		fi
	fi
}


# =============================================================================
# stop
# Source: commands/stop.sh
# =============================================================================

show_stop_help() {
	cat <<EOF
Usage: beranode stop [OPTIONS]

Stop Berachain nodes already running based on their PIDs in the runs directory.

Options:
  --beranodes-dir <path>    Specify the beranodes directory path
                            (default: \$PWD/beranodes)
  --help|-h                 Display this help message

Examples:
  beranode stop
  beranode stop --beranodes-dir /custom/path
  beranode stop --help

EOF
}

# =============================================================================
# [SECTION 2] Main Stop Command Function
# =============================================================================
# Primary entry point for the stop command. Orchestrates the entire node
# stop process from configuration parsing to node stop.
# =============================================================================

cmd_stop() {
	# Enable debug output if DEBUG_MODE is set
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: cmd_stop" >&2

	# Parse command line arguments
	local beranodes_dir="${BERANODES_PATH_DEFAULT}"

	while [[ $# -gt 0 ]]; do
		case $1 in
		--beranodes-dir)
			if [[ -z "$2" ]] || [[ "$2" == --* ]]; then
				log_warn "--beranodes-dir not provided or missing argument. Defaulting to: $beranodes_dir"
				shift
			else
				beranodes_dir="$2"
				shift 2
			fi
			;;
		--help | -h)
			show_stop_help
			return 0
			;;
		*)
			log_error "Unknown option: $1"
			show_stop_help
			return 1
			;;
		esac
	done

	# Find runs directory
	local runs_dir="${beranodes_dir}${BERANODES_PATH_RUNS}"
	if [[ ! -d "${runs_dir}" ]]; then
		log_error "Runs directory not found: ${runs_dir}"
		return 1
	fi

	# Find all PID files in the runs directory
	local pid_files=($(find "${runs_dir}" -name "*.pid"))
	if [[ ${#pid_files[@]} -eq 0 ]]; then
		log_info "No PID files found in runs directory: ${runs_dir}"
		return 0
	fi

	# Stop each node
	log_info "Stopping nodes in..."
	log_info "- Runs directory: ${runs_dir}"
	for pid_file in "${pid_files[@]}"; do
		local pid=$(cat "${pid_file}")
		local file=$(basename "${pid_file}")
		log_info "${file} / PID: ${pid}"
		if kill "${pid}" 2>/dev/null; then
			:
		else
			log_warn "Failed to stop process with PID: ${pid} (may not exist)"
		fi
		# Clean up by removing the PID file
		rm -f "${pid_file}"
	done

	log_info "Killing any remaining processes..."
	pkill -f beacond || true
	pkill -f bera-reth || true

	log_success "Stopped ${#pid_files[@]} nodes"
}


# =============================================================================
# validate
# Source: commands/validate.sh
# =============================================================================

: "${DEBUG_MODE:=false}"

# Note: When built into the beranode executable, logging.sh and validation.sh
# are already included by build.sh. These source statements are only needed
# when running this script standalone for testing purposes.
if [[ ! $(type -t log_info) == "function" ]]; then
	SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
	source "${SCRIPT_DIR}/../lib/logging.sh"
	source "${SCRIPT_DIR}/../lib/validation.sh"
fi

# Main validation command
cmd_validate() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: cmd_validate" >&2

	# Check for help flag
	if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
		cmd_validate_help
		return 0
	fi

	local config_path="${1:-}"

	# Default config path if not provided
	if [[ -z "$config_path" ]]; then
		config_path="./beranodes/beranodes.config.json"
	fi

	# Convert to absolute path if relative
	if [[ ! "$config_path" = /* ]]; then
		config_path="$(pwd)/$config_path"
	fi

	log_info "Starting validation of beranodes configuration"
	log_info "Config file: $config_path"
	echo ""

	# Run validation
	if validate_beranodes_config "$config_path"; then
		echo ""
		log_success "Configuration validation completed successfully!"
		return 0
	else
		echo ""
		log_error "Configuration validation failed. Please fix the errors above."
		return 1
	fi
}

# Show help
cmd_validate_help() {
	cat <<EOF
Validate beranodes configuration file

USAGE:
    beranode validate [config_path]

ARGUMENTS:
    config_path    Path to beranodes.config.json file (optional)
                   Default: ./beranodes/beranodes.config.json

DESCRIPTION:
    Validates all fields in the beranodes.config.json file using regex patterns
    to ensure correct formatting. Checks include:

    - String formats (monikers, network names, etc.)
    - Boolean values (true/false)
    - Integer numbers and port ranges
    - Hex addresses (0x + 40 characters)
    - Private keys (0x + 64 characters)
    - JWT tokens
    - URLs and paths
    - Time durations (e.g., 5m0s, 10s)
    - Node and deposit object structures

EXAMPLES:
    # Validate default config
    beranode validate

    # Validate specific config file
    beranode validate ./custom/path/beranodes.config.json

    # Validate config in different directory
    beranode validate /absolute/path/to/beranodes.config.json

EXIT STATUS:
    0    All validations passed
    1    Validation errors found

EOF
}

# Note: Standalone execution code removed to prevent conflicts when built into beranode.
# When running standalone for testing, call cmd_validate directly:
#   source this_file.sh && cmd_validate "$@"


# =============================================================================
# dispatcher
# Source: core/dispatcher.sh
# =============================================================================

show_help() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: show_help" >&2

	cat <<EOF
beranode - CLI for managing Berachain nodes

USAGE:
    beranode <command> [options]

COMMANDS:
    init        Initialize a new Berachain node configuration
    start       Start the Berachain node
    validate    Validate beranodes configuration file
    help        Show this help message
    version     Show version information

OPTIONS:
    -h, --help     Show this help message
    -v, --version  Show version information

EXAMPLES:
    beranode init --network devnet --validators 1
    beranode start
    beranode validate

For more information, visit: https://github.com/berachain/beranode-cli2
EOF
}

# -----------------------------------------------------------------------------
# Function: show_version
# Description: Displays the current version of beranode CLI
# Arguments: None
# Returns: None (outputs version string to stdout)
# Variables Used:
#   - BERANODE_VERSION: Defined in src/lib/constants.sh
# -----------------------------------------------------------------------------
show_version() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: show_version" >&2

	echo "beranode v${BERANODE_VERSION}"
}

# -----------------------------------------------------------------------------
# Function: show_interactive_menu
# Description: Displays a welcome message when beranode is called without
#              any arguments, guiding users to use --help for more info.
# Arguments: None
# Returns: None (outputs to stdout)
# -----------------------------------------------------------------------------
show_interactive_menu() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: show_interactive_menu" >&2

	cat <<EOF

Welcome to beranode CLI!

Please run 'beranode --help' to see available commands.

EOF
}

# =============================================================================
# [2] MAIN DISPATCHER FUNCTION
# =============================================================================

# -----------------------------------------------------------------------------
# Function: main
# Description: Primary entry point for command routing. Parses the first
#              argument as a command and delegates to the appropriate handler.
#              If no arguments are provided, displays the interactive menu.
# Arguments:
#   $@ - All command-line arguments passed to beranode
# Returns:
#   0 - Success
#   1 - Unknown command or error
# Flow:
#   1. Check if arguments exist, show menu if none
#   2. Extract command from first argument
#   3. Route to appropriate handler via case statement
#   4. Pass remaining arguments to the handler function
# -----------------------------------------------------------------------------
main() {
	[[ "$DEBUG_MODE" == "true" ]] && echo "[DEBUG] Function: main" >&2

	# [2.1] Handle no-argument invocation
	if [[ $# -eq 0 ]]; then
		show_interactive_menu
		exit 0
	fi

	# [2.2] Extract command and shift arguments
	local command="$1"
	shift

	# =========================================================================
	# [3] COMMAND ROUTING TABLE
	# =========================================================================
	# This case statement maps user commands to their handler functions.
	# Each active command calls a cmd_* function defined in src/commands/
	# =========================================================================

	case "$command" in
	# ---------------------------------------------------------------------
	# [3.1] Help and Version Flags
	# Handles: -h, --help, help, -v, --version, version
	# Added in: v0.6.0 with enhanced --help support
	# ---------------------------------------------------------------------
	-h | --help | help)
		show_help
		;;
	-v | --version | version)
		show_version
		;;

	# ---------------------------------------------------------------------
	# [3.2] Active Commands
	# These commands are currently implemented and functional
	# ---------------------------------------------------------------------
	init)
		# Initialize new node configuration
		# Handler: cmd_init() in src/commands/init.sh
		# Added: v0.1.x, Enhanced: v0.6.0 with --help flag
		cmd_init "$@"
		;;
	start)
		# Start the Berachain node
		# Handler: cmd_start() in src/commands/start.sh
		# Added: v0.1.x, Enhanced: v0.6.0 with --help flag
		cmd_start "$@"
		;;
	stop)
		# Stop the Berachain node
		# Handler: cmd_stop() in src/commands/stop.sh
		# Added: v0.6.0 with --help flag
		cmd_stop "$@"
		;;
	validate)
		# Validate beranodes configuration file
		# Handler: cmd_validate() in src/commands/validate.sh
		# Added: v0.6.0 with regex-based validation
		cmd_validate "$@"
		;;

	# ---------------------------------------------------------------------
	# [3.3] Placeholder Commands (Future Implementation)
	# These commands are reserved for future versions
	# ---------------------------------------------------------------------
	# stop)
	#     # Stop running node gracefully
	#     stop_node "$@"
	#     ;;
	# restart)
	#     # Restart node (stop + start)
	#     restart_node "$@"
	#     ;;
	# status)
	#     # Display current node status
	#     show_node_status
	#     ;;
	# logs)
	#     # Display and follow node logs
	#     show_logs "$@"
	#     ;;
	# config)
	#     # Display current configuration
	#     show_config
	#     ;;
	# update)
	#     # Update node to latest version
	#     update_node
	#     ;;

	# ---------------------------------------------------------------------
	# [3.4] Unknown Command Handler
	# Displays error message and help text for unrecognized commands
	# ---------------------------------------------------------------------
	*)
		log_error "Unknown command: ${command}"
		echo ""
		show_help
		exit 1
		;;
	esac
}


# =============================================================================
# Entry Point - Main script execution
# =============================================================================

main "$@"
